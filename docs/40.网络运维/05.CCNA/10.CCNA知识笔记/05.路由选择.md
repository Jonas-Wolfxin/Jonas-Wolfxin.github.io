---
title: 路由选择
date: 2022-07-13 12:26:14
permalink: /pages/149f35/
categories:
  - 网络运维
  - CCNA
  - CCNA知识笔记
tags:
  - 
---
# 路由选择

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220705160854522.png" alt="image-20220705160854522" style="zoom:67%;" />

## 概念

>   路由选择是指将分组从一个设备通过互联网络发往位于不同网络上的另一个设备的路径选择。路由器不关注网络中的主机，而只关注互联起来的网络以及通往各个网络的最佳路径。

>   ==路由表==存储在RAM中, 包含以下信息
>
>   -   直连网络(directly connected):
>
>   -   远程网络连接:
>
>   -   网络的详细信息:

>   ==建立路由表的四种途径==:
>
>   -   `直连路由`: 直接连接在路由器接口上的网络。
>
>   -   `静态路由`: 手工在路由器上建立路由表条目
>
>       -   优点:
>           -   不增加路由器CPU的开销，也就是说使用静态路由不需要动态路由那样占用CPU资源计算;
>           -   不增加路由器间的带宽占用，也就是说在WAN 链接的使用中可以节省更多的费用;
>           -   提高了安全性，因为管理员可以有选择地配置路由，使之只通过某些特定的网络;
>       -   缺点:
>           -   管理员必须真正地了解整个互联网络以及每台路由器间的连接方式，以便实现对这些路由的正确配置;
>           -   管理员必须在所有路由器上(手工地)添加或者更新到此网络的路由, 
>           -   对于大型网络使用静态路由选择基本上是不可行的，因为配置静态路由选择会产生巨大的工作量。
>
>   -   `默认路由 S*`: 对于在路由选择表没有对应表项的网络，都将通过默认路由转发出去。
>
>       -   使用默认路由容易创建路由环路，因此使用时要特别小心!
>
>   -   `动态路由`: 路由器根据协议发现网络并更新路由表。
>
>       -   分类:
>
>           -   `IGP (Interior Gateway Proωcol，内部网关协议)`: 用于在同一个AS (Auωnomous System ，自治系统)中的路由器间交换路由选择信息。而AS 是一个位于共同管理域下的网络集合，其基本原理是将所有需要共享相同的路由选择表信息的路由器置于同一个AS中。
>
>               -   `距离矢量协议`: 距离矢量协议通过判断距离确定当前到达远程网络的最佳路径。比如`RIP协议`采用跳数作为度量值
>               -   `链路状态协议`: 
>                   -   路由器将分别创建3个彼此独立的表。其中的一个表用来跟踪直接相连接的邻居，一个用来确定整个互联网络的拓扑结构，而另一个则用作路由选择表。
>                   -   链路状态路由器要比任一使用距离矢量路由选择协议的路由器了解更多地关于互联网络的情况。
>                   -   OSPF 是一个完完全全的链路状态路由选择协议。链路状态协议将包含有自身链接状态的更新发送到网络中其他所有直接连接的路由器上，然后再由这些路由器传播到它们的相邻设备。
>               -   `混合型`: 混合型协议将同时具有距离矢量和链路状态两种协议的特性，例如EIGRP 。
>
>           -   `EGP (Exterior Gateway Protocol ，外部网关协议)`: 
>
>               用于AS 之间的通信。EGP的一个典型示例是BGP (Border Gateway Protocol ，边界网关协议);



>   一条路由信息的组成:
>
>   ```sh
>   R1>show ip route
>   Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
>          D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area 
>          N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
>          E1 - OSPF external type 1, E2 - OSPF external type 2
>          i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
>          ia - IS-IS inter area, * - candidate default, U - per-user static route
>          o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP
>          a - application route
>          + - replicated route, % - next hop override
>   
>   Gateway of last resort is not set
>   
>         10.0.0.0/8 is variably subnetted, 2 subnets, 2 masks
>   C        10.0.0.0/8 is directly connected, Ethernet0/1
>   L        10.1.1.1/32 is directly connected, Ethernet0/1
>         192.168.1.0/24 is variably subnetted, 2 subnets, 2 masks
>   C        192.168.1.0/24 is directly connected, Ethernet0/0
>   L        192.168.1.1/32 is directly connected, Ethernet0/0
>   ```
>
>   
>
>   -   `类型`: 
>
>       L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
>       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area 
>       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
>       E1 - OSPF external type 1, E2 - OSPF external type 2
>       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
>       ia - IS-IS inter area, * - candidate default, U - per-user static route
>       o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP
>       a - application route
>
>       - replicated route, % - next hop override
>
>   -   目标`IP地址或者网段地址/子网掩码`: 192.168.0.1/24
>
>   -   `接口或者与自己相连的设备的接口IP地址`: Ethernet0/0 或者 ip地址

## 静态路由 static

### 设置静态路由语法:

>   ```sh
>   ip route [destination_network] [mask] [next-hop_address or exitinterface] [administrative_distance] [permanent] 
>   ```
>
>   -   `ip route` 用于创建静态路由的命令;
>   -   `destination_network` 要放置到路由选择表中的网络号。
>   -   `mask` 在此网络上使用的子网掩码。
>   -   `next-hop_address` 下一跳路由器上与本路由器直接相连的接口的IP地址
>   -   `exitinterface`  本路由器的出接口;
>   -   `administrative_distance` 默认情况下，静态路由的管理距离为1 (甚至可以是0，前提是使用输出接口(exitinterface) 替代下一跳地址)
>   -   `permanent` 如果接口被关闭或者路由器不能与下一跳路由器通信，默认情况下这一路由将
>       会被从路由选择表中自动删除。选择permanent 选项，将导致在任意情况下都保留这一路由
>       选择表项在路由选择表中。

取消该条路由: 

-   思科: `no ip route 192.168.2.0 255.255.255.0 e0/1 12.1.1.2`; 
-   华为 是 `undo ip route ...`

```sh
R1#sh ip route 
Codes: L - local, C - connected, S - static, .....

Gateway of last resort is not set

      12.0.0.0/8 is variably subnetted, 2 subnets, 2 masks
C        12.1.1.0/30 is directly connected, Ethernet0/0
L        12.1.1.1/32 is directly connected, Ethernet0/0

R1(config)#ip route 192.168.2.0 255.255.255.0 12.1.1.2  # 设置静态路由

R1#sh ip route 
Codes: L - local, C - connected, S - static, .....

Gateway of last resort is not set

      12.0.0.0/8 is variably subnetted, 2 subnets, 2 masks
C        12.1.1.0/30 is directly connected, Ethernet0/0
L        12.1.1.1/32 is directly connected, Ethernet0/0
S     192.168.2.0/24 [1/0] via 12.1.1.2

```

### loopback 路由

```sh
# loopback 路由
R3(config)#interface loopback ?
  <0-2147483647>  Loopback interface number
  
R1(config)#interface loopback 0
R1(config-if)#
*Jun 18 08:53:05.949: %LINEPROTO-5-UPDOWN: Line protocol on Interface Loopback0, changed state to up
R1(config-if)#ip address 192.168.10.1 255.255.255.0
R1#show ip interface brief 
Interface                  IP-Address      OK? Method Status                Protocol
Ethernet0/0                12.1.1.1        YES NVRAM  up                    up     
Ethernet0/1                unassigned      YES unset  administratively down down   
Ethernet0/2                unassigned      YES NVRAM  administratively down down   
Ethernet0/3                unassigned      YES NVRAM  administratively down down   
Loopback0                  192.168.10.1    YES manual up                    up 
```



### 静态路由的汇总

![image-20220618124808186](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220618124808186.png)

![image-20220618124855027](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220618124855027.png)

## 默认路由

>   -   静态路由的特殊形式, 一般设置在`存根路由器`或者`连接WAN的路由器`上;
>
>       -   存根路由器(stub router)。存根表示这个示例中的网络只有通往所有其他网络的一条路径。 
>
>   -   对于在路由选择表没有对应表项的网络，都将通过默认路由转发出去。
>
>   -   使用默认路由容易创建路由环路，因此使用时要特别小心!
>
>       ```sh
>       R3(config)#ip route 0.0.0.0 0.0.0.0 10.1.5.1
>       R3(config)#ip classless
>       R3(config)#do show ip route
>       ```
>
>       >   -   几乎所有思科路由器都是有类路由器，也就是说，路由器的每个接口预设使用默认的子网掩码。当路由器接收到一个目的子网不在路由选择表中的分组时，默认将丢弃这个分组。因此，如果在配置中使用了默认路由选择，这里就必须使用`ip classless`命令;
>       >   -   IOS 版本为12.4，默认情况下这个ip classless 命令处于启用状态，因此在配置中可以不执行这个命令。在配置默认路由选择时，如果没有执行过这个命令，并且对路由器进行过子网划分，那么就需要添加这个命令。

>   如果你在互联网络中已经配置好了最终网关，命令`ip default-network ip地址`会是另一个非常有用的命令. 
>
>   一个需要使用最终网关配置语句的示例:
>
>   ![image-20220707124138160](https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicGo/img/202207071305104.png)
>
>   ```sh
>   Gateway(config)#ip default-network network
>   ```
>
>   当对路由器配置了一个IGP (Interior Gateway Protocol ，内部网关协议)时，如RIP ，命令`ip
>   default-network`将会在边界路由器上通告这个默认网络的信息。这样，此互联网络中的其他路由器
>   将接收这个信息，并自动地设置这个路由为默认路由。

## 动态路由

>   -   动态路由: 通过网络发现和共享路由表信息, 路由器可以自动发现网络, 并更新和维护路由表
>
>   -   分类:
>
>       -   `IGP (Interior Gateway Proωcol，内部网关协议)`: 用于在同一个AS (Auωnomous System ，自治系统)中的路由器间交换路由选择信息。而AS 是一个位于共同管理域下的网络集合，其基本原理是将所有需要共享相同的路由选择表信息的路由器置于同一个AS中。
>
>           -   `距离矢量协议`: 距离矢量协议通过判断距离确定当前到达远程网络的最佳路径。比如`RIP协议`采用跳数作为度量值
>           -   `链路状态协议`: 
>               -   路由器将分别创建3个彼此独立的表。其中的一个表用来跟踪直接相连接的邻居，一个用来确定整个互联网络的拓扑结构，而另一个则用作路由选择表。
>               -   链路状态路由器要比任一使用距离矢量路由选择协议的路由器了解更多地关于互联网络的情况。
>               -   OSPF 是一个完完全全的链路状态路由选择协议。链路状态协议将包含有自身链接状态的更新发送到网络中其他所有直接连接的路由器上，然后再由这些路由器传播到它们的相邻设备。
>           -   `混合型`: 混合型协议将同时具有距离矢量和链路状态两种协议的特性，例如EIGRP 。
>
>       -   `EGP (Exterior Gateway Protocol ，外部网关协议)`: 
>
>           用于AS 之间的通信。EGP的一个典型示例是BGP (Border Gateway Protocol ，边界网关协议);

### 动态路由协议的分类

![image-20220619113100182](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220619113100182.png)

>   CCNA阶段只学习**内部网关协议(Internal Gateway Protocols)**:
>
>   -   ==距离矢量协议==:
>       -   RIPv1协议(基本淘汰)
>       -   RIPv2
>       -   IGRP协议: 思科设备上专用的(基本淘汰)
>   -   ==链路状态协议==:
>       -   OSPF协议
>       -   IS-IS协议: 运营商使用的
>   -   ==混合型==: 
>       -   EIGRP

#### 距离矢量(distance-vector)路由协议

>   距离矢量路由选择算法发送`完整的路由选择表`到相邻的路由器，然后相邻的路由器将接收到的路由表项与它们原有的路由选择表合井，以完善自己的路由选择表。由于路由器接收到的更新信息只是相邻路由器对于远程网络的认知，路由器并不会自己查证这些内容，所以这一方式又被戏称为`传闻路由`。
>
>   ##### 应用场景:
>
>   -   网络结构简单扁平, 不需要特殊的分层设计;
>   -   管理员没有足够的知识来配置链路状态协议和故障排查;
>   -   特定类型的网络拓扑结构, 如集中星型(Hub-and-Spoke)网络;
>   -   无需关注网络最差情况下的收敛时间;



#### 链路状态协议

>   ##### 应用场景:
>
>   -   网络进行了分层设计, 大型网络通常如此;
>   -   管理员对于网络中采用的链路状态路由协议非常熟悉;
>   -   网络对于收敛速度的要求极高;

>   ##### 链路状态(Link-State):
>
>   -   链路状态路由协议向全网扩散链路状态信息;
>   -   链路状态路由协议当网络结构发生变化立即发送更新信息;
>   -   链路状态路由协议只发送需要更新的信息

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620190709680.png" alt="image-20220620190709680" style="zoom:40%;" />



### 路由选择协议基础

#### ==管理距离(Administrative Distance)==

>   -   作用: 用于衡量路由协议的可靠性, 各种路由协议都有默认的AD, 有助于确定路由路径;
>
>   -   每一种路由协议按可靠性从高到低，依次分配一个信任等级，这个信任等级就叫管理距离。管理距离是一个从0~255的整数值，0是最可信赖的，而255意味着这个路由不会被使用。
>
>   ![image-20220618190415618](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220618190415618.png)
>
>   ==AD 和 metric的查看==:
>
>   ```sh
>   Router> show ip route
>   S        10.10.10.0/24 [1/0] via 10.12.12.1   # 1 代表AD; 0 代表 metric
>   S        10.10.20.0/24 [1/0] via 10.23.23.2
>   C        10.12.12.0/30 is directly connected, Ethernet0/1
>   L        10.12.12.2/32 is directly connected, Ethernet0/1
>   ```
>
>   
>
>   ==查看指定路由条目的信息==: 
>
>   ```shell
>   Router> show ip route 10.10.10.0
>   Routing entry for 10.10.10.0/24
>   Known via "static", distance 1, metric 0
>   Routing Descriptor Blocks:
>     * 10.12.12.1
>         Route metric is 0, traffic share count is 1
>   ```
>

#### ==度量值 metrics:==

>   使用同一种路由协议时用来表征到达远程网络的路由开销的值,用于确定最佳的路由路径;
>
>   IP路由协议中使用的度量如下:
>
>   -   带宽: EIGRP
>-   开销: OSPF, IS-IS
>   -   延迟: EIGRP
>   -   跳数: RIP
>   -   负载: EIGRP
>   -   可靠性: EIGRP

>   **相同路由协议内部到达同一目的网段有多条路径时，比较最佳路径的参数**; **管理距离AD是不同路由协议之间比较选路的参数**。

>   -   如果路由器接收了两个对`同一远程网络`的更新信息，路由器会首先检查更新信息的AD。如果被通告的路由中有一个的AD 值比另一个的低，那么这个拥有较低AD 值的路由将被放置在路由选择表中。
>   -   如果被通告的到`同一网络的两个路由具有相同的AD`，那么路由选择协议的度量值(如跳计数或链路的带宽)将被用作判断到达远程网络最住路径的依据。带有最低度量值的、被通告的路由将被放置在路由选择表中。
>   -   如果两个被通告的`同一网络的路由拥有相同的AD以及相同的度量值`，这时该路由选择协议将会在这一远程网络中使用负载均衡(也就是将所发送的分组分配到每个链路上)。



### RIP

>   ==RIP(Routing Information Protocols, 路由信息协议)==只使用跳计数判定到达某个网络的最佳路径。如果RIP发现对于同一个远程网络存在多个具有相同跳计数的链路，则RIP 将自动执行循环负载均衡。RIP可以对多达6个(默认为4个)等价链路实现负载均衡。
>
>   ==特点==:
>
>   -   适用于小型同类网络; 
>
>   -   基于UDP协议, 端口号 520; 组播方式，其地址为224.0.0.9
>
>   -   AD 为 120;
>
>   -   以hop值作为度量值, 超过 15跳, 则认为不可达;
>
>   -   默认负载均衡数量为4, 可以通过 `maximum-paths` 修改, 最大值为6;
>
>       -   然而，当两条通往同一远程网络的链路具有不同的带宽，但是有相同的跳计数时，这种类型的路由度量将会导致问题。
>
>           ![image-20220707140106135](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207071401265.png)
>
>   -   每隔30s进行周期性路由表更新;
>
>   -   RIP协议存在一个问题，就是它的会聚时间较长。
>
>   ==RIP协议依赖三种定时器维护其数据库==:
>
>   -   `路由更新定时器` 用于设置路由更新的时间间隔(通常为30 秒)，此间隔是路由器发送自己路由选择表的完整副本给所有相邻路由器的时间间隔。
>   -   `路由失效定时器`: 用于路由器在最终认定一个路由为失效路由之前需要等待的时长(通常为180 秒)。如果在这个认定等待时间里，路由器没有得到任何关于特定路由的更新消息，路由器将认定这个路由失效。出现这一情况时，路由器会给所有相邻设备发送关于此路由已经无效的更新。
>   -   `保持失效定时器`: 用于设置路由选择信息被抑制的时长。当路由器接收到某个表示路由不可达的更新分组时，它将进入保持失效状态。这→保持状态将一直持续到路由器接收到具有更好度量的更新分组，或初始路由恢复正常，或者此保持失效定时器期满。默认情况下，该定时器的取值为180秒。
>   -   `路由刷新定时器`: 用于设置将某个路由认定为无效路由起至将它从路由选择表中删除的时间间隔(通常为240 秒)。在将此路由从路由选择表中删除之前，路由器会将此路由即将消亡的消息通告给相邻设备。路由失效定时器的取值一定要小于路由刷新定时器的值。这就为路由器在更新本地路由选择表时先将这一无效路由通告给相邻设备保留了足够的时间。

#### RIPv1 & RIPv2:

>   ![image-20220707150025172](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207071500296.png)
>
>   RIPv1(已淘汰): 
>
>   -   仅支持`有类的路由选择`(即网络中的所有设备都必须使用相同的子网掩码), 不支持 VLSM;
>-   以广播的形式发送更新报文;
>   -   不支持认证;
>   
>   RIPv2:
>
>   -   支持无类路由协议, 支持VLSM;
>-   以组播的形式发送更新报文;
>   -   支持明文和MD5的认证
>   
>   >   我想给出一句忠告:在网络配置中，不管是哪个版本的RIP，我都不推荐使用。由于RIP是一个开放的标准，它可以用于任意品牌的路由器。但是需要注意的是OSPF(将在第9章中讨论)也是一个开放的标准，所以在相同的情况下你同样可以选择OSPF。

#### RIP执行过程:

>   1.   Cold Start: 在配置好接口的IP地址后, `直连路由`会首先加入到路由表中;
>
>        ![image-20220618191729508](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220618191729508.png)
>
>   2.   Initial Exchange: 相邻的路由器进行首次路由表的信息交换(hop值要加1)
>
>        ![image-20220618192403739](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220618192403739.png)
>
>   3.   相邻的路由器再次进行路由表的信息交换, 直到路由表是完备的, 即收敛完成;
>
>        ![image-20220619105753060](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220619105753060.png)

#### 路由环路:

>   -   距离矢量路由选择协议会在所有激活的接口上定期广播路由更新，以此跟踪互联网络中的任何改变。广播内容包括整个路由选择表。这一方案是可行的，只是需要占用一定的CPU 处理资源和链路带宽。
>
>   -   但是，当某个网络瘫痪时， 真正的问题就有可能会出现，特别是距离矢量路由选择协议的慢会聚，最终会导致不一致的路由选择表和路由环路。
>
>   -   导致路由环路的原因可能是每台路由器不能同时或近乎同时地更新路由选择表。
>
>       ![image-20220707140855766](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207071408901.png)
>
>       ![image-20220707140911017](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207071409109.png)
>
>   
>
>   -   路由环路的概念: 指数据包在一系列路由器之间构成闭环的路由路径, 而无法到达目的网络的一种现象
>   -   ==路由环路的恶劣影响==:
>       -   环路内的路由器占用链路带宽来反复收发流量;
>       -   路由器的CPU因不断循环数据包而不堪重负;
>       -   影响到网络收敛;
>       -   路由更新可能会丢失或无法得到及时的处理;
>   -   ==消除路由环路的机制==:
>       1.   `定义最大跳数值`, 防止计数至无穷大; 比如RIP的hop值最大为15
>       2.   `抑制计时器`: 一条路由信息无效之后，一段时间内这条路由都处于抑制状态，即在一定时间内不再接收关于同一目的地址的路由更新。大概过程是如果一个路由器从邻居路由器收到一条更新，提示以前可达的网络现在不可达了，或有一个更大跳数的路由，则路由器标识该路由为不可达并启动一个抑制计时器，如果在定时器到时之前收到该路由又可达的更新，或者新度量值比之前的度量值更好，则路由器标识这个路由可达并删除定时器。路由器从一个网段上得知一条路径失效，然后，立即在另一个网段上得知这个路由有效。这个有效的信息往往是不正确的，抑制计时避免了这个问题，而且，当一条链路频繁起停时，抑制计时减少了路由的浮动，增加了网络的稳定性。
>       3.   `水平分割`: 这是一个在距离矢量网络中为了减少错误路由信息和路由选择开销的强制传送规则，其具体做法是禁止向学习到该路由条目的接口回传路由选择信息(即传送方向不能与信息接收方向一致)。
>       4.   `路由中毒`: 避免因路由表更新不一致而导致的问题
>            -   某路由条目失效时，会立刻向网络中所有节点发送某条路由的路由更新，这条路由更新中该路由的跳数为16或者不可达。 当相邻的路由器收到该中毒路由, 就可以通过其度量值为无穷大明白该路由是无效的。距离矢量路由协议使用路由中毒来告诉其他路由器，某条路由已经失效无法传送数据到目的地址，不要将该路由加入其他路由器的路由表。`中毒反转`: 收到路由中毒消息的路由器，不遵守水平分割原则而是将中毒的路由消息转发给所有的相邻路由器，也包括发送中毒信息的源路由器，确认通告相邻路由器这条路由信息己失效了。主要目的是达到快速收敛的目的。
>       5.   `触发更新`: 当路由表发生变化时，更新报文立即广播给相邻的所有路由器，而不是等待30秒的更新周期。同样，当一个路由器刚启动RIP时，它广播请求报文。收到此广播的相邻路由器立即应答一个更新报文，而不必等到下一个更新周期。这样，网络拓扑的变化会最快地在网络上传播开，减少了路由循环产生的可能性。

#### 配置RIP:

```sh
Corp(config)#router rip
Corp(config-router)#version 2   # 默认的版本号介于 1和2之间, 发送为1, 接收为1或2;
Corp(config-router)#network 各接口的网段地址 或者直接 0.0.0.0
Corp(config-router)#no auto-summary

Corp(config-router)#passive-interface e0/0   # 限制RIP更新从指定接口向 LAN 和WAN 中扩散, 这个命令将阻止向外传播RIP 更新，但它并不阻止 对RIP更新的接收。
```

###### 其他错误排查命令:

```sh
sh run | s r r  # 查看Rip协议的配置
show running-config | section router rip

sh ip rip database

clear ip route *    # 清除直连路由以外所有的路由协议

show ip route    # 显示路由表
show ip protocols  # 可以显示在路由器上己配置的路由选择协议
show ip interface brief

debug ip rip  # 命令debug ip rip 可以将路由器上正在发送和接收的路由更新显示到控制台会话中。如果到路由器的连接是通过远程登录建立的，则我们需要使用 terminal monitor 命令接收 debug命令的输出。
在下
undebug all  # 关闭所有的debug进程
```

#### 在RIPv2的基础上配置默认路由, 并通告LAN内其他路由器

![image-20220707155007144](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207071550253.png)

---

### EIGRP 协议

>   https://www.bilibili.com/video/BV1V94y1U7Sr?spm_id_from=333.337.search-card.all.click&vd_source=119094ee4687100c40882d3b8b8ff3e1

>   Enhanced Interior Gateway Routing Protocol 即 增强型内部网关路由协议。
>
>   -   EIGRP结合了`链路状态`和`距离矢量`==混合型==路由选择协议的Cisco专用协议，
>
>       -   EIGRP 不会像OSPF那样发送链路状态数据包，相反，它所发迭的是传统的距离矢量更新，在此更新中包含有网络信息以及从发出通告的路由器达到这些网络的开销。
>       -   EIGPR 也拥有链路状态的特性，它会在启动时同步相邻路由器上的路由表，并在每次拓扑结构发生改变时发送特定的更新数据;
>
>       >   这使EIGRP 非常适用于特大型的网络应用。EIGRP的最大跳计数为255(其默认设置为100)。不要为这样的描述而困惑. EIGRP 不会像RIP那样使用跳计数作为度量; 对于EIGRP来说，跳计数只是用来限定EIGRP路由更新数据包在被抛弃之前可以经过的路由器个数。同样，这个数值也是限定AS的大小的，而与如何计算度量无关。
>
>   -   采用==弥散修正算法（DUAL）==来实现[快速收敛](https://baike.baidu.com/item/快速收敛/6202142)，可以不发送定期的路由更新[信息](https://baike.baidu.com/item/信息/111163)以减少[带宽](https://baike.baidu.com/item/带宽/266879)的占用.
>
>   -   是一个无类(它的路由更新中包含了子网掩码)、增强的距离矢量协议，协议中也使用了`自治系统`的概念来描述相邻路由器的集合，处于自治系统中的路由器使用相同的路由选择协议并共享相同的路由选择信息。
>
>       >   EIGRP 在它的路由更新中包含了子网掩码，因为它被认为是无类的协议。正如我们现在所知道的，对子网掩码信息进行通告，将使我们可以在设计网络时使用VLSM (Variable Length Subnet Mask,可变长子网掩码)及人工汇总!
>
>   ###### 特点:
>
>   -   高级的距离矢量路由协议: 具有距离矢量性和链路状态协议特征;
>   -   通过使用PDM (Protocol-DependentModule， 协议相关模块）可以为多种网络层协议提供路由支持，这些网络层协议可以是IP、IPX 、AppleTalk 以及现在使用的IPv6. (很显然我们不会再使用IPX和AppleTalk了，但是EIGRP仍对它们提供了支持。
>   -   基于弥散更新算法(DUAL) 的快速收敛和最佳路径选择, 100%无环路;
>   -   Designed to be used within a single autonomous system;
>   -   无类的路由协议(与RIPv2 和OSPF 一样); 支持VLSM和CIDR, 和不连续子网;
>   -   路由条目不过期, 拥有备份路由;
>   -   高效的邻居发现, 触发式更新; 组播方式, 地址为 224.0.0.10
>   -   较低的路由更新开销: EIGRP 只在启动时同步整个路由选择数据库，之后只在有变化时传送变动的部分，从而维持路由选择数据库的连贯性。
>   -   配置简单
>   -   基于`可靠传输协议(RTP)` 的通信;

#### 邻居发现

>   在EIGRP路由器彼此进行路由交换(毗邻关系Adjecency)之前，它们必须首先成为邻居(neighbor)。要建立邻居关系，必须满足3个条件:
>
>   -   收发到Hello包; (用于发现以及维持邻居关系)
>
>   -   实现AS号的匹配; 分处于不同自治系统(AS) 中的EIGRP路由器，不会成为邻居, 更不会自动共享路由选择信息;
>
>       >   在这里，唯一需要关注的就是，在不同AS之间可以进行的手工设定再发布信息。
>
>   -   相同的度量(K值)。

#### 支持大型网络

>   EIGRP具有许多的强大功能，这使它非常适用于大型的网络:
>
>   -   在单个路由器上支持多个AS;
>
>       -   EIGRP 使用自治系统号来区别可共享路由信息的路由器集合。路由信息只可以在拥有相同自治系统号的路由器间共享。
>
>       >   -   内部EIGRP路由的管理距离(AD) 是90 ，这些路由产生于同一个自治系统。
>       >
>       >   -   外部EIGRP路由的AD是170 ，这并不是一个很高的级别。这些出现在EIGRP路由表内的路由通常是由人工再发布的，它们所描述的网络位于EIGRP自治系统外部。
>       >   -   来自于另一个EIGRP自治系统，或者另一种路由选择协议(如OSPF)，当在EIGRP内部再发布时，这些路由都被称为外部路由。
>
>   -   支持VLSM和汇总, 支持不连续子网;
>
>       >   ###### 什么是不连续网络?
>       >
>       >   是将一个有类网络的两个或更多的子网通过另一个有类网络连接在一起的互连网络。
>       >
>       >   -   不连续网络在RIPv1 或思科 IGRP 下是不能正常工作的，认识到这一点很重要。
>       >
>       >   -   并且，不连续网络在默认配置的 RIPv2 或 EIGRP 应用中也是不工作的，但在OSPF的默认配置中可以工作，这是因为OSPF不像EIGRP一样能进行自动汇总。
>       >
>       >   
>       >
>       >   如下: 子网172.16.10.0 和172.16.20.0 通过 10.3.1.0 网络连接在了一起。默认情况下，出于路由通告的需求，每个路由器都会将这个网络视为是172.16.0.0 的有类网络。
>       >
>       >   ![image-20220707171320564](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207071713700.png)
>
>   -   路由发现和维护。

#### DUAL算法的一些术语:

>   Diffusing Update Algorithm, 用于计算最佳无环路径和备用路径
>
>   ==特点==:
>
>   -   无环拓扑
>   -   随时的备用路径
>   -   快速收敛: DUAL为EIGRP提供的路由会聚时间有可能是所有协议中最快的。
>   -   支持VLSM;
>   -   低带宽利用率(通过限定带宽实现)
>
>   ==DUAL算法中的几个术语:==
>
>   -   `可行距离(Feasible Distance)`: 本路由器到达目标网络的开销Cost; 这个具有最低FD的路由被认为是最佳路由，也只有它会出现在路由选择表中。
>   -   `通告距离(Advertised Distance)`: 当前路由器的下一跳路由器到达目标网络的开销Cost, 这是一个由邻居报告的到达远程网络的度量;
>   -   `后继路由器(Successor)`: 到达目的网络的最优(FD最小)的下一跳路由器
>   -   `可行后继路由器(Feasible Successor)`: A backup route if the successor fails. The FS must have a AD that is less than the Successor FD.
>   -   `可行性条件(Feasible Condition):` **AD < FD~min~** , In order for the route to be a feasible successor, its advertised distance must be less than the feasible distance of the successor route.

#### EIGRP的三张表:

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620123920975.png" alt="image-20220620123920975" style="zoom:37%;" />

>   -   邻居关系表通常又称为邻居表，记录已建立好邻居关系的路由器的相关信息。
>   -   拓扑表保存着来自每个邻居的有关互联网络中各个路由描述的路由通告。
>
>   -   路由表保存当前正在使用的用于路由判断的路由。对于每个由EIGRP支持的协议所产生的;
>
>   每个表，这里都保存有一个独立的副本，这些协议可以是IPv4 或IPv6 。

>   -   由于`继任者路由`具有到达远程网络的最佳路径，它是要被放在路由选择表中的。然而，拓扑表拥有到达每个网络的链路，因此，继任者路由存放于拓扑表和路由选择表。
>   -   每个到达远程网络的次级路由都被认为是`可行的继任者`，这些路由只能在拓扑表中找到，并且在主路由出现问题时它们被用于备份路由。

#### EIGRP的数据包:

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620124143638.png" alt="image-20220620124143638" style="zoom:50%;" />

EIGRP 的 hello报文 是通过 RTP 协议发送的, 而不是 TCP或者 UDP;

#### EIGRP的metric:

>   <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207071722269.png" alt="image-20220702193350733" style="zoom:80%;" />
>
>   与许多其他的只使用单一要素来比较并选择最佳可用路径的胁议不同，EIGRP 使用了一个由4个要素组成的度量，即所谓的合成度量:
>
>   -   带宽 Bandwidth
>   -   延迟 Delay
>   -   可靠性 Reliability
>   -   负载 Loading
>   -   MTU
>
>   默认情况下， EIGRP 只使用带宽和线路的延迟来判定到达远程网络的最佳路径。有时思科喜欢称它们为`路径带宽值`和`线路延迟累积值`。
>
>   另外，值得注意的是，还有第5个元素，最大传输单元(MTU) 尺寸。这个元素在EIGRP的度量计算中从没有被用到过，但是在一些与EIGRP 相关的命令中，它是一个必需的参数，特别是那些涉及再发布的命令。MTU元素的值表示去往目的网络过程中所遇到的最小MTU值。

>   -   以上参数绑定于接口, 可通过 `show interfaces e0/0` 查看;
>-   也可以在接口模式下设置其他值, 只会参与 metrics 的计算, 不会产生实际的效果
>   
>   ```shell
>   Router(config-if)#bandwidth ?
>    <1-10000000>   Bandwidth in kilobits
>    inherit        Specify how bandwidth is inherited
>    qos-reference  Reference bandwidth for QOS test
>    receive        Specify receive-side bandwidth
>   
>   Router(config-if)#delay ?   
>    <1-16777215>  Throughput delay (tens of microseconds)
>   
>   ```
>

#### 最大路径数和跳计数

>   -   默认情况下， EIGRP 默认支持4条链路的等代价的负载均衡(RIP也可以做到)。然而，通过使用下列命令，可以使EIGRP 实际用于实现负载均衡的链路(平衡或不平衡的)数量达到16:
>
>       ```sh
>       Rl(config)#router eigrp 10
>       Rl(config-router)#maximum-paths ?
>       <1-16> Number of paths
>       ```
>
>   -   此外， EIGRP 默认的最大跳计数值为100，但它可以被设置到255 。通常不需要修改这个值，但是如果需要，可以这样做:
>
>       ```sh
>       Rl(config)#router eigrp 10
>       Rl(config-router)#metric maximum-hops ?
>       <1-255> Hop count
>       ```
>
>       >   注意，尽管在路径度量计算中不使用跳计数，但路由器仍会使用这个最大跳计数来限制AS的范围。



#### 配置:

>   ###### Requirements match?
>
>   -   Autonomous-System ID
>   -   K-values
>   -   in the same Autonomous System
>   -   Authentication(optional)

```sh
Router(config)#router eigrp AS编号   # Autonomous-System, 相邻的路由器必须使用同一个编号的自治系统; 在这里AS 号的具体数值是什么不重要, 这个数值可以取1 到65536 中的任何一个。
Router(config-router)##network 网段地址  # 记住，与使用RIP相同，这里使用的是有类的网络地址, 即掩码中所有的子网和主机位都为0
Router(config-router)#no auto-summary  # 用于配置不连续子网, 防止其自动聚合

Router(config-router)#passive-interface serial 0/1  # 禁止此接口发送或接收Hello数据包

show running-config | section r e

show ip eigrp neighbors  # 查看当前路由器的 neighbors 表
show ip eigrp topology   # 查看当前路由器的 拓扑表
show ip eigrp traffic    # 查看路由的流量
show ip route eigrp    # 查看EIGRP协议的路由表
show ip protocols    # 查看当前路由器上的路由协议
```

>   ###### 命令passive-interface 的影响取决于命令执行时所涉及的路由选择协议。
>
>   -   例如，某个接口上运行的是RIP ，此 passive-interface 命令将禁止路由更新的发送，但允许对路由是新的接收。因而，带有被动接口的RIP路由器仍然可以从其他路由器的通告中认识网络。
>   -   这与EIGRP 是不同的，在EIGRP 中一个被动的接口既不可以发送史新也不可以接收支新。

>   ###### 不连续子网需要配置禁止自动聚合:
>
>   If our internetwork had an actual discontiguous network, ==RIPv2 and EIGRP== would not have worked at all until we used the command `no auto-summary`.

```sh
# debug 的使用
debug eigrp packet   # Shows Hello packets sent/received between adjacent routers
debug eigrp neighbors  # 可以检查IP地址和重传间隔，以及已建立起邻接关系的邻居队列数。
debug ip eigrp route
debug ip eigrp summary
show ip eigrp events   # Shows EIGRP changes and updates as they occur on your network
```

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207080944449.png" alt="image-20220708094418290" style="zoom:80%;" />



>   ```sh
>   Corp#sh ip eigrp topology
>   IP-EIGRP Topology Table for AS 10
>   Codes: P - Passive , A - Active , U - Update , Q - Query , R - Reply , r - Reply status
>   
>   P 10.1.1.0/24 , 1 successors , FD is 25625600
>   	via Connected , Vlan1
>   P 10.1.5.0/24 , 1 successors , FD is 28160
>   	via Connected , FastEther咽netO/O
>   P 10.1.4.0/24 , 1 successors , FD.is 20512000
>   	via Connected , SerialO/1/0
>   P 10.1.3.0/24 , 1 successors , FD is 76809984
>   	via Connected , SerialO/0/1
>   P 10.1.2.0/24 , 1 successors , FD is 2169856
>   	via Connected , SerialO/O/O
>   P 192.168.10.0/24 , 1 successors , FD is 2172416
>   	via 10.1.2.2 (2172416/28160) , SerialO/O/O
>   	via 10.1.3.2 (76828160/28160) , SerialO/0/1
>   P 192.168.20.0/24 , 1 successors , FD is 2172416
>   	via 10.1.2.2 (2172416/28160) , SerialO/O/O
>   	via 10.1.3.2 (76828160/28160) , SerialO/0/1
>   P 192.168.30.0/24 , 1 successors , FD is 20514560
>   	via 10.1.4.2 (20514560/28160) , SerialO/1/0
>   ```
>
>   
>
>   -   注意在每个路由的前面都有一个字母P-Passive, 这表明次路由处于被动状态(可用状态);
>   -   如果某个路由是 Active 状态, 则表明当前的路由器已经失去了通往这个网络的路径, 并且正在搜索可替代的路径;
>   -   每个路由条目还给出了它指向远程网络的FD, 以及需要经过的下一跳邻居;
>   -   每个路由条目的圆括号内包含了两个数值, 其一是FD, 另外一个是AD;\
>   -   可以注意到 路由条目 192.168.10.0/24 和 192.168.20.0/24 的下面都连接这两条链路, 并且FD都不一样, 这表明这些网络的路径存在着一个 Successor 和 Feasible Successor;



>   ```sh
>   Corp#show ip protocols
>   Routing Protocol is "eigrp 10"
>       Outgoing update filter list for all interfaces is not set
>       Incoming update filter list for all interfaces is not set
>       Default networks flagged in outgoing updates
>       Default networks accepted from incoming updates
>       EIGRP metric weight K1=1 , K2=0 , K3=1 , K4=0 , K5=0
>       EIGRP maximum hopcount 100
>       EIGRP maximum metric variance 1
>   Redistributing: eigrp 10
>       Automatic network summarization is in effect
>       Automatic address summarization:
>       Maximum path: 4
>       Routing for Networks:
>       	10.0.0.0
>       Routing Information Sources:
>           Gateway      Distance  	Last Update
>           10. 1. 5.2   90   		40
>           10. 1. 3.2   90 		6867
>           10. 1. 2.2   90   		6916
>           10. 1.4.2    90  		8722
>       Distance: internal 90 external 170
>   ```
>
>   -   从show ip protocols 命令的输出中，可以了解到AS 号和被称为"k"的度量加权值，默认情
>       况下它使用线路的带宽和延迟来进行计算。
>   -   还给出了用于约束路由更新数据包传输的最大跳计数(默认为100 )，以及方差的取值，在这里为1，也就是说只允许等代价的负载均衡。而最大路径数4表明允许在4个等价的路径上实现负载均衡，也是默认的取值。

#### 负载均衡

##### 等开销的负载均衡

>   EIGRP will load-balance across both links automatically when they are **of equal variance (equal cost)**, but EIGRP can load-balance across unequal-cost links as well if we use the `variance` command. The variance metric is set to 1 by default, meaning that only equal-cost links will load-balance.
>   You can change the variance anywhere up to 128. Changing a variance value enables EIGRP to install multiple, loop-free routes with unequal cost in a local routing table.

负载均衡的示例: 

![image-20220708100023499](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207081000652.png)

```sh
R1#sh ip route
10.0.0.0/24 is subnetted , 5 subnets
    D 10.1.1.0 [90/27769856] via 10.1.3.1, 00:21:30 , SerialO/0/1
    			[90/27769856] via 10.1.2.1, 00:21:30 , SerialO/O/O
    C 10.1.2.0 is directly connected , SerialO/O/O
    C 10.1.3.0 is directly connected , SerialO/0/1
    D 10.1.4.0 [90/21024000] via 10.1.3.1, 00:21:30 , SerialO/0/1
    			[90/21024000] via 10.1.2.1, 00:21:30 , SerialO/O/O
    D 10.1.5.0 [90/2172416] via 10.1.3.1, 00:~1:30 ， SerialO/0/1
    			[90/2172416] via 10.1.2.1 , 00:21:30 , SerialO/O/O
172.16.0.0/24 is subnetted , 1 subnets
    D 172.16.10.0 [90/2172416] via 10.1 圄3.1 ， 00:21:29 , SerialO/0/1
                    [90/2172416] via 10.1.2.1 , 00:21:29 , SerialO/O/O
C 192.168.10.0/24 is directly connected , FastEthernetO/O
C 192.168.20.0/24 is directly connected , FastEthernetO/1
D 192.168.30.0/24 [90/21026560] via 10.1.2.1, 00:21:30 , SerialO/O/O
				[90/21026560] via 10.1.3.1, 00:21:30 , SerialO/0/1
D 192.168.40.0/24 [90/21026560] via 10.1.2.1, 00:21:30 , SerialO/O/O
				[90/21026560] via 10.1.3.1 , 00:21:30 , SerialO/0/1
R1#
```

>   默认情况下, EIGRP 将在s0/0/0 和 s0/0/1 上实现负载均衡, 因为他们具有相同的Metrics.

##### 不等开销的负载均衡:

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620161856906.png" alt="image-20220620161856906" style="zoom:40%;" />

#### 配置EIGRP汇总路由



<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207081430091.png" alt="image-20220708143002935" style="zoom:80%;" />

>   图9-10 中给出了6个网络，其中4个的块尺寸为4(WAN 链路)， 2个块尺寸为8(LAN 连接)。这样的网络设计正好可以放到一个尺寸为32的块中。它所使用的网络地址为192.168.10.64，其块大小为32 ，其掩码是255.255.255.224 ，如你所知，224可以提供32的块尺寸。
>
>   -   On the core (backbone connection) router, for EIGRP we’ll place the summary route on Ethernet0, which will advertise our summary route out to the backbone network (10.10.10.0 network). This will stop all six of our networks from being advertised individually and instead advertise them as one route to the other routers in the internetwork. However, it is imperative(必要的, 极其重要的) that no other router outside our contiguous network have a subnet in this advertised block behind it, which would allow it to advertise conflicting routes.
>
>   -   Here is the complete configuration of EIGRP on the core router:
>
>       ```sh
>       Core#config t
>       Core(config)#router eigrp 10
>       Core(config-router)#network 192.168.10.0
>       Core(config-router)#network 10.0.0.0
>       Core(config-router)#no auto-summary
>       Core(config-router)#interface ethernet 0
>       Core(config-if)#ip summary-address eigrp 10 192.168.10.64 255.255.255.224
>       ```
>
>       >   -   由于EIGRP在有类边界上会自动汇总，因此必须要使用`no auto-summary`命令。
>       >   -   This summary route tells EIGRP to find all networks in the 192.168.10.64 network with a block size of 32 and advertise them as one route out interface E0.



---

### OSPF协议

>   -   开放式最短路径优先（Open Shortest Path First，OSPF）, 是用于网际协议（IP）网络的[链路状态路由协议](https://baike.baidu.com/item/链路状态路由协议/1219386)。适用于[IPv4](https://baike.baidu.com/item/IPv4/422599)的OSPFv2协议定义于RFC 2328，适用于[IPv6](https://baike.baidu.com/item/IPv6/172297)的OSPFv3定义于RFC 5340。
>
>   -   是广泛使用的一种动态路由协议，它属于链路状态路由协议，具有路由变化收敛速度快、无路由环路、支持变长子网掩码（VLSM）和汇总、等优点。在网络中使用[OSPF协议](https://baike.baidu.com/item/OSPF协议/421662)后，大部分路由将由OSPF协议自行计算和生成，无须网络管理员人工配置，当网络拓扑发生变化时，协议可以自动计算、更正路由，极大地方便了网络管理。但如果使用时不结合具体网络应用环境，不做好细致的规划，OSPF协议的使用效果会大打折扣，甚至引发故障。
>
>   -   OSPF协议可以让每个路由器负责发现、维护与邻居的关系，并将已知的邻居列表和链路状态更新LSU(Link State Update)报文描述，通过可靠的泛洪与自治系统AS(Autonomous System)内的其他路由器周期性交互，学习到整个自治系统的[网络拓扑结构](https://baike.baidu.com/item/网络拓扑结构/4136060); 并通过自治系统边界的路由器注入其他AS的路由信息，从而得到整个Internet的路由信息。每隔一个特定时间或当链路状态发生变化时，重新生成LSA，路由器通过泛洪机制将新LSA通告出去，以便实现路由的实时更新。
>
>   -   功能和特点:
>
>       -   开放的标准, 允许多厂商的设备集成;
>
>       -   该协议使用`Dijkstra 算法`，在单一自治系统（AS）内部工作。
>
>           -   首先OSPF要构建一个最短路径树, 然后使用最佳路径的计算结果来组建路由选择表;
>           -   OSPF 的会聚也很快，虽然它可能没有EIGRP 快，并且它也支持对相同目标的等价多路径路由。
>
>       -   使用AS自治系统并支持自治系统内进行层次区域划分;
>
>           >   将OSPF创建为层次结构的原因如下:
>           >
>           >   -   减少路由选择的开销;
>           >   -   加速会聚;
>           >   -   将网络的不稳定性限制在单一的网络区域内。
>
>       -   最小化的路由选择的更新流量;
>
>       -   支持动态的网络扩展;
>
>       -   支持VLSM和CIDR;
>
>       -   拥有无限的跳计数;
>
>       -   与EIGRP一样, 也支持IPv4和IPv6协议;
>
>   -   AD: 110
>
>   -   OSPF 在单一区域内通过 最短路径优先(SPF)算法 计算到达目的地的最短路径, 路由器使用最短路径树来将OSPF路由插入到路由表中
>
>       -   链路(Link): 路由器的接口
>
>       -   状态(State): 描述接口及其与邻居路由器之间的关系
>
>       -   Cost: 每个路由器都把自己的接口当做根, 去构造一棵树(这棵树中只包含了路由器所在区域内的网络), 并且给与累计成本来计算到达目的地的最短路径
>
>           <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620191328842.png" alt="image-20220620191328842" style="zoom:39%;" />

>   ##### OSPF的报文类型:
>
>   -   Hello: 发现, 建立并维护OSPF邻居关系;
>   -   DBD: 链路状态数据库描述信息(描述LSDB中的LSA头部信息);
>   -   LSR: 链路状态请求, 向OSPF邻居请求链路状态信息
>   -   LSU: 链路状态更新;
>   -   LSAck: 对LSU中的LSA进行确认;

#### OSPF的术语

>   -   `Link` A link is a network or router interface assigned to any given network. When an interface is added to the OSPF process, it’s considered by OSPF to be a link. This link, or interface, will have state information associated with it (up or down) as well as one or more IP addresses.
>
>   -   `Router ID` The Router ID (RID) is an IP address used to identify the router. Cisco chooses the Router ID by using the highest IP address of all configured loopback interfaces. If no loopback interfaces are configured with addresses, OSPF will choose the highest IP address of all active physical interfaces.
>
>   -   `Neighbor` Neighbors are two or more routers that have an interface on a common network, such as two routers connected on a point-to-point serial link.
>
>   -   `Adjacency` An adjacency is a relationship between two OSPF routers that permits the direct exchange of route updates. OSPF is really picky
>       about sharing routing information—unlike EIGRP, which directly shares routes with all of its neighbors. Instead, OSPF directly shares routes only with neighbors that have also established adjacencies. And not all neighbors will become adjacent—this depends upon both the type of network and the configuration of the routers.
>
>   -   `Hello protocol` The OSPF Hello protocol provides dynamic neighbor discovery and maintains neighbor relationships. Hello packets and Link State Advertisements (LSAs) build and maintain the topological database. Hello packets are addressed to multicast address 224.0.0.5.
>
>   -   `Neighborship database` The neighborship database is a list of all OSPF routers for which Hello packets have been seen. A variety of details, including the Router ID and state, are maintained on each router in the neighborship database.
>
>   -   `Topological database` The topological database contains information from all of the Link State Advertisement packets that have been received for an area. The router uses the information from the topology database as input into the Dijkstra algorithm that computes the shortest path to every network.
>
>   -   `Link State Advertisement` A Link State Advertisement (LSA) is an OSPF data packet containing link-state and routing information that’s shared among OSPF routers. There are different types of LSA packets, and I’ll go into these shortly. An OSPF router will exchange LSA packets only with routers to which it has established adjacencies. ==LSA packets are used to update and maintain the topological database.==
>
>   -   `Designated router` A designated router (DR) is elected whenever OSPF routers are connected to the same multi-access network. Cisco likes to call these “broadcast” networks, but really, they are networks that have multiple recipients(接收者). Try not to confuse multi-access with multipoint, which can be easy to do sometimes.
>
>   -   `Backup designated router` A backup designated router (BDR) is a *hot standby* for the DR on multi-access links (remember that Cisco sometimes likes to call these “broadcast” networks). The BDR receives all routing updates from OSPF adjacent routers but doesn’t flood LSA updates.
>
>   -   `OSPF areas` A n OSPF area is a grouping of contiguous networks and routers. All routers in the same area share a common Area ID. Because a router can be a member of more than one area at a time, the Area ID is associated with specific interfaces on the router. This would allow some interfaces to belong to area 1 while the remaining interfaces can belong to area 0. All of the routers within the same area have the same topology table. When configuring OSPF, you’ve got to remember that there must be an area 0 and that this is typically considered the backbone area. Areas also play a role in establishing a hierarchical network organization—something that really enhances the scalability of OSPF!
>
>   -   `Broadcast (multi-access)` Broadcast (multi-access) networks such as Ethernet allow multiple devices to connect to (or access) the same network as well as provide a broadcast ability in which a single packet is delivered to all nodes on the network. In OSPF, a DR and a BDR must be elected for each broadcast multi-access network.
>
>   -   `Non-broadcast` multi-access Non-broadcast multi-access (NBMA) networks are types such as Frame Relay, X.25, and Asynchronous Transfer Mode (ATM). These networks **allow for multi-access but have no broadcast ability like Ethernet**. So, NBMA networks require special OSPF configuration to function properly and neighbor relationships must be defined.
>
>       >   DR and BDR are elected on broadcast and non-broadcast multi-access networks. Elections are covered in detail later in this chapter.
>
>   -   `Point-to-point` Point-to-point refers to a type of network topology consisting of a *direct connection between two routers that provides a single communication path*. The point-to-point connection can be physical, as in a serial cable directly connecting two routers, or it can be logical, as in two routers that are thousands of miles apart yet connected by a circuit in a Frame Relay network. In either case, ==this type of configuration eliminates the need for DRs or BDRs but neighbors are discovered automatically.==
>
>   -   `Point-to-multipoint` Point-to-multipoint refers to a type of network topology consisting of **a series of connections between a single interface on one router and multiple destination routers**. All of the interfaces on all of the routers sharing the point-to-multipoint connection belong to the same network. As with ==point-to-point, DRs or BDRs are not needed.== 

#### OSPF的区域概念:

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207081101777.png" alt="image-20220708110120640" style="zoom:80%;" />

>   这是一个典型的OSPF简易设计。注意，这里一部分路由器是如何连接到主干网上的:
>
>   -   这个主干网被称为 区域0或者主干区域(area 0, or the backbone area);
>   -   OSPF 必须要有一个区域0，而且所有其他区域都需要连接到这个区域。(Areas that do not connect directly to area 0 can be connected by using virtual links, which are beyond the scope of this book.)
>   -   那些同一自治系统内部的将其他区域连接到主干区域的路由器, 称为 Area Border Router (ABR). 当然, 这些路由器上至少要有一个接口是必须在区域0中的。
>   -   OSPF 运行在某个自治系统内部，但是通过路由器也可以将多个自治系统连接起来。用于连接AS的路由器被称为Autonomous System Boundary Router (ASBR).。

#### OSPF的三张表:

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620202258962.png" alt="image-20220620202258962" style="zoom:40%;" />

#### OSPF的基本运行步骤:

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620202409172.png" alt="image-20220620202409172" style="zoom:40%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620211633205.png" alt="image-20220620211633205" style="zoom:43%;" />

>   ==两台路由器建立 adjacency 关系所要匹配一致的参数==:
>
>   1.   `Area-ID`;
>   2.   `Hello and Dead Interval`;
>
>        >   -   Hello间隔用于设定发送两个Hello 数据包之间的移计数。
>        >   -   而dead间隔是指路由器发出的Hello 数据包没有被邻居看到，因而宣称此OSPF 路由器右机所经过的秒数。
>        >   -   OSPF 要求，两个邻居间设置的这些时间间隔必须是完全相同的。如果这些间隔中的任何一个不相同，则此网络分段上的路由器将不能成为邻居。可以使用show ip ospf interface 命令来查看这些定时器。
>   3.   `Authentication password`;
>   4.   Stub Area Flag;

>   ==OSPF的八种状态机==:
>
>   1.   Down: 刚启动 OSPF 进程, 还未收到任何 hello 包;
>   2.   Attempt: 特殊网络环境, 不能发送组播, 需要单独发送单播, 例如帧中继, 会有此状态;
>   3.   Init: 只是一方收到另一方的 hello 包, 但双方没有完成hello交换;
>   4.   Two-way: 已完成 hello 交换, 已经在 hello 中看到自己是对方的邻居;
>   5.   Exstart: 在交换DBD之前, 要在此状态协商主从关系; 从机要先发送 DBD给 主机;
>   6.   Exchange: 完成协商后, 开始交换 DBD
>   7.   Loading: 收到LSR后, 确定对方缺少哪条LSA, 再发送LSU告知对方自己的详细LSA信息;
>   8.   Full: 完成 OSPF 链路数据库的收敛

#### OSPF 网络类型

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620215601211.png" alt="image-20220620215601211" style="zoom:40%;" />

#### DR/BDR的选举

>   -   DR和BDR的选举是通过Hello协议来完成的。在每个网络分段上Hello 数据包是通过IP组播来交换的。
>   -   只有在广播和非广播的多路访问网络(如以太网和帧中继)的网络分段上才会进行DR和BDR的选举。
>   -   点到点链路，例如串行WAN连接，不会进行DR/BDR的选举。

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620215955888.png" alt="image-20220620215955888" style="zoom:40%;" />

>   ==OSPF中 DR 和 BDR的选举规则==:
>
>   1.   首先会比较接口的Priority数值(0~255): 数值越大越优; 
>
>        -   优先级查看: `how ip ospf interface`;
>        -   优先级修改: `R2(config-if)#ip ospf priority ?`
>
>   2.   Priority数值相等时, 进行 Router-ID 的比较: 数值越大越优;
>
>        -   默认情况下路由器上的最高激活IP地址, 将在路由器启动时成为该路由器的RID。
>
>            -   可以使用环回(逻辑)接口可以修改RID;
>
>            -   也可以使用命令`router-id`实现对RID的强制修改:
>
>                ```sh
>                R3#sh ip ospf
>                	Routing Process "ospf 1" with ID 10.1.12.1
>                R3#config t
>                R3(config)#router ospf 1
>                R3(config-router)#router-id 172.31.1.4
>                R3(config-router)#Reload or use "clear ip ospf process" command, for
>                	this to take effect
>                R3(config-router)#do clear ip ospf process
>                Reset ALL OSPF processes? [no]: yes
>                    20:16:35: %OSPF-5-ADJCHG: Process 1, Nbr 10.1.5.1 on FastEthernet0/0
>                    from FULL to DOWN, Neighbor Down: Adjacency forced to reset
>                    20:16:35: %OSPF-5-ADJCHG: Process 1, Nbr 10.1.5.1 on FastEthernet0/0
>                    from FULL to DOWN, Neighbor Down: Interface down or detached
>                R3(config-router)#do sh ip ospf
>                    Routing Process "ospf 1" with ID 172.31.1.4
>                ```
>
>                
>
>        >   DR的`非抢占性`: 
>        >
>        >   -   OSPF选举过程结束后加入的路由器, 即使拥有更高的 Priority和 Router-ID, 但只要现有的DR不挂掉, DR就不会被新的路由器所抢占;
>        >
>        >   -   如果想要重新执行OSPF选举, 选举 R1 作为 DR:
>        >
>        >       ![image-20220626102501264](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220626102501264.png)

##### Router-ID的产生

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620220024361.png" alt="image-20220620220024361" style="zoom: 33%;" />

#### LSA的泛洪

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620220244595.png" alt="image-20220620220244595" style="zoom:40%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620220316313.png" alt="image-20220620220316313" style="zoom:40%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220620220412115.png" alt="image-20220620220412115" style="zoom:40%;" />

#### 配置:

在CCNA阶段, 只需掌握基本的单区域中的OSPF配置即可

```shell
# 路由器模式下
R1(config)#router ospf ?/进程ID   # 各路由器的OSPF进程ID 是彼此互不相关的(取值介于1~65535), 但便于维护可以定义同一个进程ID
router-id  ID编号
network 接口的IP地址 通配符掩码 area areaID  # <0-4294967295> OSPF area 10 as a decimal value

# 接口模式下
ip ospf cost 数值  # 手动设置 指定接口的 COST值  (接口模式下执行)
ip ospf 进程ID area AreaID   # 设置接口的area,可以取代 上面 network ... 设置 area的方式
sh run int e0/0

show ip ospf neighbor   # 查看OSPF邻居表
sh ip os int br
sh ip os rou


clear ip route *   # 清除静态路由表
debuf ip ospf
```

>   通配符掩码:
>
>   -   配置OSPF可以有许多种不同的方式，但最简单和最容易的做法就是使用通配符掩码0.0.0.0;
>
>   -   取值与子网掩码相反, 通配符掩码 = 255 - 子网掩码;
>
>   -   引例:
>
>       -   网络和通配符掩码1.1.1 .1 0.0.0.0 的组合将只指定使用1.1.1.1精确配置的接口，而不包含其他的地址; 如果想在指定接口上简单明确地激活OSPF ，这种方式确实很有用;
>       -   如果你坚持要匹配网络中的某个范围，如网络和通配符掩码1.1.0.00.0.255.255 的组合将指定一个范围1.1.0.0 - 1.1.255.255。
>
>   -   示例:
>
>       >   下面的路由器使用了4 个不同的接口与4 个子网相连接:
>       >   192.168.10.64/28 ;
>       >   192.168.10.80/28 ;
>       >   192.168.10.96/28 ;
>       >   192.168.10.8/30 。
>       >
>       >   -   所有的接口都需要配置在区域。中。在我看来，最简单的聚合配置方式是:
>       >
>       >   ```sh
>       >   Test#config t
>       >   Test(config)#router ospf 1
>       >   Test(config-router)#network 192.168.10.0 0.0.0.255 area 0
>       >   ```
>       >
>       >   -   遗憾的是, 这样简易的配置方式并没有包含在CCNA的目标中!既然这样，我们需要通过使用子网号和通配符，为每个接口创建一个单独的网络声明:
>       >
>       >   ```sh
>       >   Test#config t
>       >   Test(config)#router ospf 1
>       >   Test(config-router)#network 192.168.10.64 0.0.0.15 area 0
>       >   Test(config-router)#network 192.168.10.80 0.0.0.15 area 0
>       >   Test(config-router)#network 192.168.10.96 0.0.0.15 area 0
>       >   Test(config-router)#network 192.168.10.8 0.0.0.3 area 0
>       >   ```
>       >
>       >   -   在此使用0.0.0.0 通配符来精确地指定接口的IP地址也是可以的, 但是CCNA 的目标不仅仅是要掌握那些最容易操作的部分

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621085920432.png" alt="image-20220621085920432" style="zoom:40%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621085951700.png" alt="image-20220621085951700" style="zoom:40%;" />

#### OSPF的相关命令

-   `show ip ospf` 用于显示运行在该路由器上的-个或全部OSPF进程的OSPF信息。这些信息包含路由器ID 、区域信息、SPF 统计和LSA 定时器信息。

    ```sh
    Corp#sh ip ospf
        Routing Process "ospf 132" with ID 10. 1. 5.1
        Supports only single TOS(TOSO) routes
        Supports opaque LSA
        SPF schedule delay 5 secs , Hold time between two SPFs 10 secs
        Minimum LSA interval 5 secs. Minimum LSA arrival 1 secs
        Number of external LSA O. Checksum Sum OxOOOOOO
        Number of opaque AS LSA O. Checksum Sum OxOOOOOO
        Number咱of OCbitless external and opaque AS LSA U 仆
        Number of OoNotAge external and opaque AS LSA 0
        Number of areas in this router is 1. 1 normal 0 stub 0 nssa
        External flood list length 0
            Area BACKBONE(O)
                Number of interfaces in this area is 5
                Area has no authentication
                SPF algorithm executed 5 times
                Area ranges are
                Number咱of LSA 5. Checksum Sum Ox0283f4
                Number of opaque link LSA O. Checksum Sum OxOOOOOO
                Number of OCbitless LSA 0
                Number of indication LSA 0
                Number of OoNotAge LSA 0
                Flood list length 0
    ```

    

-   `show ip ospf database` 命令将给出在互联网络中路由器的编号(AS)，及相邻路由器的ID(也就是前面提到过的拓扑数据库); 与`show ip eigrp topology`命令不同，这个命令只显示OSPF路由器，而不是AS 中的全部链路

    ```sh
    Corp#sh ip ospf database
        		OSPF Router with ID (10.1.5.1) (Process ID 132)
        		Router Link States (Area 0)
        Link ID  	ADV Router 		Age 	Seq# Checksum 	Link count
        192.168.20.1 192.168.20.1 	1585 	0x80000006 0x00ae08 6
        192.168.40.1 192.168.40.1 	1005 	0x80000005 0x0069c7 4
        10.1.5.1 	10.1.5.1 		688 	0x80000009 0x008108 8
        172.16.10.1 172.16.10.1 	688 	0x80000004 0x0021a6 2
        
        		Net Link States (Area 0)
        Link ID 	ADV Router 	Age 	Seq# Checksum
        10.1.5.1 	10.1.5.1 	688 	0x80000001 0x00c977
    ```

    >   这里能看到4个路由器和每个路由器的RID( 即每个路由器上最高的IP地址)。路由器的输出还给出了链路ID 和该链路上位于ADV 路由器(即通告路由器)下的路由器阻D ，注意，接口也是链路。

-   `show ip ospf interface` 给出了所有与接口相关的OSPF信息

    ```sh
    Corp#sh ip ospf int f0/0
        FastEthernet0/0 is up, line protocol is up
        Internet address is 10.1.5.1/24, Area 0
        Process ID 132, Router ID 10.1.5.1, Network Type BROADCAST, Cost: 1
        Transmit Delay is 1 sec, State DR, Priority 1
        Designated Router (ID) 10.1.5.1, Interface address 10.1.5.1
        Backup Designated Router (ID) 172.16.10.1, Interface address 10.1.5.2
        Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
        Hello due in 00:00:04
        Index 5/5, flood queue length 0
        Next 0x0(0)/0x0(0)
        Last flood scan length is 1, maximum is 1
        Last flood scan time is 0 msec, maximum is 0 msec
        Neighbor Count is 1, Adjacent neighbor count is 1
        Adjacent with neighbor 172.16.10.1 (Backup Designated Router)
        Suppress hello for 0 neighbor(s)
    ```

    >   The following information is displayed by this command:
    >
    >   -   Interface IP address
    >   -   Area assignment
    >   -   Process ID
    >   -   Router ID
    >   -   Network type
    >   -   Cost
    >   -   Priority
    >   -   DR/BDR election information (if applicable)
    >   -   Hello and Dead timer intervals
    >   -   Adjacent neighbor information

-   `show ip ospf neighbor` 命令汇总了OSPF 信息中关于邻居和邻接状态的信息

    ```sh
    Corp#sh ip ospf neighbor
    Neighbor ID Pri State Dead Time Address Interface
    172.16.10.1 1 FULL/DR 00:00:39 10.1.5.2 FastEthernet0/0
    192.168.20.1 0 FULL/ - 00:00:38 10.1.2.2 Serial0/0/0
    192.168.20.1 0 FULL/ - 00:00:38 10.1.3.2 Serial0/0/1
    192.168.40.1 0 FULL/ - 00:00:36 10.1.4.2 Serial0/1/0
    ```

    >   -   在R3和Corp 路由器间有一个Ethernet Link(广播多路访问)，因此这里会由一个选举过程来决定谁是指定路由器(DR) 以及谁是备份指定路由器(BDR)。
    >   -   点到点链路(使用了串口Serial Port)上不会进行DR/BDR的选举，并且它们显示为 FULL/_

-   `show ip protocols` 不论在路由器上运行OSPF 、EIGRP 、IGRP 、RIP 、BGP ， IS-IS ，或者其他能配置在路由器上的路由选择协议，此命令都非常有用。它提供了一个关于所有当前运行协议的真实操作情况的概述.

###### 调试命令

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207081332764.png" alt="image-20220708133242604" style="zoom:80%;" />

#### 配置OSPF汇总路由

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207081445422.png" alt="image-20220708144521221" style="zoom:70%;" />

>   要汇总区域1到主干区域。中，在OSPF进程ID下使用下列命令。下面是核心(主干)路由器的一个完整OSPF配置:
>
>   ```sh
>   Core(config)#router ospf 1
>   Core(config-router)#network 192.168.10.64 0.0.0.3 area 1
>   Core(config-router)#network 192.168.10.68 0.0.0.3 area 1
>   Core(config-router)#network 10.10.10.0 0.0.0.255 area 0
>   Core(config-router)#area 1 range 192.168.10.64 255.255.255.224
>   ```
>
>   

