---
title: Switching Part_2
date: 2023-03-25 02:11:12
permalink: /pages/778234/
categories:
  - 网络运维
  - CCNA
  - CCNA知识笔记
tags:
  - 
---



# STP & RSTP

## Spanning Tree Protocol

> - Classic Spanning Tree Protocol’ is **IEEE 802.1D**;
>
> - Cisco's version of STP called [**PVST (Per-Vlan Spanning Tree)**], which runs a separate spanning tree instance in each VLAN.
>
> - Switches from ALL vendors run STP by default;
>
> - STP prevents Layer 2 loops by placing redundant ports in a **blocking state**, *essentially disabling the interface*; *Interfaces in a blocking state only send or receive STP messages (called BPDUs = Bridge Protocol Data Units)*.
>
>   >   Spanning Tree Protocol still uses the term ‘**bridge**’. However, when we use the term ‘bridge’, we really mean ‘**switch**’. Bridges are not used in modern networks.
>
> - These interfaces act as **backups** that can enter a forwarding state if an active (=currently forwarding) interface fails.
>
> - Interfaces in a **forwarding state** behave normally. They send and receive all normal traffic.

> ##### STP的主要功能是
>
> - Spanning tree is a Layer 2 protocol by the way, it enables redundant layer 2 networks;
> - 同时防止在第2层网络中因交换机之间的物理链路冗余而导致网络环路。它警惕地监视着网络以找出所有可用链路，并关闭任何冗余链路以确保不会出现环路。STP首先使用 生成树算法(STA) 创建一个拓扑数据库，然后找出并关闭冗余链路。运行STP后，数据帧就只能在STP选定的最优链路上进行转发。

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207081848217.png" alt="image-20220708184828063" style="zoom:70%;" />

### 存在问题的网络拓扑设计

#### **单点故障**的问题

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303240251662.png" alt="image-20230324025124362" style="zoom: 25%;" />

>#### Network Redundancy
>
> to make sure that that infrastructure is resilient to failures as much as possible.
>
> - Redundancy is an essential part of network design;
> - Modern networks are expected to run 24/7/365. Even a short downtime can be disastrous for a business;
> - If one network component fails, you must ensure that other components will take over with little or no downtime;
> - As much as possible, you must implement redundancy at every possible point in the network.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303240252593.png" alt="image-20230324025212222" style="zoom: 25%;" />
>
>   > **NOTE:**
>   >
>   > - Most PCs like shown in the picture only have a single Network Interface Card (NIC), so they can only be plugged into a single switch.
>   >
>   > - However, important servers typically have multiple NICs, so they can be plugged into multiple switches for redundancy.

#### ==冗余拓扑的问题==

>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241312921.png" alt="image-20230324131213628" style="zoom: 25%;" />
>
>##### Broadcast Storm 广播风暴
>
> The Ethernet header doesn’t have a TTL field. These broadcast frames will loop around the network indefinitely. If enough of these looped broadcasts accumulate in the network, the network will be too congested for legitimate traffic to use the network. This is called a **broadcast storm**.
>
>
>
>##### MAC Address Flapping(不稳定)
>
> Network congestion isn’t the only problem. Each time a frame arrives on a switchport, the switch uses the source MAC address field to ‘learn’ the MAC address and update its MAC address table. When frames with the same source MAC address repeatedly arrive on different interfaces, the switch is continuously updating the interface in its MAC address table. This is known as **MAC Address Flapping**.
>
> In shorts, When a switch rapidly and continuously updates a MAC address in its MAC address table, alternating between different interfaces, this is known as [**MAC Address Flapping**].
>
>##### 多帧复制
>
> End-hosts would receive so many copied frame

由此, STP协议默认是开启的, 因为一旦存在二层环路的网络运转起来，要想找出问题的根源会超级困难!

### Spanning Tree Terms

#### BPDU

> - Regular STP (not Cisco’s PVST+) uses a destination MAC address of `0180.c200.0000`;
> - Cisco’s **PVST+** uses the **destination MAC address** of `0100.0ccc.cccd` for its BPDUs.
>   - **PVST** = Only ISL trunk encapsulation;
>   - **PVST+** = Supports 802.1Q;
> - When a switch is powered on, it assumes it is the root bridge, So all switches send BPDUs. Each switch compares the parameters in the **Bridge Protocol Data Unit (BPDU)** that it sends to one neighbor with the ones that it receives from other neighbors.
>   - It will only give up its position if it receives a ‘superior’ BPDU (lower bridge ID).
>   - *Once the topology has converged and all switches agree on the root bridge, only the root bridge sends BPDUs.*
>   - Other switches in the network will forward these BPDUs only on the Designated Ports, but will not generate their own original BPDUs.
> - BPDU frame format: <https://www.ii.pwr.edu.pl/~kano/course/module4/4.1.2.5/4.1.2.5.html>
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241617478.png" alt="STP protocol frames" style="zoom:140%;" />
>
> 
>
> - The first three fields are the
>
>   - **Protocol IDentifier**, which is always 0x0000 for spanning tree;
>
>   - **Version**: set to 0 for classic STP; set to 22 for RSTP;
>
>   - **BPDU type** is hexadecimal 00 for what’s called a ‘**configuration BPDU**’.
>
>         >   There are other types of BPDUs, but we don’t need to go that in depth for the CCNA.
>
> - **Flags**: used to signal topology changes to other switches.
> - **Root ID**: Bridge ID of Root Bridge of the broadcast domain.
> - **Root path cost**: Root Cost to the **Root Bridge**, 0 means **Root Bridge** itself;
> - **Bridge ID**: = 4 bits **Bridge Priority** + 12 bits **Extended System ID(VLAN ID)** + 48 bits **MAC Address**.
> - **Port ID**: 0x8002 can be divided and translated to decimal 128 & 2(128.2)
>   - 80 in hexadecimal is equivalent to 128, which is the default priority;
>   - 02 in hexadecimal is the serial number of the port itself.
> - **Message Age**: it starts at **0** at the root bridge and is increased by **1** each time it is forwarded by another switch. It is subtracted from the max age when a switch receives the BPDU, so for example if the BPDU is passed through 5 switches, when it reaches the 6th bridge it will immediately reduce its max age timer to 15, meaning each time it receives a BPDU its max age will reset to 15 instead of 20, even though the max age timer is 20.
>
> ---
>
> - **Max Age**: defines How long(20s by default) an interface will wait after ceasing(停止) to receive Hello BDPUs to change the STP topology.
>   - If another BPDU is received before the max age timer counts down to 0, the time will reset to 20 seconds and no changes will occur.
>   - If another BPDU is not received, the max age timer counts down to 0 and the switch will reevaluate its STP choices, including root bridge, and local root, designated, and non-designated ports.
>
>   - If a non-designated port is selected to become a designated or root port, it will transition from the blocking state to the listening state (15 seconds), learning state (15 seconds), and then finally the forwarding state. So, it can take **a total of 50 seconds** for a blocking interface to transition to forwarding.
> - **Hello time**: the Hello BPDUs will be sent every 2 seconds by default;
> - **Forward delay** means the time it takes to transition a port from listening to learning mode (also from learning to forwarding mode), which is set to 15 seconds by default and can be seen in the `show spanning-tree` output.
>
> >   *The STP timers on the [**Root Bridge**] determine the timers used for all switches in the network!*

#### Bridge ID

> It is determined by a combination of the **Bridge Priority** (32768 by default on all Cisco switches) and **the MAC address** of each Switchport.
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241338276.png" alt="image-20230324133815007" style="zoom:29%;" />
>
> ###### 详解 Bridge ID
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241342149.png" alt="image-20230324134238878" style="zoom: 29%;" />
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241345376.png" alt="image-20230324134536110" style="zoom:30%;" />
>
> - The **bridge priority** + **extended system ID** is a single field of the bridge ID, however the extended system ID is set and cannot be changed (because it is determined by the VLAN ID.
>   - **Therefore, the STP bridge priority can only be changed in units of 4096**. The valid values you can configure are: 0, 4096, 8192, 12288, 16384, 20480, 24576, 28672, 32768, 36864, 40960, 45056, 49152, 53248, 57344, or 61440.
>   - The Extended System ID will then be added to this number to make the total bridge priority.

#### Roles of switch in STP

> - `Root bridge`:
>   - **The switch with the lowest Bridge ID becomes the root bridge.**
>   - **ALL ports on the root bridge are `Designated Port` put in a forwarding state, and other switches in the topology must have a path to reach the root bridge**.
>   - All other decisions in the network, such as which port is to be blocked and which port is to be put in forwarding mode are made from the perspective of this root bridge. Once a root bridge is elected on the network, all other bridges must make a single path to this root bridge. The port with the lowest-cost path to the root bridge is called the **root port**.
> - `Non-root bridges` These are all bridges that are not the root bridge. Non-root bridges exchange BPDUs with all bridges and update the STP topology database on all switches, preventing loops and providing a measure of defense against link failures.

>   ##### Configure the Root Bridge:
>
>   ```sh
>   SW1(config)#spanning-tree vlan 1 ?
>    priority  Set the bridge priority for the spanning tree
>    root      Configure switch as root
>    <cr>
>   
>   SW1(config)#spanning-tree vlan 1 root ?
>    primary    Configure this switch as primary root for this spanning tree
>    secondary  Configure switch as secondary root
>   ```
>
>   -   The `spanning-tree vlan VLAN_ID root primary` command sets the STP priority to [**24576**], or [**4096 less than the current root's priority**} `at one time`.
>   -   The `spanning-tree vlan VLAN_ID root secondary` command sets the STP priority to a *fixed value* of [**28672**], which can let the switch with the second-lowest priority(**32678 by default -> `root primary`: 24576; `root secondary`: 28672**), which allows the switch to be next in line to become the root bridge if the current Root Bridge fails. 

#### Port Cost & Port ID

> - `Port cost` Port cost determines the best path when multiple links are used between two switches. **The cost of a link is determined by the bandwidth of a link**.
>
>     - Just count the **forwarding interfaces** on other switches on the path and the **local interface itself**, rather than **receiving interfaces** and the **sending interface on the Root Bridge**.
>
>
>     <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241414788.png" alt="image-20230324141422589" style="zoom:28%;" />
>
>     <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303250605491.png" alt="image-20230325060559199" style="zoom:33%;" />
>
>     >   The ports connected to *another switch’s Root Port* MUST be **Designated Port**. Because the **Root Port is the switch’s path to the root bridge**, another switch must not block it.
>
> - `Port ID`: `= Port Priority(default 128) + Port Number`. Notice the column title is *Prio dot number*, So, each port has a **default priority of 128**, and then a **unique port number**, 1 for G0/0, 2 for G0/1, etc on this switch.
>
>     <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241508858.png" alt="image-20230324150853533" style="zoom:33%;" />

#### Port roles in STP

> - `Root port` The root port is always the *interface directly connected to the root bridge*, or *the lowest path cost to the root bridge*. [Click to see the whole Selection process](#STP执行过程:)
>
>   - Any Non-Root Bridge has only one Root Port.
>
> - `Designated port`:
>
>   - **All interfaces on the root bridge are designated ports.**
>
>   - A designated port is one that has been determined as **having the best (lowest) cost to the root bridge via its root port**.
>
>   - A stable designated port will be marked as a forwarding port.
>
>   - After STP convergence, The switches will **only forward BPDUs on their DESIGNATED PORTs**.
>
>         <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303250107855.png" alt="image-20230325010741565" style="zoom:33%;" />
>
> - `Non-designated port` A non-designated port is one with a higher cost than the designated port. They are what’s left over after the root ports and designated ports have been determined. Non-designated ports are put in blocking mode, they are not forwarding ports.

### Versions of STP

```sh
Switch(config)#spanning-tree ? 
  mode      Spanning tree operating mode  
  portfast  Spanning tree portfast options
  vlan      VLAN Switch Spanning Tree
  
Switch(config)#spanning-tree mode ?
  mst 		  Multiple spanning tree mode
  pvst		  Per-VLAN spanning tree mode
  rapid-pvst  Per-VLAN rapid spanning tree mode
```

>   -   **mst**: (not for CCNA)
>   -   **pvst** is the classic spanning tree but with Cisco’s per-vlan addition;
>   -   **rapid-pvst**: is an improved version. Modern Cisco switches run **rapid-PVST by default**, and usually there is no reason to change it.

### STP的机制和执行过程

#### STP机制

> - By selecting which ports are forwarding and which ports are blocking, STP creates a single path to/from each point in the network. This prevents Layer 2 loops.
> - *STP-enabled switches send/receive Hello BPDUs out of all interfaces, the default timer is 2 seconds* (the switch will send a Hello BPDU out of every interface, once every 2 seconds).
> - If a switch receives a Hello BPDU on an interface, it knows that interface is connected to another switch (routers, PCs, etc. do not run STP, so they do not send Hello BPDUs).
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241328145.png" alt="image-20230324132801870" style="zoom: 25%;" />
>
> - 一旦所有的交换机都同意将某台交换机选为根桥，每个网桥就必须找出属于它自己的一个并且也是唯一一个分派的根端口。任意两台交换机之间的链路必须要有一个且只能有一个指定端口，该端口位于能够提供到根桥最大带宽的链路上(lowest Root Cost)。注意，一个网桥可以通过多个其他网桥到达根桥，也就是说这一路径可能不是物理上的最短路径，但一定是最快(具有最大带宽)路径;
> - Every collision domain has a single STP designated port.
> - 那些既不是根端口也不是指定端口的端口，也就是那些非根端口和非指定端口，全部被设置为阻塞状态，这样就避免了交换环路的形成。

#### STP执行过程

> 1. All switches exchange BPDUs after power on. The switch with the **lowest Bridge ID** is elected as the **Root Bridge**. **All ports on the root bridge are designated ports**(forwarding state).
>
> 2. Each remaining switch will select **ONE** of its interfaces to be its unique **Root Port**(also in forwarding state).
>
>      **Root Port selection:**
>
>      1. The interface with the lowest **Root Cost** will be the root port.
>
>      2. if the Root Cost of several ports are equal, then the port with lowest **neighbor Bridge ID** will be Root Port.
>
>           <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241440308.png" alt="image-20230324144054077" style="zoom:33%;" />
>           
>           
>           
>      3. if two switches have two connections between them, so both the root cost and the neighbor bridge ID are the same, the interface connected to **the interface on the neighbor switch with the lowest port ID** will become the root port.
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303250527243.png" alt="image-20230324154202907" style="zoom:33%;" />
>
> 4. Each remaining collision domain will select ONE interface to be a **Designated Port** (forwarding state). The other port in the collision domain will be non-designated (blocking).
>
>      **Designated Port selection:**
>
>      1. *The switch* with the lowest **Root Cost** will make its port designated.
>      2. If the root cost is the same, *the switch* with the lowest **Bridge ID** will make its port designated.
>
> 
>
> ##### Summary
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241553669.png" alt="image-20230324155324280" style="zoom:33%;" />
>
> ##### Quiz
>
> ###### Quiz 1
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241602980.png" alt="image-20230324160225671" style="zoom:33%;" />
>
> ###### Quiz 2
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303241612303.png" alt="image-20230324161233056" style="zoom:33%;" />

### Lab

```shell
SW2#show spanning-tree ?
  active             Report on active interfaces only
  detail             Detailed information
  inconsistentports  Show inconsistent ports
  interface          Spanning Tree interface status and configuration
  summary            Summary of port states
  vlan               VLAN Switch Spanning Trees
  <cr>

SW2#show spanning-tree 
VLAN0001
  Spanning tree enabled protocol ieee  # it’s Cisco’s PVST, but this means it’s in ‘classic’ mode rather than than the newer rapid spanning tree
  Root ID    Priority    24577
             Address     00E0.F9E6.44A5
             Cost        8    # cost of root path
             Port        25(GigabitEthernet0/1)
             Hello Time  2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    28673  (priority 28672 sys-id-ext 1)
             Address     0002.16D6.D0B8
             Hello Time  2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  20
        # Port path cost, which means the cost of each node-to-node Link
Interface        Role Sts Cost      Prio.Nbr Type
---------------- ---- --- --------- -------- --------------------------------
Fa0/4            Desg FWD 19        128.4    P2p       # Desg 为 Designed Port
Fa0/1            Desg FWD 19        128.1    P2p
Fa0/2            Desg FWD 19        128.2    P2p       
Fa0/3            Altn BLK 19        128.3    P2p       # Altn 为 Blocking State
Gi0/1            Root FWD 4         128.25   P2p       # Root 为 Root Port
```

#### 每个广播域选举一个根桥

> - 具有最低的Bridge ID的交换机被选为Root Bridge
> - *all the interfaces on Root Bridge* are **Designated Port**;

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622000654205.png" alt="image-20220622000654205" style="zoom:40%;" />

> - 交换机向广播域内每隔2秒互相发出一个BPDU报文;
>
>
>
> - BPDU报文中的 Bridge ID最小的被选为 Root Bridge;
>
>   - Bridge ID 由 2 Bytes的Priority 和 6 Bytes的MAC地址组成; 而默认的优先级为 32678;
>
>         ```sh
>         Switch# show spanning-tree brief
>                                                                Hello  Max  Fwd
>             Vlan                         Bridge ID              Time  Age  Dly  Protocol
>             ---------------- --------------------------------- -----  ---  ---  --------
>             VLAN0001         32769 (32768,   1) aabb.cc00.2000    2    20   15  rstp        
>             VLAN0002         32770 (32768,   2) aabb.cc00.2000    2    20   15  rstp  
>         # 这里的 Bridge ID 实际上是由交换机和 VLAN ID 构成的生成树桥ID的信息， VLAN 1 被表示为VLAN0001，注意每个VLAN 都可以有不同的根桥。
>         ```
>
>   - 如果两个交换机的Priority值不加以修改, 则 MAC地址将决定 哪个交换机具有最低的Bridge ID;
>
>   - Priority的取值是分散的, 以 4096 为间隔递增:
>
>         ```sh
>         #  在当前的交换机上, 设置在指定 VLAN 的生成树的 Priority值
>         Switch(config)#spanning-tree vlan 1 priority 9182
>         % Bridge Priority must be in increments of 4096.
>         % Allowed values are: 
>           0     4096  8192  12288 16384 20480 24576 28672
>           32768 36864 40960 45056 49152 53248 57344 61440
>         ```
>
>

> 也可以直接设置指定交换机为根桥:
>
> ```sh
> S1(config)#spanning-tree vlan 1 root ?
>    primary Configure this switch as primary root for this spanning tree
>    secondary Configure switch as secondary root
> S1(config)#spanning-tree vlan 1 root primary
> ```

#### 在所有非根桥的交换机上选择出唯一的 Root Port

> - Root Port selection:
>
>   - 到达Root Bridge的lowest root cost的交换机接口;
>
>   - 若Root Cost相等, 则比较`上一个BPDU发送者的Bridge ID`;
>
>   - 如果一致, 则比较`上一个BPDU发送者的Port ID`(包含了 *port priority*和 *物理口编号*)
>
>
>     ```sh
>     # 交换机端口的 Port-priority值, 取值是离散的: 0, 64, 128, 192
>     Switch(config)#int e0/1
>     Switch(config-if)#spanning-tree vlan 1 port-priority ?
>       <0-192>  port priority in increments of 64
>     ```
>
>
> - Root Port的链路的另一端必定是 **Designated Port**;

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622005432148.png" alt="image-20220622005432148" style="zoom:47%;" />

#### 在Non-Root_Port的链路上选出一个 Designated Port

> 1. **The switch with the lowest Root Cost** will make its port designated.
> 2. If the root cost is the same, **the switch with the lowest Bridge ID** will make its port designated.

#### 阻塞其他端口

Non-Designed Port为阻塞端口(Blocking state)

### Four Port States of STP

>   ##### STP Convergence(收敛)
>
>   - Convergence occurs when all ports on bridges and switches have transitioned to either forwarding or blocking states. No data will be forwarded until convergence is complete. Yes—you read that right: When STP is converging, all host data stops transmitting!
>
>   - By creating your physical switch design in a hierarchical manner, as shown in Figure, you can make your Core switch the STP root, which will then make STP convergence time nice and quick.
>
>   ![image-20220709164505688](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207092051674.png)
>
>   ----
>
>   <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622021653187.png" alt="image-20220622021653187" style="zoom:50%;" />
>
>   > - A forwarding interface can move directly to a blocking state (there is no worry about creating a loop by blocking an interface).
>   > - A blocking interface cannot move directly to forwarding state. It must go through the listening and learning states.
>
>   ##### `Blocking`: **stable** state
>
>   - The purpose of the blocking state is to prevent loops at Layer-2 Data Link layer;
>   - Only **receive** BPDUs, and **does NOT forward** regular network traffic;
>   - DO NOT learn MAC address from regular traffic that arrives on the interface but just DROP it;
>   - All ports are in *blocking state by default* when the switch is powered up;
>   - Non-designated ports remain stable in a Blocking state.
>
>   
>
>   ##### `Listening`: **transitional** state
>
>   - After the Blocking state, **Only interfaces with the Designated or Root role** enter the Listening state. (Non-designated ports always remain Blocking).
>   - The Listening state is *15 seconds long by default*. This is determined by the **Forward delay** timer.
>   - ONLY **forwards** STP BPDUs, and **does NOT forward** regular traffic;
>   - **DO NOT learn MAC** address from regular traffic that arrives on the interface but just DROP it;
>
>   
>
>   ##### `Learning`: **transitional** state
>
>   - After the Listening state, Designated or Root ports will enter the Learning state.
>   - The Learning state is **15 seconds long by default**. This is also determined by the **Forward delay** timer (the same timer is used for both the Listening and Learning states)
>   - ONLY **forwards** STP BPDUs and **does NOT forward** regular traffic.
>   - However, A port in learning state populates the MAC address table but *still doesn’t forward data frames*.
>
>   
>
>   ##### `Forwarding`: **stable** state
>
>   - After the Learning state, *Root/Designated ports remain stable in a Forwarding state.*
>   - A port in the Forwarding state operate as normal:
>   - **forwards** BPDUs;
>   - **forwards** regular network traffic;
>   - learns MAC addresses;
>
>   ---
>
>   - **disabled** state means the interface is shutdown, doesn't play any role in STP.
>
>   ##### Summary
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303250046974.png" alt="image-20230325004600677" style="zoom:33%;" />

### 交换机的端口安全

>   ```sh
>   Switch#config t
>   Switch(config)#int f0/1
>   Switch(config-if)#switchport mode access
>   Switch(config-if)#switchport port-security ?
>   aging Port-security aging commands
>   mac-address Secure mac address
>   maximum Max secure addresses
>   violation Security violation mode
>   <cr>
>   ```
>
> - Since all Cisco’s latest switches ship with the ports in **desirable mode** *(the port desires to trunk if it senses another switch just connected)*, we must first change the port from desirable mode to `access mode` or we cannot configure port security. Once that is done, we can continue on with our port-security commands.
>
> - You can see clearly in the preceding output that the switch port port-security command can be used with four options:
>
> - `switchport port-security mac-address`: to assign individual MAC addresses to each switch port, but if you choose to go there, you’d better have a lot of time on your hands!
>
> - 如果需要将交换机的端口设置为，每个端口只允许接入一台主机，并且当有人破坏这一规则时，
>           端口就会关闭，那么，完成这样的配置可以使用下列命令:
>
>       ```sh
>       Switch(config-if)#switchport port-security maximum 1
>       Switch(config-if)#switchport port-security violation shutdown
>       ```
>
>       >   一旦这种情况发生，只能在交换机上手工使用`no shutdown`命令来恢复端口的启用。
>
> - 接入"stick" 端口的前两个地址被认定为静态地址，并且不管在aging命令中设置了多长时间，它们一直会是静态地址。为什么这里要将它设置为2 呢?这是因为其中一个地址将用于PC机，而另一个用于电话机。
>
>       ```sh
>       Switch(config-if)#switchport port-security maximum 2
>       Switch(config-if)#switchport port-security mac-address sticky
>       Switch(config-if)#switchport port-security violation shutdown
>       ```

### STP Optional Features(Toolkit)

#### Portfast

> 在交换机端口上，从`Blocking状态`到`Forwarding状态`的Classic STP 拓扑的收敛时间通常需要**50秒**(20s的Max Age + 30s state-changing from Blocking to Forwarding(Listening -15s-> Learing -15s-> Forwarding))，这样在服务器或主机上就会引发超时的问题，比如，在重启交换机的时候。
>
> - 针对这样的问题，可以在Access Layer交换机的**Access端口(connected to End Hosts)**上开启`Portfast`来**禁用STP协议**。 在端口上开启此功能之后,插入终端设备可以bypass *Listening*和*Learning* 阶段, 只需要 1s 左右就可以从 Blocking 直接进入 Forwarding state.
> - You can still configure portfast on a trunk port, it just won’t take effect.
> - However, if another switch is connected to the interface within Portfast mode of one switch, it still can cause Broadcast Storm and other problems. -> `BPDU Guard`

```sh
# 设置所有的Access接口为 Portfast
Switch(config)#spanning-tree portfast ? 
  bpduguard  # Enable portfast bpdu guard on this switch
  default    # Enable portfast by default on all access ports
Switch(config)#spanning-tree portfast default
  
# 设置指定接口为 portfast
Switch(config)#int range fastEthernet 0/1 - 12
Switch(config-if)#spanning-tree portfast ?
    disable Disable portfast for this interface
    trunk Enable portfast on the interface even in trunk mode
    <cr>
Switch(config-if-range)#spanning-tree portfast
```

#### 两种SafeGuard搭配Portfast使用

###### BPDU guard

```sh
#You can also enable BPDU Guard with the following command: 
SW3(config)#spanning-tree portfast ?
  bpduguard  Enable portfast bpdu guard on this switch
  default    Enable portfast by default on all access ports
SW1(config)# spanning-tree portfast bpduguard default   
# This enables BPDU Guard on all Portfast-enabled interfaces.

# 在指定接口上开启 BPDU Guard
Switch(config)#int f0/3
Switch(config-if)#spanning-tree bpduguard ?
	disable  Disable BPDU guard for this interface
	enable   Enable BPDU guard for this interface
Switch(config-if)#spanning-tree bpduguard enable
```

>   If an interface with BPDU Guard enabled receives a BPDU from another switch, the interface will be shut down to prevent a loop from forming. 当交换机的Portfast接口开启 BPDUguard 后, 当此接口插入交换机(接收到BPDU报文)就会变成``err-disable`状态. 
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303250231151.png" alt="image-20230325023132938" style="zoom:33%;" />
>
>   ###### How to reactive the port after remove the connection?
>
>   `shutdown` the interface, and then `no shutdown`: 
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303250233455.png" alt="image-20230325023316288" style="zoom:33%;" />

###### BPDU Filter

> 当access layer的交换机的指定接口开启 bpdufilter 之后, 如果BPDU Filter 接收到了一个BPDU ，它会立即关闭端口的PortFast，并迫使端口重新成为STP拓扑的一部分.
>
> ```sh
> Switch(config-if)#spanning-tree bpdufilter ?
>  	disable  Disable BPDU filtering for this interface
>  	enable   Enable BPDU filtering for this interface
> ```

#### Root Guard & Loop Guard

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303250238835.png" alt="image-20230325023832577" style="zoom:33%;" />

>   -   **Root Guard**: helps maintain the spanning tree topology if someone plugs another switch into the network either with bad intent, or perhaps without knowing the impact of their action.
>   -   **Loop Guard**: This prevents loops that can happen if an interface fails only in one direction, causing what is called a ‘unidirectional link’ that can’t receive data, but is still able to forward it, or the opposite.

#### UplinkFast

> UplinkFast 是思科产品特有的特性，两个交换机之间有2条以上的直连物理链路, 当主链路失效时, 在备份链路的阻塞端口可以立即工作, 就不用再等待通常STP收敛所需要的50秒的时间。
>
> ```sh
> S2#config t
> S2(config)#spanning-tree uplinkfast
> S1(config)#do show spanning-tree uplinkfast
> UplinkFast is enabled
> Station update rate set to 150 packets/sec.
> UplinkFast statistics
> -----------------------
> Number of transitions via uplinkFast (all VLANs) : 1
> Number of proxy multicast addresses transmitted (all VLANs) : 8
> Name Interface List
> -------------------- ------------------------------------
> VLAN0001 Fa0/1(fwd), Fa0/2
> S1(config)#
> ```

#### BackboneFast

> - Unlike UplinkFast(*which is used to determine and quickly fix link failures on the local switch*), another Cisco-proprietary STP extension called BackboneFast is used for speeding up convergence when a link *that’s not directly connected to the switch* fails. If a switch running BackboneFast receives an **inferior BPDU** from its designated bridge, it knows that a link on the path to the root has failed. Just to make sure you’re clear on this, an *inferior BPDU is one that lists the same switch for the root bridge and the designated bridge*.
>
> - And again, unlike UplinkFast(*which is only configured on Access layer switches or switches with redundant links and at least one link in blocking mode*), BackboneFast should be enabled on **all Catalyst switches** to allow for detection of indirect link failures.
>
> - Enabling BackboneFast is also beneficial because it starts the spanning tree reconfiguration more quickly—it can save 20 seconds on the default 50-second STP convergence time.
>
> - 默认情况下， BackboneFast 会将默认优先级提高到49152。
>
>     ```sh
>     S1(config)#spanning-tree backbonefast
>     S2(config)#spanning-tree backbonefast
>     Core(config)#spanning-tree backbonefast
>     S2(config)#do show spanning-tree backbonefast
>         BackboneFast is enabled
>         BackboneFast statistics
>         -----------------------
>         Number of transition via backboneFast (all VLANs) : 0
>         Number of inferior BPDUs received (all VLANs) : 2
>         Number of RLQ request PDUs received (all VLANs) : 0
>         Number of RLQ response PDUs received (all VLANs) : 1
>         Number of RLQ request PDUs sent (all VLANs) : 1
>         Number of RLQ response PDUs sent (all VLANs) : 0
>     S2(config)#
>     ```
>
> > 与配置UplinkFast不同，此处我们对网络中的所有交换机都进行了BackboneFast配置，而不只限于接入层交换机。
>     >
> > - 记住，BackboneFast 用来确定远程交换机上非直接连接到根路径的链路失效，这与UplinkFast不同，
> > - UplinkFast可以确定并快速修复本地交换机的链路失效。



### STP Load-Balancing

>   -   If you have multiple VLANs in your network, blocking the same interface in each VLAN is a waste of interface bandwidth. 
>   -   However, if you configure a different root bridge for different VLANs, different VLANs will disable different interfaces.

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303250320806.png" alt="image-20230325032037567" style="zoom:33%;" />

```sh
Switch1(config)# spanning-tree vlan 10 root primary
Switch1(config)# spanning-tree vlan 20 root secondary
```

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303250321987.png" alt="image-20230325032103750" style="zoom:33%;" />

```sh
Switch2(config)# spanning-tree vlan 20 root primary
Switch2(config)# spanning-tree vlan 10 root secondary
```

### Configure STP Port Settings

```sh
SW1(config-if)#spanning-tree ?
  bpduguard  Don't accept BPDUs on this interface
  cost       Change an interface's spanning tree port path cost
  guard      Change an interface's spanning tree guard mode
  link-type  Specify a link type for spanning tree protocol use
  portfast   Enable an interface to move directly to forwarding on link up
  vlan       VLAN Switch Spanning Tree
  
SW1(config-if)#spanning-tree vlan 1 ?
  cost           Change an interface's spanning tree port path cost
  port-priority  Change an interface's spanning tree port priority

SW1(config-if)#spanning-tree vlan 1 cost ?
  <1-200000000>  Change an interface's per VLAN spanning tree path cost

SW1(config-if)#spanning-tree vlan 1 port-priority ?
  <0-240>  port priority in increments of 16
```







## RSTP

> -   Rapid Spanning Tree Protocol (RSTP) 802.1w
> -   More specifically, we’ll be looking at Cisco’s version, **rapid per-VLAN spanning tree(rapid-pvst)**.
>
> - 思科创建了PortFast 、UplinkFast 和BackboneFast 来"修补" IEEE 802.1d 标准中的漏洞和缺陷。
>
> - 但这些改进特性的不足之处在于，它们都是思科专用的，还需要进行额外的配置。但新的802.1w 标准(RSTP) 将所有这些"问题"都一并解决了，你需要做的就只是打开RSTP. 有一点很重要，即必须确保网络中所有的交换机都能正确地运行802.1w 协议。
>
> - It might come as a surprise, but RSTP actually can interoperate with legacy STP protocols. -Just know that the inherently fast convergence ability of 802.1w is lost when it interacts with legacy bridges. 并且, 即使legacy bridges后来又配置了802.1w, 这些RSTP交换机也不能自动切换回802.1w, 而是继续发送 802.1d BPDU; 需要重启该交换机才可以.
>
>     ```sh
>     Core#config t
>     Core(config)#spanning-tree mode ?
>         mst 	Multiple spanning tree mode
>         pvst 	Per-Vlan spanning tree mode
>         rapid-pvst 	Per-Vlan rapid spanning tree mode
>     Core(config)#spanning-tree mode rapid-pvst
>     Core(config)#
>         1d02h: %LINEPROTO-5-UPDOWN: Line protocol on Interface Vlan1,
>         changed state to down
>         1d02h: %LINEPROTO-5-UPDOWN: Line protocol on Interface Vlan1,
>         changed state to up
>     
>     Core(config)#do show spanning-tree
>     VLAN0001
>      Spanning tree enabled protocol rstp  # rapid-pvst
>      Root ID Priority 32769
>             Address 000d.29bd.4b80
>             This bridge is the root
>             Hello Time 2 sec Max Age 20 sec Forward Delay 15 sec
>         Bridge ID Priority 32769 (priority 32768 sys-id-ext 1)
>             Address 000d.29bd.4b80
>             Hello Time 2 sec Max Age 20 sec Forward Delay 15 sec
>             Aging Time 300
>     
>         Interface  Role Sts  Cost Prio.Nbr  Type
>         ---------------- ---- --- --------- -------- ------------
>         Fa0/5   Desg FWD  19  128.5   P2p Peer(STP)
>         Fa0/6   Desg FWD  19  128.6   P2p Peer(STP)
>         Fa0/7   Desg FWD  19  128.7   P2p Peer(STP)
>         Fa0/8   Desg FWD  19  128.8   P2p Peer(STP)
>     ```









## 验证思科交换机的配置

```sh
show running-config   # 路由器或者交换机上都可以使用, 可以了解整个设备的运行配置
show mac address-table  # 显示转发过滤表
show spanning-tree  # 可以了解到根桥的MAC地址，以及每个VLAN所设置的优先级。
```

```sh
Switch#show spanning-tree ?    
  WORD               bridge group list, example 1,3-5,7,9
  active             Report on active interfaces only
  backbonefast       Show spanning tree backbonefast status
  blockedports       Show blocked ports
  bridge             Status and configuration of this bridge
  detail             Detailed information
  inconsistentports  Show inconsistent ports
  interface          Spanning Tree interface status and configuration
  mst                Multiple spanning trees
  pathcost           Show Spanning pathcost options
  root               Status and configuration of the root bridge
  summary            Summary of port states
  uplinkfast         Show spanning tree uplinkfast status
  vlan               VLAN Switch Spanning Trees
  |                  Output modifiers
```

```shell
Switch#show spanning-tree summary 
    Switch is in rapid-pvst mode
    Root bridge for: VLAN0001-VLAN0005
    Extended system ID                      is enabled
    Portfast Default                        is disabled
    Portfast Edge BPDU Guard Default        is disabled
    Portfast Edge BPDU Filter Default       is disabled
    Loopguard Default                       is disabled
    PVST Simulation Default                 is enabled but inactive in rapid-pvst mode
    Bridge Assurance                        is enabled
    EtherChannel misconfig guard            is enabled
    Configured Pathcost method used is short
    UplinkFast                              is disabled
    BackboneFast                            is disabled

    Name                   Blocking Listening Learning Forwarding STP Active
    ---------------------- -------- --------- -------- ---------- ----------
    VLAN0001                     0         0        0          4          4
    VLAN0002                     0         0        0          2          2
    VLAN0003                     0         0        0          2          2
    VLAN0004                     0         0        0          2          2
    VLAN0005                     0         0        0          2          2
```

```sh
# 设置静态的MAC地址条目
S1#config t
S1(config)#mac-address-table static aaaa.bbbb.cccc vlan 1 int fa0/5
S1(config)#do show mac address-table
```

> 如果需要在局域网外部对交换机进行管理, 则应该在交换机上设置网关, 就像在主机上完成的默认网关设置一样:
>
> ```sh
> Switch(config)#ip default-gateway 192.168.10.254
> Switch(config)#int vlan 1
> Switch(config-if)#ip address 192.168.10.252 255.255.255.0
> Switch(config-if)#no shut
> ```

---

## EthernetChannel

### EtherChannel

> 除了配置冗余链路并允许STP将某条链路设置为阻塞(BLK) 模式之外，我们还可以将多条链路捆绑在一起创建逻辑上的聚合，这样多条链路可以像单→链路那样工作。既然这种做法与STP一样，也可以提供同样的冗余性。
>
> - 思科的EtherChannel 版本被称为`端口聚合协议(PAgP)`；
>
> - IEEE 的端口通道协商协议的版本被称为`链路聚合控制协议(LACP)`;
>
> - 配置EtherChannel 的最为简单的方式就是使用思科网络助手(CNA)。搜索思科的网站，就可以免费下载这个GUI 软件。
>
>         但是这里使用CLI 来进行配置
>
>     ```sh
>     S1#config t
>     S1(config)#int port-channel 1
>     S1(config-if)#int range f0/1-2
>     S1(config-if-range)#switchport mode trunk
>         1d03h: %SPANTREE_FAST-7-PORT_FWD_UPLINK: VLAN0001 FastEthernet0/2
>         moved to Forwarding (UplinkFast).
>     S1(config-if-range)#switchport nonegotiate
>     S1(config-if-range)#channel-group 1 mode desirable
>     S1(config-if-range)#do sh int fa0/1 etherchannel
>         Port state = Up Sngl-port-Bndl Mstr Not-in-Bndl
>         Channel group = 1 Mode = Desirable-Sl Gcchange = 0
>         Port-channel = null GC = 0x00010001 Pseudo port-channel = Po1
>         Port index = 0 Load = 0x00 Protocol = PAgP
>         [output cut]
>     ```
>
>     ```sh
>     Core#config t
>     Core(config)#int port-channel 1
>     Core(config-if)#int range f0/7-8
>     Core(config-if-range)#switchport trunk encap dot1q
>     Core(config-if-range)#switchport mode trunk
>         1d03h: %SPANTREE_FAST-7-PORT_FWD_UPLINK: VLAN0001 FastEthernet0/2
>         moved to Forwarding (UplinkFast).
>     Core(config-if-range)#switchport nonegotiate
>     Core(config-if-range)#channel-group 1 mode desirable
>         1d04h: %SPANTREE_FAST-7-PORT_FWD_UPLINK: VLAN0001 FastEthernet0/2
>         moved to Forwarding (UplinkFast).
>         1d04h: %SPANTREE_FAST-7-PORT_FWD_UPLINK: VLAN0001 FastEthernet0/2
>         moved to Forwarding (UplinkFast).
>         1d04h: %LINK-3-UPDOWN: Interface Port-channel1, changed state to up
>         1d04h: %LINEPROTO-5-UPDOWN: Line protocol on Interface
>         Port-channel1, changed state to up
>     Core(config-if-range)#do show int port-channel 1
>         Port-channel1 is up, line protocol is up (connected)
>         Hardware is EtherChannel, address is 001b.2b55.7501 (bia 001b.2b55.7501)
>         MTU 1500 bytes, BW 200000 Kbit, DLY 100 usec,
>         reliability 255/255, txload 1/255, rxload 1/255
>         Encapsulation ARPA, loopback not set
>         Full-duplex, 100Mb/s, link type is auto, media type is unknown
>         [output cut]
>     ```
>
> > I added the `switchport nonegotiate` interface command to stop the switches from trying to autodetect the link types and also to automatically set up trunking; instead, I statically configured my trunk links. The two links between the S1 and the Core are now bundled using the Cisco EtherChannel version of PAgP.



<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622025022846.png" alt="image-20220622025022846" style="zoom:40%;" />

```shell
SW1(config)#int range e0/0 -1
SW1(config-if-range)#channel-group ?
  <1-255>  Channel group number
  auto     Enable LACP auto on this interface
  
SW1(config-if-range)#channel-group 1 mode on

SW1(config-if-range)#do sh span vlan 1
    VLAN0001
      Spanning tree enabled protocol rstp
      Root ID    Priority    32769
                 Address     aabb.cc00.1000
                 This bridge is the root
                 Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

      Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
                 Address     aabb.cc00.1000
                 Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
                 Aging Time  300 sec

    Interface           Role Sts Cost      Prio.Nbr Type
    ------------------- ---- --- --------- -------- --------------------------------
    Po1                 Desg FWD 56        128.65   Shr 
    Po2                 Desg LRN 56        128.66   Shr 
SW1#show ip int br
    Interface              IP-Address      OK? Method Status                Protocol
    Ethernet0/0            unassigned      YES unset  up                    up      
    Ethernet0/1            unassigned      YES unset  up                    up      
    Ethernet0/2            unassigned      YES unset  up                    up      
    Ethernet0/3            unassigned      YES unset  up                    up      
    Port-channel1          unassigned      YES unset  up                    up      
    Port-channel2          unassigned      YES unset  up                    up 
    
SW1#show interfaces port-channel 1  # 查看 Ethernetport 1的配置信息

SW1(config)# int port-channel 1
  switchport trunk encapsulation dot1q 
  sw mode trunk 
  int po2
  switchport trunk encapsulation dot1q 
  sw mode trunk 
  end
  
SW1#show interfaces trunk 
    Port        Mode             Encapsulation  Status        Native vlan
    Po1         on               802.1q         trunking      1
    Po2         on               802.1q         trunking      1

    Port        Vlans allowed on trunk
    Po1         1-4094
    Po2         1-4094

    Port        Vlans allowed and active in management domain
    Po1         1
    Po2         1

    Port        Vlans in spanning tree forwarding state and not pruned
    Po1         1
    Po2         1
```

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622174953723.png" alt="image-20220622174953723" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622175026977.png" alt="image-20220622175026977" style="zoom:87%;" />

> - PAgP(Port Aggregration Protocol 端口聚合协议):
>
>   -   Cisco Proprietary protocol;
>
> - LACP（Link Aggregration Control Protocol）
>
>   -   是属于IEEE规范（802.3ad, 允许将多个物理端口捆绑形成单个逻辑通道。它的功能类似于思科的以太通道协议PAgP。: Open Standard used by most of Vendors

> - ==on==
>            Mode that forces the LAN port to form Etherchannel without using negotiation protocol. In the on mode, a usable EtherChannel exists only when a LAN port group in the on mode is connected to another LAN port group in the on mode. Because ports configured in the on mode do not negotiate, there is no negotiation traffic between the ports. You cannot configure the on mode with an EtherChannel protocol. If one end uses the on mode, the other end must also.
>
>##### PAgP 协议
>
> - ==auto==: PAgP mode that places a LAN port into a passive negotiating state, in which the port responds to PAgP packets it receives but does not initiate PAgP negotiation. (Default)
> - ==desirable==: PAgP mode that places a LAN port into an active negotiating state, in which the port initiates negotiations with other LAN ports by sending PAgP packets.
>
> ##### LACP 协议
>
> - ==passive==: LACP mode that places a port into a passive negotiating state, in which the port responds to LACP packets it receives but does not initiate LACP negotiation. (Default)
>
>- ==active==: LACP mode that places a port into an active negotiating state, in which the port initiates negotiations with other ports by sending LACP packets. 
>
> 
>Reference: <https://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst4500/12-2/3-1-1SG/configuration/guide/config/channel.html>

````sh
SW2(config)#default int range e0/0-3
SW2(config)#no int po1
SW2(config)#no int po2
SW2(config)#do sh int br 

SW2(config)#int ran e0/0-3
SW2(config-if-range)#channel-group 1 mode auto
SW2#show etherchannel summary
````

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622181929981.png" alt="image-20220622181929981" style="zoom:70%;" />

# VSS & 堆叠

VSS: 虚拟交换系统, 捆绑交换机

堆叠线:

![image-20220622183035295](https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303201347142.png)
