---
title: Switching 交换
date: 2022-07-13 12:26:14
permalink: /pages/fabc03/
categories:
  - 网络运维
  - CCNA
  - CCNA知识笔记
tags:
  - 
---
# Switching 交换

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621103251967.png" alt="image-20220621103251967" style="zoom:40%;" />

>   ###### 交换机的特点:
>
>   -   网桥使用软件来创建和管理过滤表, 而交换机使用专用的集成电路(ASIC) 来创建并维护其过滤表;
>   -   Layer 2交换机等价于多端口的网桥;
>   -   隔离冲突域, 为每个终端设备提供相同的带宽;
>   -   通过检查每个接收到的数据帧的源地址，网桥和交换机完成对MAC地址的学习;
>   -   网桥和交换机都将泛洪第2层广播;
>
>   ###### 交换机的主要功能:
>
>   -   MAC地址学习: 
>
>       >   交换机通过检查每个接收到的数据帧的源地址完成对MAC地址的学习, 然后建立`MAC地址`与`交换机接口`的地址对应表`Forward/Filter MAC database`(MAC地址条目的存活时间是 5min);
>
>   -   转发和过滤数据帧(Frame):
>
>       >   当交换机的接口接收到一个数据帧时，交换机就将帧中携带的目的地址和`Forward/Filter MAC database`中的记录进行比较:
>       >
>       >   -   如果目的硬件地址是已知的，即已经被列入到MAC表中，则该帧只被发送到指定的输出接口。交换机不会将此帧发送到除目的地接口之外的任何其他接口。这一过程叫做 帧过滤;
>       >   -   如果`Forward/Filter MAC database`中没有列出目标方的MAC地址，那么此数据帧将会从除接收此帧接口之外的所有其他活动接口上泛洪出去。如果某个设备响应了被泛洪的数据帧，则交换机就会用此设备的位置(接口)信息来更新MAC地址表。
>
>   -   二层环路避免: 通过STP避免在数据链路层由于交换机之间的冗余物理链路而形成的环路; (TTL的计算中的hop是指路由器间的跳转, 即三层的跳转, 对2层及以下是透明的)
>
>       >   -   路由选择协议(如第8章介绍的RIP) 可以防止在**网络层**形成网络环路。
>       >   -   然而，对于**因交换机之间存在冗余物理链路而在数据链路层上形成的环路**，路由选择协议无能为力。网络传播的数据帧会在所有冗余链路上同时被泛洪开来，这会导致`广播风暴`和其他严重的问题。这就是开发生成树协议的原因所在，可以防止在第2层交换式网络中形成环路。



<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207081721321.png" alt="image-20220708172156171" style="zoom:80%;" />



## 交换的寻址过程

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621140831792.png" alt="image-20220621140831792" style="zoom:40%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621141319943.png" alt="image-20220621141319943" style="zoom:40%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621141355454.png" alt="image-20220621141355454" style="zoom:40%;" />



## STP生成树协议

>   STP的主要任务是防止在第2层网络中因交换机之间的物理链路冗余而导致网络环路。它警惕地监视着网络以找出所有可用链路，并关闭任何冗余链路以确保不会出现环路。STP首先使用 生成树算法(STA) 创建一个拓扑数据库，然后找出并关闭冗余链路。运行STP后，数据帧就只能在STP选定的最优链路上进行转发。

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207081848217.png" alt="image-20220708184828063" style="zoom:70%;" />

### 存在问题的网络拓扑设计

#### ==单点故障==的问题:

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621234604906.png" alt="image-20220621234604906" style="zoom:40%;" />

#### ==改进版 v1: 冗余拓扑的问题==

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621234817209.png" alt="image-20220621234817209" style="zoom:40%;" />

1.   广播风暴

     <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621235216204.png" alt="image-20220621235216204" style="zoom:40%;" />

2.   多帧复用

     ![image-20220621235411794](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621235411794.png)

3.   MAC地址紊乱

     <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621235552078.png" style="zoom:40%;" />

#### ==复杂的多环网络==:

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621235936357.png" alt="image-20220621235936357" style="zoom:40%;" />

>   由此, STP协议默认是开启的, 因为一旦存在二层环路的网络运转起来，要想找出问题的根源会超级困难!

### Spanning Tree Terms

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207101153882.png" alt="Spanning Tree » ADMIN-Magazin" style="zoom:67%;" />

>   -   `BPDU` All the switches exchange information to use in the selection of the root switch as well as in subsequent configuration of the network. Each switch compares the parameters in the **Bridge Protocol Data Unit (BPDU)** that it sends to one neighbor with the ones that it receives from other neighbors.
>   -   `Root bridge`: **The root bridge is the bridge with the best bridge ID**. With STP, the key is for all the switches in the network to elect a root bridge that becomes the focal point in the network. All other decisions in the network, such as which port is to be blocked and which port is to be put in forwarding mode are made from the perspective of this root bridge. Once a root bridge is elected on the network, all other bridges must make a single path to this root bridge. The port with the best path to the root bridge is called the root port.
>       -   `Non-root bridges` These are all bridges that are not the root bridge. Non-root bridges exchange BPDUs with all bridges and update the STP topology database on all switches, preventing loops and providing a measure of defense against link failures.
>   -   `Bridge ID` The bridge ID is how STP keeps track of all the switches in the network. It is determined by a combination of the bridge priority (32,768 by default on all Cisco switches) and the base MAC address. The bridge with the lowest bridge ID becomes the root bridge in the network.
>   -   `Port cost` Port cost determines the best path when multiple links are used between two switches. **The cost of a link is determined by the bandwidth of a link**.
>   -   `Root port` **The root port is always the link directly connected to the root bridge, or the lowest path cost to the root bridge.** If more than one link connects to the root bridge, then a port cost is determined by checking the bandwidth of each link. The lowest-cost port becomes the root port. If multiple upstream switches have the same cost, the bridge with the lower advertising bridge ID is used. When multiple links connect to the same device, the port connected to the lowest port number on the upstream switch will be used.
>   -   `Designated port` A designated port is one that has been determined as **having the best (lowest) cost to the root bridge via its root port**. A designated port will be marked as a forwarding port.
>       -   `Non-designated port` A non-designated port is one with a higher cost than the designated port. They are what’s left over after the root ports and designated ports have been determined. Non-designated ports are put in blocking mode, they are not forwarding ports.
>   -   `Forwarding port` A forwarding port forwards frames and can be a **root port** or a **designated port**.
>   -   `Blocked port` A blocked port is the port that, in order to prevent loops, will not forward frames. However, a blocked port will always listen to BPDU frames but drop any and all other frames.



### STP执行过程

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622000256029.png" alt="image-20220622000256029" style="zoom:40%;" />



>   -   STP首先选举一个根桥，根桥可以通过所有的端口完成对数据的转发(*因为根桥上的每个端口都是指定端口*)，并且它是该STP域中所有设备的参考点。
>   -   一旦所有的交换机都同意将某台交换机选为根桥，每个网桥就必须找出属于它自己的一个并且也是唯一一个分派的根端口。任意两台交换机之间的链路必须要有一个且只能有一个指定端口，该端口位于能够提供到根桥最大带宽的链路上。注意，一个网桥可以通过多个其他网桥到达根桥，也就是说这一路径可能不是最短路径，但一定是最快(具有最大带宽)路径;
>   -   那些既不是根端口也不是指定端口的端口，也就是那些非根端口和非指定端口，全部被设置为阻塞状态，这样就避免了交换环路的形成。

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622000459451.png" alt="image-20220622000459451" style="zoom:40%;" />

```shell
Switch#show spanning-tree vlan 1

VLAN0001
  Spanning tree enabled protocol rstp
  Root ID    Priority    32769
             Address     aabb.cc00.1000
             Cost        100
             Port        2 (Ethernet0/1)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
             Address     aabb.cc00.3000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time  300 sec

Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Et0/0               Altn BLK 100       128.1    Shr   # Altn 为 Blocking State
Et0/1               Root FWD 100       128.2    Shr   # Root 为 Root Port
Et0/2               Desg FWD 100       128.3    Shr   # Desg 为 Designed Port
Et0/3               Desg FWD 100       128.4    Shr 
```



#### 选举根桥

>   具有最低的Bridge ID的交换机被选为根桥

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622000654205.png" alt="image-20220622000654205" style="zoom:40%;" />

>   -   交换机向广播域内每隔2秒互相发出一个BPDU报文; 
>
>       <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622000933745.png" alt="image-20220622000933745" style="zoom:50%;" />
>
>   -   BPDU报文中的 Bridge ID最小的被选为 Root Bridge;
>
>       -   Bridge ID 由 2 Bytes的Priority 和 6 Bytes的MAC地址组成; 而默认的优先级为 32678;
>
>           ```sh
>           Switch# show spanning-tree brief
>                                                                  Hello  Max  Fwd
>               Vlan                         Bridge ID              Time  Age  Dly  Protocol
>               ---------------- --------------------------------- -----  ---  ---  --------
>               VLAN0001         32769 (32768,   1) aabb.cc00.2000    2    20   15  rstp        
>               VLAN0002         32770 (32768,   2) aabb.cc00.2000    2    20   15  rstp  
>           # 这里的 Bridge ID 实际上是由交换机和 VLAN ID 构成的生成树桥ID的信息， VLAN 1 被表示为VLAN0001，注意每个VLAN 都可以有不同的根桥。
>           ```
>
>       -   如果两个交换机的Priority值不加以修改, 则 MAC地址将决定 哪个交换机具有最低的Bridge ID;
>
>       -   Priority的取值是分散的, 以 4096 为间隔递增:
>
>           ```sh
>           #  在当前的交换机上, 设置在指定 VLAN 的生成树的 Priority值
>           Switch(config)#spanning-tree vlan 1 priority 9182
>           % Bridge Priority must be in increments of 4096.
>           % Allowed values are: 
>             0     4096  8192  12288 16384 20480 24576 28672
>             32768 36864 40960 45056 49152 53248 57344 61440
>           ```
>
>           



>   也可以直接设置指定交换机为根桥:
>
>   ```sh
>   S1(config)#spanning-tree vlan 1 root ?
>       primary Configure this switch as primary root for this spanning tree
>       secondary Configure switch as secondary root
>   S1(config)#spanning-tree vlan 1 root primary
>   ```

#### 在非根桥的交换机上选择出 Root Port

>   -   到达根桥的路径cost最小的交换机接口; 
>
>   -   Cost相等, 则比较`BPDU发送者的Bridge ID`;
>
>   -   如果一致, 则比较`BPDU发送者的端口号`(包含了 port priority和 *port ID(物理口编号)*)
>
>       ```sh
>       # 交换机端口的 Port-priority值, 取值是离散的: 0, 64, 128, 192
>       Switch(config)#int e0/1
>       Switch(config-if)#spanning-tree vlan 1 port-priority ?
>         <0-192>  port priority in increments of 64
>       ```
>
>       

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622005432148.png" alt="image-20220622005432148" style="zoom:47%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622005652213.png" alt="image-20220622005652213" style="zoom:39%;" />

#### 在每一个链路上选择出一个 Designed Port

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622020612615.png" alt="image-20220622020612615" style="zoom:40%;" />

#### 阻塞其他端口

### STP的端口状态:

>   <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622021653187.png" alt="image-20220622021653187" style="zoom:50%;" />
>
>   -   `Blocking`: A blocked port won’t forward frames; it just listens to BPDUs. The purpose of the blocking state is to prevent the use of looped paths. All ports are in blocking state by default when the switch is powered up.
>   -   `Listening`: The port listens to BPDUs to make sure no loops occur on the network before passing data frames. A port in listening state prepares to forward data frames without populating the MAC address table.
>   -   `Learning`: The switch port listens to BPDUs and learns all the paths in the switched network. A port in learning state populates the MAC address table but *still doesn’t forward data frames*. **Forward delay** means the time it takes to transition a port from listening to learning mode (or from learning to forwarding mode), which is set to 15 seconds by default and can be seen in the `show spanning-tree` output.
>   -   `Forwarding`: The port sends and receives all data frames on the bridged port. If the port is still a designated or root port at the end of the learning state, it enters the forwarding state.
>   -   `Disabled (technically not a transition state) `A port in the disabled state (administratively) does not participate in the frame forwarding or STP. A port in the disabled state is virtually non-operational.



### 交换机的端口安全:

>   ```sh
>   Switch#config t
>   Switch(config)#int f0/1
>   Switch(config-if)#switchport mode access
>   Switch(config-if)#switchport port-security ?
>    aging Port-security aging commands
>    mac-address Secure mac address
>    maximum Max secure addresses
>    violation Security violation mode
>    <cr>
>   ```
>
>   -   Since all Cisco’s latest switches ship with the ports in **desirable mode** *(the port desires to trunk if it senses another switch just connected)*, we must first change the port from desirable mode to `access mode` or we cannot configure port security. Once that is done, we can continue on with our port-security commands.
>
>   -   You can see clearly in the preceding output that the switch port port-security command can be used with four options:
>
>       -   `switchport port-security mac-address`: to assign individual MAC addresses to each switch port, but if you choose to go there, you’d better have a lot of time on your hands!
>
>       -   如果需要将交换机的端口设置为，每个端口只允许接入一台主机，并且当有人破坏这一规则时，
>           端口就会关闭，那么，完成这样的配置可以使用下列命令:
>
>           ```sh
>           Switch(config-if)#switchport port-security maximum 1
>           Switch(config-if)#switchport port-security violation shutdown
>           ```
>
>           >   一旦这种情况发生，只能在交换机上手工使用`no shutdown`命令来恢复端口的启用。
>
>       -   接入"stick" 端口的前两个地址被认定为静态地址，并且不管在aging命令中设置了多长时间，它们一直会是静态地址。为什么这里要将它设置为2 呢?这是因为其中一个地址将用于PC机，而另一个用于电话机。
>
>           ```sh
>           Switch(config-if)#switchport port-security maximum 2
>           Switch(config-if)#switchport port-security mac-address sticky
>           Switch(config-if)#switchport port-security violation shutdown
>           ```



### STP的收敛(Convergence)

>   -   Convergence occurs when all ports on bridges and switches have transitioned to either forwarding or blocking modes. No data will be forwarded until convergence is complete. Yes—you read that right: When STP is converging, all host data stops transmitting!
>
>   -   By creating your physical switch design in a hierarchical manner, as shown in Figure, you can make your Core switch the STP root, which will then make STP convergence time nice and quick.
>
>   ![image-20220709164505688](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207092051674.png)

#### STP的 Portfast模式

>   在交换机端口上，从`Blocking状态`到`Forwarding状态`的典型的生成树拓扑的收敛时间通常需要50秒，这样在服务器或主机上就会引发超时的问题，比如，在重启交换机的时候。针对这样的问题，可以在接入层的交换机端口上开启`Portfast`来**禁用STP协议**。
>
>   -   PortFast一般需要在access layer的交换机的接口开启. 之后插入终端设备后只需要 1s 左右就可以连通网络

```sh
# 设置所有接口为 Portfast
Switch(config)#spanning-tree portfast ? 
  edge     Spanning tree portfast edge options
  network  Spanning tree portfast network options
  normal   Spanning tree portfast normal options
  
# 设置指定接口为 portfast
Switch(config)#int range fastEthernet 0/1 - 12
Switch(config-if)#spanning-tree portfast ?
    disable Disable portfast for this interface
    trunk Enable portfast on the interface even in trunk mode
    <cr>
Switch(config-if-range)#spanning-tree portfast

```

##### 两种Safeguard模式可搭配Portfast使用:

###### BPDUguard: 

>   当access layer的交换机的指定接口开启 BPDUguard 后, 当此接口插入交换机(接收到BPDU报文)就会变成err-down状态
>
>   ```shell
>   Switch(config)#int e0/3
>   Switch(config-if)#spanning-tree bpduguard ?
>     disable  Disable BPDU guard for this interface
>     enable   Enable BPDU guard for this interface
>   ```
>

###### bpdufilter:

>   当access layer的交换机的指定接口开启 bpdufilter 之后, 如果BPDUFilter 接收到了一个BPDU ，它会立即关闭端口的PortFast ，并迫使端口重新成为STP拓扑的一部分.
>
>   ```sh
>   Switch(config-if)#spanning-tree bpdufilter ?
>     disable  Disable BPDU filtering for this interface
>     enable   Enable BPDU filtering for this interface
>   ```
>

#### UplinkFast

>   UplinkFast 是思科产品特有的特性，两个交换机之间有2条以上的直连物理链路, 当主链路失效时, 在备份链路的阻塞端口可以立即工作, 就不用再等待通常STP收敛所需要的50秒的时间。
>
>   ```sh
>   S2#config t
>   S2(config)#spanning-tree uplinkfast
>   S1(config)#do show spanning-tree uplinkfast
>   UplinkFast is enabled
>   Station update rate set to 150 packets/sec.
>   UplinkFast statistics
>   -----------------------
>   Number of transitions via uplinkFast (all VLANs) : 1
>   Number of proxy multicast addresses transmitted (all VLANs) : 8
>   Name Interface List
>   -------------------- ------------------------------------
>   VLAN0001 Fa0/1(fwd), Fa0/2
>   S1(config)#
>   ```



#### BackboneFast

>   -   Unlike UplinkFast(*which is used to determine and quickly fix link failures on the local switch*), another Cisco-proprietary STP extension called BackboneFast is used for speeding up convergence when a link *that’s not directly connected to the switch* fails. If a switch running BackboneFast receives an **inferior BPDU** from its designated bridge, it knows that a link on the path to the root has failed. Just to make sure you’re clear on this, an *inferior BPDU is one that lists the same switch for the root bridge and the designated bridge*.
>   -   And again, unlike UplinkFast(*which is only configured on Access layer switches or switches with redundant links and at least one link in blocking mode*), BackboneFast should be enabled on **all Catalyst switches** to allow for detection of indirect link failures. 
>   -   Enabling BackboneFast is also beneficial because it starts the spanning tree reconfiguration more quickly—it can save 20 seconds on the default 50-second STP convergence time.
>   -   默认情况下， BackboneFast 会将默认优先级提高到49152。
>
>   ```sh
>   S1(config)#spanning-tree backbonefast
>   S2(config)#spanning-tree backbonefast
>   Core(config)#spanning-tree backbonefast
>   S2(config)#do show spanning-tree backbonefast
>       BackboneFast is enabled
>       BackboneFast statistics
>       -----------------------
>       Number of transition via backboneFast (all VLANs) : 0
>       Number of inferior BPDUs received (all VLANs) : 2
>       Number of RLQ request PDUs received (all VLANs) : 0
>       Number of RLQ response PDUs received (all VLANs) : 1
>       Number of RLQ request PDUs sent (all VLANs) : 1
>       Number of RLQ response PDUs sent (all VLANs) : 0
>   S2(config)#
>   ```
>
>   >   与配置UplinkFast不同，此处我们对网络中的所有交换机都进行了BackboneFast配置，而不只限于接入层交换机。
>   >
>   >   -   记住，BackboneFast 用来确定远程交换机上非直接连接到根路径的链路失效，这与UplinkFast不同， 
>   >   -   UplinkFast可以确定并快速修复本地交换机的链路失效。



#### RSTP

>   Rapid Spanning Tree Protocol (RSTP) 802.1w
>
>   -   思科创建了PortFast 、UplinkFast 和BackboneFast 来"修补" IEEE 802.1d 标准中的漏洞和缺陷。
>   -   但这些改进特性的不足之处在于，它们都是思科专用的，还需要进行额外的配置。但新的802.1w 标准(RSTP) 将所有这些"问题"都一并解决了，你需要做的就只是打开RSTP. 有一点很重要，即必须确保网络中所有的交换机都能正确地运行802.1w 协议。
>   -   It might come as a surprise, but RSTP actually can interoperate with legacy STP protocols. -Just know that the inherently fast convergence ability of 802.1w is lost when it interacts with legacy bridges. 并且, 即使legacy bridges后来又配置了802.1w, 这些RSTP交换机也不能自动切换回802.1w, 而是继续发送 802.1d BPDU; 需要重启该交换机才可以.
>
>   ```sh
>   Core#config t
>   Core(config)#spanning-tree mode ?
>       mst Multiple spanning tree mode
>       pvst Per-Vlan spanning tree mode
>       rapid-pvst Per-Vlan rapid spanning tree mode
>   Core(config)#spanning-tree mode rapid-pvst
>   Core(config)#
>       1d02h: %LINEPROTO-5-UPDOWN: Line protocol on Interface Vlan1,
>       changed state to down
>       1d02h: %LINEPROTO-5-UPDOWN: Line protocol on Interface Vlan1,
>       changed state to up
>       
>   Core(config)#do show spanning-tree
>   VLAN0001
>   	Spanning tree enabled protocol rstp  # rapid-pvst
>   	Root ID Priority 32769
>           Address 000d.29bd.4b80
>           This bridge is the root
>           Hello Time 2 sec Max Age 20 sec Forward Delay 15 sec
>       Bridge ID Priority 32769 (priority 32768 sys-id-ext 1)
>           Address 000d.29bd.4b80
>           Hello Time 2 sec Max Age 20 sec Forward Delay 15 sec
>           Aging Time 300
>   
>       Interface 	Role Sts 	Cost Prio.Nbr 	Type
>       ---------------- ---- --- --------- -------- ------------
>       Fa0/5 		Desg FWD 	19 	128.5 		P2p Peer(STP)
>       Fa0/6 		Desg FWD 	19 	128.6 		P2p Peer(STP)
>       Fa0/7 		Desg FWD 	19 	128.7 		P2p Peer(STP)
>       Fa0/8 		Desg FWD 	19 	128.8 		P2p Peer(STP)
>   ```



### EtherChannel

>   除了配置冗余链路并允许STP将某条链路设置为阻塞(BLK) 模式之外，我们还可以将多条链路捆绑在一起创建逻辑上的聚合，这样多条链路可以像单→链路那样工作。既然这种做法与STP一样，也可以提供同样的冗余性。
>
>   -   思科的EtherChannel 版本被称为`端口聚合协议(PAgP)`；
>
>   -   IEEE 的端口通道协商协议的版本被称为`链路聚合控制协议(LACP)`;
>
>   -   配置EtherChannel 的最为简单的方式就是使用思科网络助手(CNA)。搜索思科的网站，就可以免费下载这个GUI 软件。
>
>       但是这里使用CLI 来进行配置
>
>   ```sh
>   S1#config t
>   S1(config)#int port-channel 1
>   S1(config-if)#int range f0/1-2
>   S1(config-if-range)#switchport mode trunk
>       1d03h: %SPANTREE_FAST-7-PORT_FWD_UPLINK: VLAN0001 FastEthernet0/2
>       moved to Forwarding (UplinkFast).
>   S1(config-if-range)#switchport nonegotiate
>   S1(config-if-range)#channel-group 1 mode desirable
>   S1(config-if-range)#do sh int fa0/1 etherchannel
>       Port state = Up Sngl-port-Bndl Mstr Not-in-Bndl
>       Channel group = 1 Mode = Desirable-Sl Gcchange = 0
>       Port-channel = null GC = 0x00010001 Pseudo port-channel = Po1
>       Port index = 0 Load = 0x00 Protocol = PAgP
>       [output cut]
>   ```
>
>   ```sh
>   Core#config t
>   Core(config)#int port-channel 1
>   Core(config-if)#int range f0/7-8
>   Core(config-if-range)#switchport trunk encap dot1q
>   Core(config-if-range)#switchport mode trunk
>       1d03h: %SPANTREE_FAST-7-PORT_FWD_UPLINK: VLAN0001 FastEthernet0/2
>       moved to Forwarding (UplinkFast).
>   Core(config-if-range)#switchport nonegotiate
>   Core(config-if-range)#channel-group 1 mode desirable
>       1d04h: %SPANTREE_FAST-7-PORT_FWD_UPLINK: VLAN0001 FastEthernet0/2
>       moved to Forwarding (UplinkFast).
>       1d04h: %SPANTREE_FAST-7-PORT_FWD_UPLINK: VLAN0001 FastEthernet0/2
>       moved to Forwarding (UplinkFast).
>       1d04h: %LINK-3-UPDOWN: Interface Port-channel1, changed state to up
>       1d04h: %LINEPROTO-5-UPDOWN: Line protocol on Interface
>       Port-channel1, changed state to up
>   Core(config-if-range)#do show int port-channel 1
>       Port-channel1 is up, line protocol is up (connected)
>       Hardware is EtherChannel, address is 001b.2b55.7501 (bia 001b.2b55.7501)
>       MTU 1500 bytes, BW 200000 Kbit, DLY 100 usec,
>       reliability 255/255, txload 1/255, rxload 1/255
>       Encapsulation ARPA, loopback not set
>       Full-duplex, 100Mb/s, link type is auto, media type is unknown
>       [output cut]
>   ```
>
>   >    I added the `switchport nonegotiate` interface command to stop the switches from trying to autodetect the link types and also to automatically set up trunking; instead, I statically configured my trunk links. The two links between the S1 and the Core are now bundled using the Cisco EtherChannel version of PAgP.



### 验证思科交换机的配置

```sh
show running-config   # 路由器或者交换机上都可以使用, 可以了解整个设备的运行配置
show mac address-table  # 显示转发过滤表
show spanning-tree  # 可以了解到根桥的MAC地址，以及每个VLAN所设置的优先级。
```



```sh
Switch#show spanning-tree ?    
  WORD               bridge group list, example 1,3-5,7,9
  active             Report on active interfaces only
  backbonefast       Show spanning tree backbonefast status
  blockedports       Show blocked ports
  bridge             Status and configuration of this bridge
  detail             Detailed information
  inconsistentports  Show inconsistent ports
  interface          Spanning Tree interface status and configuration
  mst                Multiple spanning trees
  pathcost           Show Spanning pathcost options
  root               Status and configuration of the root bridge
  summary            Summary of port states
  uplinkfast         Show spanning tree uplinkfast status
  vlan               VLAN Switch Spanning Trees
  |                  Output modifiers
```

```shell
Switch#show spanning-tree summary 
    Switch is in rapid-pvst mode
    Root bridge for: VLAN0001-VLAN0005
    Extended system ID                      is enabled
    Portfast Default                        is disabled
    Portfast Edge BPDU Guard Default        is disabled
    Portfast Edge BPDU Filter Default       is disabled
    Loopguard Default                       is disabled
    PVST Simulation Default                 is enabled but inactive in rapid-pvst mode
    Bridge Assurance                        is enabled
    EtherChannel misconfig guard            is enabled
    Configured Pathcost method used is short
    UplinkFast                              is disabled
    BackboneFast                            is disabled

    Name                   Blocking Listening Learning Forwarding STP Active
    ---------------------- -------- --------- -------- ---------- ----------
    VLAN0001                     0         0        0          4          4
    VLAN0002                     0         0        0          2          2
    VLAN0003                     0         0        0          2          2
    VLAN0004                     0         0        0          2          2
    VLAN0005                     0         0        0          2          2
```



```sh
# 设置静态的MAC地址条目
S1#config t
S1(config)#mac-address-table static aaaa.bbbb.cccc vlan 1 int fa0/5
S1(config)#do show mac address-table
```

>   如果需要在局域网外部对交换机进行管理, 则应该在交换机上设置网关, 就像在主机上完成的默认网关设置一样:
>
>   ```sh
>   Switch(config)#ip default-gateway 192.168.10.254
>   Switch(config)#int vlan 1
>   Switch(config-if)#ip address 192.168.10.252 255.255.255.0
>   Switch(config-if)#no shut
>   ```



## VLAN

### 概述

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621141811827.png" alt="image-20220621141811827" style="zoom:40%;" />

>   在纯粹的交换型互联网络中, 如何划分广播域呢? 答案是创建VLAN(虚拟局域网). VLAN是一个网络用户和网络资源的逻辑编组, 它们与管理者定义的交换机端口相连. 通过在交换机上创建VLAN, 可以指定交换机端口为不同的子网提供服务, 从而在二层交换型网络中创建更小的广播域.
>
>   -   默认情况下, 一台交换机的所有接口都属于同一个广播域;
>
>   -   VLAN技术可以把交换机的接口在==数据链路层==上将整个广播域(LAN)划分成若干个VLAN; 
>   -   划分后,VLAN之间是互相隔离的, VLAN之间在二层设备上无法互相通信, 必须经由三层设备(路由器)才可以互通;

#### VLAN的成员模式

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621143523960.png" alt="image-20220621143523960" style="zoom:40%;" />

>   -   `静态VLAN` 易于配置和管理，非常适合用于需要控制所有用户移动的网络环境; 是创建VLAN最常用的方法，其原因之一是静态VLAN最安全。
>   -   `动态VLAN` 通过使用**VLAN管理策略服务器(VMPS)**，可根据硬件(MAC)地址、协议甚至创建动态VLAN 的应用程序来确定所连接的交换机端口所属的VLAN。VMPS数据库将MAC地址映射到VLAN。在同一台交换机中，可以同时有动态接入端口和中继端口，但动态接入端口只能连接到终端或集线器，而不能连接到其他交换机!

#### VLAN ID

![image-20220709205119792](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207092051943.png)

>   由于每个VLAN都是一个广播域, 因此他们也有自己的子网号; 如果使用的是IPv6. 则必须给每个VLAN分配独立的IPv6网络号.

>   ==VLAN 1的特性==:
>
>   -   VLAN 1 是一个管理VLAN(管理数据流，如CDP， PAgP、LACP， DTP和VTP), 虽然也可将其用于工作组, 但思科建议只将其用于管理; 
>   -   VLAN 1是默认的Native VLAN, 无法删除, 也无法修改其名称; 
>   -   默认情况下, 所有的交换机端口都属于VLAN 1;

#### Identifying VLANs

>   -   交换机端口是第二层接口, 这种接口与物理端口相关联;
>   -   交换机端口为`access port`时, 只能属于一个VLAN; 而为`trunk port`时, 属于所有的VLANS;
>   -   可手工将端口配置为`access port`或`trunk port`, 也可在每个端口上运行动态中继协议(DTP), DTP通过与链路另一端的端口协商来设置端口模式

>   在交换环境中，存在三种类型的端口:
>
>   -   `Access port`: **An access port belongs to and carries the traffic of only one VLAN**. Traffic is both received and sent in **native formats with no VLAN tagging** whatsoever. Anything arriving on an access port is simply assumed to belong to the VLAN assigned to the port.
>
>       -   与`Access Port`相连的设备没有VLAN成员资格的概念，只是认为自己是某个广播域的一员, 没有全局意识，根本不了解物理网络拓扑。
>       -   将帧转发给与`Access Port`相连的终端设备前，交换机将删除所有的VLAN信息。 
>
>       >   So, what do you think will happen if an access port receives a *tagged packet, like IEEE 802.1Q tagged*? 
>       >
>       >   -   Right—*that packet would simply be dropped*. But why? Well, because an access port doesn’t look at the source address, so tagged traffic can be forwarded and received only on trunk ports.
>
>   -   `Voice access ports`: 这是一种特殊的`Access port`; 前面一直说接入端口只能属于一个VLAN，但这种说法不完全正确。当前，大多数交换机都允许将接入端口分配给另一个VLAN，以便传输语音数据流，这种VLAN被称为语音VLAN。语音VLAN过去被称为辅助VLAN，它可以与数据VLAN重叠，允许同一个端口同时传输语音和数据。虽然从技术上说，这属于不同类型的链路，但它仍然只是一种接入端口，只是能够配直的同时为语音VLAN 和数据VLAN传输数据流。这让你能够将电话和PC同时连接到同一个交换机棉口，并让它们属于不同的VLAN。在本章后面的11.8节，将详细介绍语音VLAN。
>
>   -   `trunk port`: trunk ports can carry multiple VLANs at a time; 位于交换机之间、交换机和路由器之间或交换机和服务器之间，它同时为多个(1-4094个，但除非使用扩展VLAN，否则最多为1005个)VLAN传输数据流。
>
>       -   可让一个端口同时属于众多不同的VLAN, 比如可让同一台服务器属于两个不同的广播域，这样用户无需通过第3层设备(路由器)就能登录或访问它;
>       
>       -   另一个优点表现在交换机之间的Trunk连接。中继链路可传输来自多个VLAN的帧。
>       
>           <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207101256426.png" alt="image-20220710125650266" style="zoom:80%;" />

#### Frame Tagging

>   ​	It can get kind of complicated—even for a switch—so there needs to be a way for each one to keep track of all the users and frames as they travel the **switch fabric** and VLANs. *When I say “switch fabric,” I’m just referring to a group of switches that share the same VLAN information.* And this just happens to be where frame tagging enters the scene. This frame identification method uniquely assigns a user-defined VLAN ID to each frame. Sometimes people refer to it as a **VLAN ID** or even **VLAN color**.
>
>   ​	Here’s how it works: Once within the switch fabric, each switch that the frame reaches must first identify the VLAN ID from the frame tag. It then finds out what to do with the frame by looking at the information in what’s known as the **filter table**. If the frame reaches a switch that has another trunked link, the frame will be forwarded out the trunk-link port.
>   ​	Once the frame reaches an exit that’s determined by the **forward/filter table to be an access link** matching the frame’s VLAN ID, the switch will remove the VLAN identifier. This is so the destination device can receive the frames without being required to understand their VLAN identification information.
>   ​	Another thing about **trunk ports is that they will support tagged and untagged traffic simultaneously (if you are using 802.1Q trunkin**g, which we will talk about later). 
>
>   ​	==The trunk port is assigned a default port VLAN ID (PVID) for a VLAN on which all untagged traffic will travel. This VLAN is also called the **native VLAN** and is always **VLAN 1** by default (but it can be changed to any VLAN number).== 

#### VLAN Identification Methods

>   -   ==Inter-Switch Link (ISL)==: 思科专用协议
>
>       -   交换机间链路(ISL)是一种显式标记方法，它在以太网帧中添加VLAN信息。这些标记信息允许利用外部标记方法在中继链路上多路复用多个VLAN的数据流，从而让交换机确定通过中继链路收到的帧属于哪个VLAN 。
>
>       -   通过使用ISL，可连接多台交换机，并在数据流通过中继链路在交换机之间传输时保留VLAN信息。ISL 运行在第2层，它使用新的报头和循环冗余校验(CRC)封装数据帧。
>
>       -   需要注意的是，这是一种思科专用协议，只能用于快速以太网和吉比特以太网链路。ISL可用于交换机端口、路由器接口和服务器接口卡。
>
>       -   思科的专有协议ISL, 但是存在一些问题, 所以思科已经开始放弃了这个协议
>
>           <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621183600780.png" alt="image-20220621183600780" style="zoom:40%;" />
>
>   -   ==IEEE 802.1Q==:
>
>       -   IEEE802.1Q 是IEEE 制定的一种帧标记标准，它在帧中插入一个字段，用于标识VLAN。在思科交换机和其他品牌的交换机之间中继时，必须使用802.1Q。
>
>       -   其工作原理如下:首先指定中继端口，并指定它使用802.1Q封装。为让这些端口能够通信，必须指定它们所属的VLAN。默认的Native VLAN为VLAN 1，使用802.1Q时，不会对Native VLAN数据流进行标记。中继链路两端的端口根据Native VLAN组成一个小组，并使用相应的标识号(默认为VLAN 1)
>
>       -   802.1Q 帧标记
>
>           <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621184009736.png" alt="image-20220621184009736" style="zoom:40%;" />
>
>           >   -   FCS(Frame Check Sum)会重新计算;
>           >
>           >   -   Tag 有 4个Bytes:
>           >       -   2 Bytes的EtherType;
>           >       -   3 bits的PRI字段, 用于流量控制;
>           >       -   1 bit的CFI字段, 用于令牌网络, 目前基本淘汰, 置零;
>           >       -   12 bits的VLAN ID字段

### VLAN的基本配置

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621144559529.png" alt="image-20220621144559529" style="zoom:40%;" />

![image-20220621153512606](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621153512606.png)

>   -   不能修改、删除或重命名VLAN1 ，因为它是默认的Native VLAN; 交换机的所有端口默认都属于VLAN 1;
>   -   编号大于1005的VLAN称为扩展VLAN，除非交换机处于VTP透明模式，否则它们不会被启用;

#### VLAN的创建, 重命名, 删除: 

```shell
SW1(config)#vlan 2  # 创建 VLAN 2
SW1(config)#vlan 3-10   # 连续地创建 编号为 3~10, 一共8个 VLAN
SW1(config)#vlan 11,13,15,17  # 创建指定编号的 VLAN

SW1(config-vlan)#name VLAN的名字    # 自定义 当前VLAN的名字
SW1(config-vlan)#end
SW1(config)#do show vlan brief   # 查看vlan配置

SW1(config)#no vlan 3-10,11,13,15,17   # 删除指定的VLAN, 也支持批量删除
```

#### 为指定VLAN分配IP地址块

```sh
SW1#config t
SW1(config)#int vlan 1
SW1(config-if)#ip address 172.16.10.2 255.255.255.128
SW1(config-if)#no shutdown
```

#### 设置端口为 access 模式并分配给指定的VLAN:

```sh
SW1(config)#int e0/0
SW1(config-if)#switchport ?
  access         Set access mode characteristics of the interface  # 承载单个VLAN
  autostate      Include or exclude this port from vlan link up calculation
  dot1q          Set interface dot1q properties
  host           Set port host
  mode           Set trunking mode of the interface
  nonegotiate    Device will not engage in negotiation protocol on this
                 interface
  port-security  Security related command 
  private-vlan   Set the private VLAN configuration
  protected      Configure an interface to be a protected port
  trunk          Set trunking characteristics of the interface  # 承载多个VLAN的数据
  voice          Voice appliance attributes
  <cr>
SW1(config-if)#switchport mode ?
  access        Set trunking mode to ACCESS unconditionally
  dot1q-tunnel  set trunking mode to TUNNEL unconditionally
  dynamic       Set trunking mode to dynamically negotiate access or trunk mode
  private-vlan  Set the mode to private-vlan host or promiscuous
  trunk         Set trunking mode to TRUNK unconditionally
  
SW1(config-if)#switchport mode access
SW1(config-if)#switchport access vlan 2  # 将当前的接口配置到指定的VLAN
SW1#show vlan brief   
    VLAN Name                             Status    Ports
    ---- -------------------------------- --------- -------------------------------
    1    default                          active    Et0/1, Et0/2, Et0/3
    2    CCNA                             active    Et0/0
    1002 fddi-default                     act/unsup 
    1003 token-ring-default               act/unsup 
    1004 fddinet-default                  act/unsup 
    1005 trnet-default                    act/unsup 
```

>   ```sh
>   SW1(config-if)#switchport mode ?
>     access        Set trunking mode to ACCESS unconditionally
>     dot1q-tunnel  set trunking mode to TUNNEL unconditionally
>     dynamic       Set trunking mode to dynamically negotiate access or trunk mode
>     private-vlan  Set the mode to private-vlan host or promiscuous
>     trunk         Set trunking mode to TRUNK unconditionally
>   ```
>
>   -   `switchport mode access`: The interface becomes a nontrunk interface regardless of whether the neighboring interface is a trunk interface. The port would be a dedicated layer 2 access port.
>
>   -   `switchport mode trunk`: The interface becomes a trunk interface even if the neighboring interface isn’t a trunk interface.
>
>   -   `switchport nonegotiate`: Prevents the interface from generating DTP frames. You can use this command only when the interface switchport mode is access or trunk. You must manually configure the neighboring interface as a trunk interface to establish a trunk link.
>
>       >   **Dynamic Trunking Protocol (DTP)** is used for negotiating trunking on a link between two devices, as well as negotiating the encapsulation type of either 802.1Q or ISL. I use the nonegotiate command when I want dedicated trunk ports no questions asked.
>
>   -   `switchport mode dynamic auto`: This mode makes the interface able to convert the link to a trunk link. The interface becomes a trunk interface if the neighboring interface is set to trunk or desirable mode. The default is dynamic auto now.
>
>   -   `switchport mode dynamic desirable`: This one makes the interface actively attempt to convert the link to a trunk link. The interface becomes a trunk interface if the neighboring interface is set to trunk, desirable, or auto mode.



将接口设置加入未预先创建的VLAN:

```sh
SW2(config-if)#switchport access vlan 2
% Access VLAN does not exist. Creating vlan 2    # VLAN不存在时, 会自动创建
SW1(config-if)#switchport mode access
```

一次性设置多个接口加入同一个VLAN:

```sh
SW2(config)#interface range e0/0 - 3
SW2(config-if-range)# switchport mode access
SW2(config-if-range)#sw acc vlan 3
% Access VLAN does not exist. Creating vlan 3
SW2(config-if-range)#end
SW2#sh vlan brief
    VLAN Name                             Status    Ports
    ---- -------------------------------- --------- -------------------------------
    1    default                          active    
    2    VLAN0002                         active    
    3    VLAN0003                         active    Et0/0, Et0/1, Et0/2, Et0/3

```

#### 设置端口为 Trunk模式

>   不同的交换机上承载多个VLAN, 则需要将接口设置为 `Trunk模式`;

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621183139837.png" alt="image-20220621183139837" style="zoom:40%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621194813412.png" alt="image-20220621194813412" style="zoom:50%;" />

##### 基本Trunk配置

```sh
# 1.配置 Trunk 的封装方式(使用的协议):
SW1(config-if)#switchport trunk encapsulation ?
  dot1q      Interface uses only 802.1q trunking encapsulation when trunking
  isl        Interface uses only ISL trunking encapsulation when trunking
  negotiate  Device will negotiate trunking encapsulation with peer on
             interface       
SW1(config-if)#switchport trunk encapsulation dot1q 

# 2.开启接口的Trunk模式:
SW1(config-if)#switchport mode trunk 

SW1(config)#show int trunk  # 查看本交换机上的trunk端口
```

##### 限定中继端口支持的VLAN

>   默认情况下，中继端口发送和接收来自所有VLAN 的信息，并将未标记的帧发送到管理VLAN。这也适用于扩展VLAN。
>
>   然而也可以在端口上限定哪些VLAN禁止通过Trunk端口:
>
>   ```sh
>   S1#config t
>   S1(config)#int f0/1
>   S1(config-if)#switchport trunk allowed vlan ?
>       WORD 	VLAN IDs of the allowed VLANs when this port is in trunking mode
>       add 	add VLANs to the current list
>       all 	all VLANs
>       except 	all VLANs except the following
>       none 	no VLANs
>       remove 	remove VLANs from the current list
>   S1(config-if)#switchport trunk allowed vlan remove ?
>   	WORD VLAN IDs of disallowed VLANS when this port is in trunking mode
>   S1(config-if)#switchport trunk allowed vlan remove 4-8
>   
>   # 将VLAN 排除在外后，要恢复到默认设置，可使用下述命令:
>   S1(config-if)#sw;tchport trunk allowed vlan all
>   # 也可使用如下命令:
>   S1(config-if)#no switchport trunk allowed vlan
>   ```

##### 修改指定端口的Native Vlan

>   ```sh
>   S1#config t
>   S1(config)#int f0/1
>   S1(config-if)#switchport trunk ?
>       allowed Set allowed VLAN characteristics when interface is in trunking mode
>       native Set trunking native characteristics when interface is in trunking mode
>       pruning Set pruning VLAN characteristics when interface is in trunking mode
>   S1(config-if)#switchport trunk native ?
>   vlan Set native VLAN when interface is in trunking mode
>   S1(config-if)#switchport trunk native vlan ?
>   <1-4094> VLAN ID of the native VLAN when this port is in
>   trunking mode
>   S1(config-if)#switchport trunk native vlan 40
>   S1(config-if)#^Z
>   ```
>
>   -   实际上，不需要修改中继端口的本机VLAN，但可以这样做，有些人处于安全考虑而这样做。
>
>   -   将中继端口的本地VLAN改为VLAN 40后，使用命令show running-cofig 查看该中继接口的配置;
>
>   -   如果中继链路两端的交换机端口的Native VLAN 不同, 两个端口将无法通信:
>
>       -   要么修改中继链路另一端的native VLAN
>
>       -   要么将当前端口的本机VLAN 恢复到默认设置:
>
>           ```sh
>           Sl(config-if)#no switchport trunk native vlan
>           ```
>
>           



### VTP

>   VLAN Trunk Protocol, Cisco created this one too. 
>
>   -   The basic goals of VLAN Trunking Protocol (VTP) are to **manage all configured VLANs across a switched internetwork and to maintain consistency** throughout that network. VTP allows you to add, delete, and rename VLANs—information that is then propagated to all other switches in the VTP domain.
>   -   Here’s a list of some of the **cool features** VTP has to offer:
>       -   Consistent VLAN configuration across all switches in the network
>       -   VLAN trunking over mixed networks, such as Ethernet to ATM LANE or even FDDI
>       -   Accurate tracking and monitoring of VLANs
>       -   Dynamic reporting of added VLANs to all switches in the VTP domain
>       -   Adding VLANs using Plug and Play(以即插即用的方式)



<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621195238427.png" alt="image-20220621195238427" style="zoom:40%;" />

>   VTP(VLAN Trunking Protocol): (思科专有协议), 在多个交换机之间同步VLAN配置信息的协议, 
>
>   -   通过一个共有的管理域, 维持所有交换机的VLAN配置(借助修订号 Configuration Revision)的一致性;
>   -   交换机间互相的接口要设置为Trunk模式, 即VTP只能在*Trunk端口发送*要宣告的信息;
>   -   支持混合的介质主干连接(Fast Ethernet, FDDI, ATM)

#### 交换机的三种VTP模式 

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621195404942.png" alt="image-20220621195404942" style="zoom:40%;" />

>   -   ==Server==: 
>
>       -   This is the **default mode** for all Catalyst switches;
>       -   at least one server in your VTP domain to propagate VLAN information throughout that domain;
>       -   The switch must be in server mode to be able to create, add, and delete VLANs in a VTP domain;
>       -   In VTP server mode, VLAN configurations are **saved in NVRAM** on the switch.
>
>   -   ==Client:==
>
>       -   In client mode, switches receive information from VTP servers, but they also receive and forward updates;
>       -   they can’t create, change, or delete VLANs.
>       -   VLAN information received from a VTP server isn’t stored in NVRAM
>
>       >   Here’s a hint: If you want a switch to become a server, first make it a client so it receives all the correct VLAN information, then change it to a server — so much easier!
>
>   -   ==Transparent==: 
>
>       -   Switches in transparent mode don’t participate in the VTP domain or share its VLAN database, but they’ll still forward VTP advertisements through any configured trunk links. 
>       -   They can create, modify, and delete VLANs because they keep their own database — one they keep secret from the other switches.
>       -   Despite being kept in NVRAM, the VLAN database in transparent mode is actually only locally significant. 
>       -   The whole purpose of transparent mode is to **allow remote switches to receive the VLAN database from a VTP server-configured switch through a switch that is not participating in the same VLAN assignments**.

>   **VTP only learns about normal-range VLANs, with VLAN IDs 1 to 1005**; *VLANs with IDs greater than 1005 are called extended-range VLANs and they’re not stored in the VLAN database*. The switch must be in VTP transparent mode when you create VLAN IDs from 1006 to 4094, so it would be pretty rare that you’d ever use these VLANs. One other thing: VLAN IDs 1 and 1002 to 1005 are automatically created on all switches and can’t be removed.

#### VTP的运行模式

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621195839843.png" alt="image-20220621195839843" style="zoom:40%;" />

>   多台交换机配置VTP，必须满足如下三项要求:
>
>   -   交换机的VTP domain name要相同;
>   -   其中一台交换机要配置为VTP Server;(事实上，思科建议让所有交换机都处于VTP服务器模式)
>   -   VTP password要一致(如果使用了的话)。

#### VTP的基本配置

```sh

S1(config)#vtp mode ?
  client       Set the device to client mode.
  off          Set the device to off mode.
  server       Set the device to server mode.
  transparent  Set the device to transparent mode.
  
S1(config)#vtp domain VTP域名    # 设置VTP域名
S1(config)#vtp password VTP密码
S1(config)#vtp pruning


S1#show vtp password
S1#show vtp status   # 查看 VTP 的配置
```

>   ==Tips==:
>
>   1.   所有思科交换机默认的VTP模式是 Server;
>   2.   VTP的域名和密码均对大小写敏感;
>   3.   VTP pruning 默认是关闭的;

```sh
R2#show vtp status
VTP Version capable             : 1 to 3
VTP version running             : 1
VTP Domain Name                 : CCNA-1
VTP Pruning Mode                : Disabled
VTP Traps Generation            : Disabled
Device ID                       : aabb.cc80.2000
Configuration last modified by 0.0.0.0 at 6-21-22 21:17:01

Feature VLAN:
--------------
VTP Operating Mode                : Client
Maximum VLANs supported locally   : 1005
Number of existing VLANs          : 15
Configuration Revision            : 5      # 此为 修订号
MD5 digest                        : 0x1F 0x23 0x1C 0x58 0xCB 0xA7 0x43 0x03 
                                    0x6F 0x6E 0x10 0x54 0x1E 0x91 0xAC 0xEC 
```

#### VTP pruning

>   -   默认情况下，所有VLAN 的数据流都可通过中继链路进行传输;
>   -   VTP Pruning可以自动修剪开不参与VLAN配置同步的交换机链路; VTP gives you a way to preserve bandwidth by configuring it to reduce the amount of broadcasts, multicasts, and unicast packets. This is called **pruning**. Switches enabled for VTP pruning send broadcasts only to *trunk links* that actually must have the information.
>   -   默认情况下，所有交换机都禁用了VTP修剪; 在VTP服务器上启用修剪后，将在整个VTP域中启用它。
>   -   默认情况下，修剪将用于VLAN 2-1001, 但对VLAN 1不会修剪，因为它是一个管理VLAN.

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621232836287.png" alt="image-20220621232836287" style="zoom:50%;" />

```sh
S1#config t
S1(config)#int f0/1
S1(config-if)#switchport trunk ?
    allowed Set allowed VLAN characteristics when interface is
    in trunking mode
    native Set trunking native characteristics when interface
    is in trunking mode
    pruning Set pruning VLAN characteristics when interface is
    in trunking mode
S1(config-if)#switchport trunk pruning ?
    vlan Set VLANs enabled for pruning when interface is in
    trunking mode
S1(config-if)#switchport trunk pruning vlan 3-4
```





### VLANs之间的路由选择

>   如果要让不同VLAN中的主机(或其他有IP地址的设备)能够彼此通信，就必须使用第3层设备来提供路由选择功能。

#### 使用路由器的多个接口

![image-20220710144905201](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207101449355.png)

>   -   每个路由器接口都连接了一条接入链路，这意味着每个路由器接口的IP地址都将成为相应VLAN中每台主机的默认网关地址。

#### 使用三层交换机

>   -   如果VLAN数量比路由器接口多，可在一个快速以太网接口上配置中继，也可购买一台第3层交换机，如Cisco 3560交换机或诸如6500等高端交换机。



#### 单臂路由

>   -   也可不给每个VLAN提供一个路由器接口，而在路由器上只使用一个快速以太网接口，并在该接口上运行中继协议802.1Q(或者ISL)，如图11-8所示。这让所有VLAN都通过一个接口进行通信，思科称之为"单臂路由"。
>
>   -   要在路由器的快速以太网接口或吉比特以太网接口上启用Trunk，可使用命令`encapsulation`指定协议;
>
>   -   对于每个VLAN中的主机，都需要给它们分配相应子网中的地址，而默认网关为相应路由器子接口的IP地址。
>
>       <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207101453391.png" alt="image-20220710145303118" style="zoom:80%;" />

>   路由器的物理接口可以*虚拟出42.9亿(2^32^)个子接口*, 可以在三层进行不同VLAN的数据交换;
>
>   ```sh
>   R3(config)#int e0/0.?
>   <0-4294967295>  Ethernet interface number
>   ```
>

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621233022548.png" alt="image-20220621233022548" style="zoom:40%;" />

##### 示例1:

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621233749122.png" alt="image-20220621233749122" style="zoom:50%;" />

##### 示例2:

![image-20220710155821482](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207101558706.png)

```sh
# 下面是路由器的配置:
ISR#config t
ISR(config)#int fOjO
ISR(config-if)#no ip address
ISR(config-if)#no shutdown

ISR(config-if)#int fO/O.1
ISR(config-subif)#encapsulation dotlq 1
ISR(config-subif)#ip address 192.168.1.65 255.255.255.192

ISR(confìg-subif)#int fO/O.2
ISR(config 币subif)#encapsulation dotlq 2
ISR(config-subif)#ip address 192.168.1.129 255.255.255.224
```

## Voice VLAN

>   ​	The voice VLAN feature enables **access ports** to *carry IP voice traffic from an IP phone*. When a switch is connected to a Cisco IP phone, the IP phone sends voice traffic with **layer 3 IP precedence and layer 2 class of service (CoS) values**, which are *both set to 5 for voice traffic; all other traffic defaults to 0.*
>
>   ​	Because the sound quality of an IP phone call can deteriorate(恶化) if the data is unevenly sent, the switch supports **quality of service (QoS)** based on IEEE 802.1p CoS. (802.1p provides a mechanism for implementing QoS at the Data Link level.) The 802.1p field is carried in the 802.1Q trunk header. If you look at the fields in an 802.1Q tag, you will see a field called the **priority** field; this is where the 802.1p information goes. *QoS uses classification and scheduling to send network traffic from the switch in an organized, predictable manner.*

>   思科IP电话基本上是一台三端口交换机:一个连接到思科交换机，一个连接到PC，还有一个端口位于内部，连接的是电话本身。
>
>   -   思科IP电话是一种可配置的设备，可对其进行配置，使其在发送的数据流中包含IEEE 802.1p 优先级。
>   -   还可配置交换机，使其信任或覆盖IP电话指定的优先级

>   对于与思科IP电话相连的接入端口，可对其进行配置，使其将一个VLAN用于语音数据流，并将另一个VLAN用于与电话相连的设备(如PC)的数据流。可对交换机的接入端口进行配置，使其发送思科发现协议(CDP)分组，设置相连的思科IP电话以下述方式之一将语音数据流发送给交换机:
>
>   -   通过语音VLAN发送，并添加一个第2层CoS优先级值;
>   -   通过接入VLAN发送，并添加一个第2层CoS优先级值;
>   -   通过接入VLAN发送，但不添加第2层CoS优先级值。

>   The switch can also process **tagged data traffic** (traffic in IEEE 802.1Q or IEEE 802.1p frame types) *from the device attached to the access port on the Cisco IP phone*. You can configure layer 2 access ports on the switch to send CDP packets that instruct the attached Cisco IP phone to configure **the IP phone PC access port** in one of these modes:
>
>   -   In **trusted** mode, all traffic received through the access port on the Cisco IP phone passes through the IP phone **unchanged**.
>   -   In **untrusted** mode, all traffic in IEEE 802.1Q or IEEE 802.1p frames received through the access port on the IP phone receive a configured layer 2 CoS value. The default layer 2 CoS value is 0. **Untrusted mode is the default.**

### Configuring the Voice VLAN

>   **By default, the voice VLAN feature is disabled**; you enable it by using the interface command `switchport voice vlan`. When the voice VLAN feature is enabled, all untagged traffic is sent according to the **default CoS priority** of the port. The CoS value is not trusted for IEEE 802.1p or IEEE 802.1Q tagged traffic.
>
>   ==These are the voice VLAN configuration guidelines==:
>
>   -   You *should configure a voice VLAN on switch access ports*; voice VLAN isn’t supported on trunk ports, even though you can actually configure it!
>   -   The voice VLAN should be present and active on the switch for the IP phone to correctly communicate on it. Use the `show vlan` privileged EXEC command to see if the voice VLAN is present--if it is, it’ll be listed in the display.
>   -   Before you enable the voice VLAN, it’s recommended that you **enable QoS** on the switch by entering the `mls qos` global configuration command and set the port trust state to trust by entering the `mls qos trust cos` interface configuration command.
>   -   You must make sure that CDP is enabled on the switch port connected to the Cisco IP phone to send the configuration. This is on by default, so unless you disabled it, you shouldn’t have a problem. 
>   -   The PortFast feature is automatically enabled when the voice VLAN is configured, but when you disable the voice VLAN, the PortFast feature
>       isn’t automatically disabled.
>   -   To return the port to its default setting, use the `no switchport voice vlan` interface configuration command.

### Configuring IP Phone Voice Traffic

>   You can configure a port connected to the Cisco IP phone to send CDP packets to the phone in order to configure how the phone sends voice traffic. 
>
>   -   The phone can carry voice traffic in IEEE 802.1Q frames for a specified voice VLAN with a layer 2 CoS value. 
>   -   It can use IEEE 802.1p priority tagging to give voice traffic a higher priority as well as forward all voice traffic through the access VLAN instead of the native (access) VLAN. 
>   -   The IP phone can also send untagged voice traffic or use its own configuration to send voice traffic in the access VLAN. 
>   -   **In all configurations, the voice traffic carries a layer 3 IP precedence value—again, for voice the setting is usually 5.**



>   I think it’s about time to give you some actual examples to make this clear to you. This example shows you how to configure four things:
>
>   1. How to configure a port connected to an IP phone to use the **CoS value** for classifying incoming traffic
>   2. How to configure the port to **use IEEE 802.1p priority tagging** for voice traffic
>   3. How to configure it to use the Voice VLAN (10) to carry all voice traffic
>   4. And last, how to configure VLAN 3 to carry PC data
>
>   ```sh
>   Switch#configure t
>   Switch(config)#mls qos
>   Switch(config)#interface f0/1
>   Switch(config-if)#switchport priority extend ?
>       cos Override 802.1p priority of devices on appliance
>       trust Trust 802.1p priorities of devices on appliance
>   Switch(config-if)#switchport priority extend trust
>   Switch(config-if)#mls qos trust cos
>   Switch(config-if)#switchport voice vlan dot1p
>   Switch(config-if)#switchport mode access
>   Switch(config-if)#switchport access vlan 3
>   Switch(config-if)#switchport voice vlan 10
>   ```
>
>   

## EthernetChannel

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622025022846.png" alt="image-20220622025022846" style="zoom:40%;" />

```shell
SW1(config)#int range e0/0 -1
SW1(config-if-range)#channel-group ?
  <1-255>  Channel group number
  auto     Enable LACP auto on this interface
  
SW1(config-if-range)#channel-group 1 mode on

SW1(config-if-range)#do sh span vlan 1
    VLAN0001
      Spanning tree enabled protocol rstp
      Root ID    Priority    32769
                 Address     aabb.cc00.1000
                 This bridge is the root
                 Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

      Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
                 Address     aabb.cc00.1000
                 Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
                 Aging Time  300 sec

    Interface           Role Sts Cost      Prio.Nbr Type
    ------------------- ---- --- --------- -------- --------------------------------
    Po1                 Desg FWD 56        128.65   Shr 
    Po2                 Desg LRN 56        128.66   Shr 
SW1#show ip int br
    Interface              IP-Address      OK? Method Status                Protocol
    Ethernet0/0            unassigned      YES unset  up                    up      
    Ethernet0/1            unassigned      YES unset  up                    up      
    Ethernet0/2            unassigned      YES unset  up                    up      
    Ethernet0/3            unassigned      YES unset  up                    up      
    Port-channel1          unassigned      YES unset  up                    up      
    Port-channel2          unassigned      YES unset  up                    up 
    
SW1#show interfaces port-channel 1  # 查看 Ethernetport 1的配置信息

SW1(config)# int port-channel 1
  switchport trunk encapsulation dot1q 
  sw mode trunk 
  int po2
  switchport trunk encapsulation dot1q 
  sw mode trunk 
  end
  
SW1#show interfaces trunk 
    Port        Mode             Encapsulation  Status        Native vlan
    Po1         on               802.1q         trunking      1
    Po2         on               802.1q         trunking      1

    Port        Vlans allowed on trunk
    Po1         1-4094
    Po2         1-4094

    Port        Vlans allowed and active in management domain
    Po1         1
    Po2         1

    Port        Vlans in spanning tree forwarding state and not pruned
    Po1         1
    Po2         1
```

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622174953723.png" alt="image-20220622174953723" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622175026977.png" alt="image-20220622175026977" style="zoom:87%;" />

>   -   PAgP(Port Aggregration Protocol 端口聚合协议): 
>
>       Cisco Proprietary protocol; 
>
>   -   LACP（Link Aggregration Control Protocol）
>
>       是属于IEEE规范（802.3ad）,允许将多个物理端口捆绑形成单个逻辑通道。它的功能类似于思科的以太通道协议PAgP。: Open Standard used by most of Vendors

>   -   ==on==
>            Mode that forces the LAN port to form Etherchannel without using negotiation protocol. In the on mode, a usable EtherChannel exists only when a LAN port group in the on mode is connected to another LAN port group in the on mode. Because ports configured in the on mode do not negotiate, there is no negotiation traffic between the ports. You cannot configure the on mode with an EtherChannel protocol. If one end uses the on mode, the other end must also.
>
>   ###### PAgP 协议
>
>   -   ==auto== 
>       	PAgP mode that places a LAN port into a passive negotiating state, in which the port responds to PAgP packets it receives but does not initiate PAgP negotiation. (Default)
>
>   -   ==desirable==  
>
>       ​	PAgP mode that places a LAN port into an active negotiating state, in which the port initiates negotiations with other LAN ports by sending PAgP packets.
>
>   ###### LACP 协议
>
>   -   ==passive==  
>
>       ​	LACP mode that places a port into a passive negotiating state, in which the port responds to LACP packets it receives but does not initiate LACP negotiation. (Default)
>
>   -   ==active== 
>
>       ​	LACP mode that places a port into an active negotiating state, in which the port initiates negotiations with other ports by sending LACP packets. Reference: <a>https://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst4500/12-2/3-1-1SG/configuration/guide/config/channel.html</a>

````sh
SW2(config)#default int range e0/0-3
SW2(config)#no int po1
SW2(config)#no int po2
SW2(config)#do sh int br 

SW2(config)#int ran e0/0-3
SW2(config-if-range)#channel-group 1 mode auto
SW2#show etherchannel summary
````

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220622181929981.png" alt="image-20220622181929981" style="zoom:70%;" />