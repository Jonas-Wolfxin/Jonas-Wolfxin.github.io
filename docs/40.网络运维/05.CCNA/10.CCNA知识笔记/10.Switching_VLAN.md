---
title: Switching_VLAN
date: 2022-07-13 12:26:14
permalink: /pages/fabc03/
categories:
  - 网络运维
  - CCNA
  - CCNA知识笔记
tags:
  - 
---
# Switching_VLAN

>   ##### What is LAN?
>
>   A Local Area Network (LAN) is a computer network that connects devices within a limited geographical area such as a home, office, or building. LANs are used to enable communication and the sharing of resources, such as printers, files, and applications, between devices that are connected to the same network.
>
>   LANs typically use **Ethernet or Wi-Fi** as the physical and data-link layer protocols to provide a connection between devices. The network can be either wired, with Ethernet cables connecting devices, or wireless, using Wi-Fi to connect devices.
>
>   LANs are commonly used in homes and small businesses, as they are relatively simple to set up and maintain. Larger networks, such as those found in corporations and universities, may use more complex networking technologies, such as **Wide Area Networks (WANs)** or **Virtual Private Networks (VPNs)**, to connect multiple LANs together.
>
>   -   Switches work within a LAN;
>   -   Routers are used to connect separate LANs.

## MAC地址

> MAC (硬件)地址长48位(6 Bytes):
>
> - 采用 **12位 的 Hexadecimal Characters** 表示为 4位/3组(A8BA.6C05.45ED),或者 2位/6组(A8:BA:6C:05:45:ED);
> - A.K.A. Burned-in Address(BIA);
> - assigned to the device when it is made:
>     - **前24bit(3 Bytes)是OUI** (Organizationally Unique Identifier ，组织唯一标识符)是由IEEE 分配给厂商的;
>     - 后24bit(3 Bytes)是各厂商给生产的每个网卡都分配一个唯一的地址;
> - is globally unique.
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303160415009.png" alt="image-20230316035259406" style="zoom: 30%;" />

## Ethernet Frame

- 数据链路层负责将比特合并成字节，再将字节封装成帧。在数据链路层，我们使用帧封装来自网络层的分组，以便通过特定类型的介质进行传输。

- 以太网工作站的职责是，使用MAC帧格式彼此传递数据帧, 这利用CRC提供了错误检测功能，

![image-20220704231652823](https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303160415108.png)

> 在Ethernet Frame中除了数据之外, header和trailer加起来一共 **26 Bytes**:
>
> - `前导码 Preamble`: 前导码为 7 Bytes of 10101010，交替的0和1; Allows devices to synchronize their receiver clocks。
>
> - `帧起始位置分隔符(SFD, Start Frame Delimiter)` SFD为 1 Byte, 值为10101011; Marks the end of the preamble and the beginning of the rest of the frame.
>
>     >   -   **Preamble**和*SFD*在以太网帧中的作用是为了在物理层上进行**同步时钟**和*标识数据部分*的开始，使接收设备能够正确地接收和解析数据帧。
>     >   -   通过Preamble和SFD的结合作用，接收方可以精确地同步时钟，并且识别出一个新的帧的开始位置。这样，接收方就可以正确地解析以太网帧的数据部分，从而实现数据的可靠传输。
>
> - `目标地址(Destination MAC Address)` 包含一个48 bits的值，且LSB (Least Significant Bit，最低有效位)优先。接收方根据DA 判断到来的分组是否是发送给特定节点的。目标地址可以是单播地址、广播地址或组播MAC地址。别忘了，广播地址全为1(在十六进制格式下全为F)，广播发送给所有设备，而组播只发送给网络中一组类似的节点。
>
> - `源地址(Source MAC Address)` SA是一个48位的MAC地址，用于标识传输设备，也使用LSB优先格式。在SA字段中，不能包含广播地址或组播地址。
>
> - `长度或类型 Length/Type`: 2 bytes; 
>
>     - 802.3帧使用**Length**字段, 标识了数据部分的长度, 值为 **1500 or less**; 802.3不能标识上层协议，只能用于专用LAN，如IPX。
>     - 而Ethenet_II帧使用**Type**字段标识网络层协议: 
>         - **IPv4(0x0800), ** 
>         - **IPv6(0x86DD), **
>         - **the ARP ethernet type is 0x0806**。
>
> - `数据`: 这是网络层传递给数据链路层的帧，其长度为46-1500B 。
>
> - `帧校验序列(FCS, Frame Check Sequence)`:  4 Bytes, FCS 字段用于存储CRC(Cyclic Redundancy Check，循环冗余校验) 结果。CRC是一种数学算法，创建每个帧时都将运行它。作为接收方的主机收到帧并运行CRC时，其结果必须相同，否则，接收方将认为发生了错误，进而将帧丢弃。

---

>   -   The preamble + SFD is usually **not considered** part of the Ethernet header, although it is sent with every Ethernet frame.
>   -   Therefore the size of the Ethernet header + trailer is 18 bytes (6+6+2+4);
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303161323599.png" alt="image-20230316132344387" style="zoom:33%;" />
>
>   -   **The minimum size for an Ethernet frame** (Header + Payload [Packet] + Trailer) is **64 bytes**;
>
>   -   64 bytes — 18 bytes (header + trailer size) = 46 bytes, Therefore the **minimum payload (packet) size** of an Ethernet Frame is **46 bytes** 
>
>   -   If the payload is less than 46 bytes, *padding bytes*(these bytes are all 0s) are added, ie. 34-byte packet + 12-byte padding = 46 bytes
>
>       <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303161905308.png" alt="image-20230316190532804" style="zoom:33%;" />

## Switch

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621103251967.png" alt="image-20220621103251967" style="zoom:40%;" />

### 交换机的特点

>- 网桥使用软件来创建和管理过滤表, 而交换机使用专用的集成电路(ASIC) 来创建并维护其过滤表;
>- 默认情况下, Layer2交换机的所有端口都属于一个广播域(VLAN 1);
>- 每个端口都是一个独立的冲突域, 为每个终端设备提供相同的带宽;
>- 通过检查每个接收到的数据帧的**Source MAC**，交换机完成对MAC地址的学习;
>- 对 **unknown Unicast Frame** 和 **Broadcast Frame** 进行泛洪flood;
>- 对 **known Unicast Frame** 进行定向转发;
>



### 交换机的主要功能

>###### MAC地址学习:
>
>交换机通过检查每个接收到的数据帧的==源地址==完成对MAC地址的学习, 然后建立`MAC地址`与`交换机接口`的地址对应表`Forward/Filter MAC database`. (**Dynamic MAC addresses are removed from the MAC address table after 5 minutes of inactivity!** The process of addresses being cleared from the MAC address table after 5 minutes of inactivity is known as **Aging**);
>
>-   查看MAC Address Table: `show mac address-table`
>
><img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303161858682.png" alt="image-20230316185844317" style="zoom:25%;" />
>
>-   清空MAC Address Table: `clear mac address-table dynamic` 
>-   删除指定的MAC地址条目: 
>   -   `clear mac address-table dynamic address 0c3f.b011.34ba`  或者 
>   -   `clear mac address-table dynamic interface gi0/0` 
>
>###### 转发和泛洪数据帧(Frame):
>
>当交换机的接口接收到一个数据帧时，交换机就将帧中携带的目的地址和`Forward/Filter MAC database`中的记录进行比较:
>
>- **known Unicast** frame -> *Forward*: 如果目的硬件地址是已知的，即已经被列入到MAC表中，则该帧只被发送到指定的输出接口。交换机不会将此帧发送到除目的地接口之外的任何其他接口。这一过程叫做 帧过滤;
>- **unknown Unicast** frame -> *Flood*: 如果`Forward/Filter MAC database`中没有目标方的MAC地址，那么此数据帧将会向除接收此帧接口之外的所有其他活动接口上**泛洪**出去。
>   - 具有指定MAC地址的设备会*处理并响应*被泛洪的数据帧，则交换机就会用此设备的位置(接口)信息来更新MAC地址表。
>    - 不具有指定MAC地址的设备在接收被泛洪的数据帧后,会直接*丢弃*.
> - **Brodcast** frame -> Flood: have a destination address of *FFFF.FFFF.FFFF*, 此数据帧将会向除接收此帧接口之外的所有其他活动接口上**泛洪**出去。
>   - 符合条件的设备会*处理并响应*被泛洪的数据帧，则交换机就会用此设备的位置(接口)信息来更新MAC地址表。
>   - 不符合条件的设备在接收被泛洪的数据帧后,会直接*丢弃*.
>
>###### 二层环路避免: 
>
>通过STP避免在数据链路层由于交换机之间的冗余物理链路而形成的环路; (TTL的计算中的hop是指路由器间的跳转, 即三层的跳转, 对2层及以下是透明的)
>
> - 路由选择协议(如 RIP) 可以防止在**网络层**形成网络环路。
> - 然而，对于**因交换机之间存在冗余物理链路而在数据链路层上形成的环路**，路由选择协议无能为力。网络传播的数据帧会在所有冗余链路上同时被泛洪开来，这会导致`广播风暴`和其他严重的问题。这就是开发生成树协议的原因所在，可以防止在第2层交换式网络中形成环路。

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207081721321.png" alt="image-20220708172156171" style="zoom:80%;" />

### Switch Interfaces

#### `show ip interfaces brief`

![image-20230318155858388](https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303181558612.png)

>   -   Router interfaces have the `shutdown` command applied by default = will be in the **administratively down/down** State by default;
>
>   -   Switch interfaces **do NOT** have the `shutdown` command applied by default = 
>
>       -   will be in the **up/up** State if connected to another device OR 
>
>       -   in the **down/down** State if not connected to another device

#### `show interfaces status`

![image-20230318155941567](https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303181559757.png)

>   -   **Name field**: is actually the description of the port.
>   -   **Status field**:
>       -   *connected*
>       -   *notconnected*
>       -   *disabled*: After setting `shutdown` on the ports, the Status field would be changed to **disabled**.
>   -   **Vlan field**: Take note of the fact that the interface connected to the other switch, is a trunk interface.
>   -   **Duplex field**:  Duplex is auto by default on Cisco switches, meaning it will auto-negotiate with the neighboring device and use full-duplex if possible.
>       -   *Half duplex*: The device cannot send and receive data at the same time. If it is receiving a frame, it must wait before sending a frame. 
>           -   使用Hub集线器连接的网络都是半双工网络;
>           -   半双工接口与全双工接口之间的连接, 也会以半双工方式运行.
>       -   *full-duplex*: The device can send and receive data at the same time. It does not have to wait.
>   -   **Speed field**: which is also auto by default. **Auto** means they are able to auto-negotiate with the device they are connected to and use the fastest speed both devices are capable of.



#### Configuring interface speed and duplex

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303181612983.png" alt="image-20230318161215621" style="zoom:30%;" />



>   ##### Speed/Duplex Auto-negotiation
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303181651830.png" alt="image-20230318165139506" style="zoom:33%;" />
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303181653572.png" alt="image-20230318165346312" style="zoom:33%;" />

> ##### CSMA/CD Mechanism in ==Half-duplex== network
>
> - Ethernet devices use **CSMA/CD** to detect and prevent collisions on *half-duplex* interfaces.
> - `半双工以太网`使用`CSMA/CD` (Carrier Sense Multiple Access with Collision Detection ，载波侦听多路访问/冲突检测)，这是一种帮助设备均衡地共享带宽的协议，可避免两台设备同时在网络介质上传输数据。同一冲突域内, 多个节点同时传输分组时，将发生冲突，而开发CSMA/CD就旨在避免这种问题:
>     - Before sending frames, devices ‘listen’ to the collision domain until they detect that other devices are not sending. 
>     * If a collision does occur, the device sends a **jamming signal(阻塞信号)** to inform the other devices that a collision happened. 
>
>     - Each device will wait a *random period* of time before sending frames again. 
>
>     * The process repeats.
> - 在`半双工以太网`中发生冲突后，将出现如下情况:
>         1. 拥堵信号告诉所有设备发生了冲突;
>         2. 冲突发生后进行随机延迟并重传;
>         3. 以太网网段中的每台设备都暂停传输，直到定时器到期后，所有主机的传输优先级都相同。
> - CSMA/CD 网络持续发生严重冲突时，将导致如下后果:
>     - 延迟;
>     - 低吞吐量;
>     - 拥塞。

> 最后，请牢记如下要点:
>
> - **在Full-duplex模式下，不会发生冲突;** Full-Duplex transmission means that both devices and send data at the same time, and no problems like collisions will occur because they use separate wires to transmit and receive data.
> - 集线器属于*Layer 1- Physical Layer*的网络设备,已经基本淘汰; 除集线器外，几乎其他所有设备都可在全双工模式下运行。
> - 半双工以太网只有一个**冲突域(Collision Domain)**，其有效吞吐量比全双工以太网低得多。
> - 在全双工以太网中，交换机的每个端口都对应一个独立的冲突域，且有效吞性量更高。



#### shutdown the unused interfaces

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303181613678.png" alt="image-20230318161356308" style="zoom: 50%;" />

```sh
SW1(config)# interface range f0/5 - 8, f0/10-11
SW1(config-if-range)# shutdown 
```

#### Interface Counters & Errors

The *switch and router* will take count of some of these things and you can view them with the `show interfaces` command.

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303181702365.png" alt="image-20230318170220044" style="zoom:38%;" />

>   Interface Counters:
>
>   -   **total number of packets received on the interface**, 
>   -   **the total number of bytes in those packets**;
>
>   Interface Errors:
>
>   -   **runts**: Frames that are smaller than the minimum frame size (64 bytes);
>   -   **giants**: Frames that are larger than the maximum frame size (1518 bytes);
>   -   **CRC**: Frames that failed the CRC check (in the Ethernet FCS trailer);
>   -   **frame**: Frames that have an Incorrect format (due to an error);
>   -   **Input errors**: Total of various counters, such as the above four;
>   -   **Output errors**: Frames the switch tried to send, but failed due to an error

## 交换的寻址过程

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621140831792.png" alt="image-20220621140831792" style="zoom:40%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621141319943.png" alt="image-20220621141319943" style="zoom:40%;" />

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621141355454.png" alt="image-20220621141355454" style="zoom:40%;" />



---

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303161800854.png" alt="image-20230316180045420" style="zoom:33%;" />

1.   The user entered the IP address 192.168.1.3 as the destination, but PC1 has to discover PC3’s MAC address by itself;
2.   So, PC1 wants to send this Ethernet frame to PC3, but first it has to learn PC3’s MAC address;
3.   To do so, it uses **ARP**.

### ARP(Address Resolution Protocol):

>   -   ARP is used to discover the Layer 2 address (MAC address) of a known Layer 3 address (IP address) ;
>-   Consists of two messages: 
>       -   **ARP Request**: is *broadcast* = sent to all hosts on the network
>       -   **ARP Reply**: is *unicast* = sent only to one host (the host that 
>           sent the request)
>   
>   ```shell
>arp -a   # to view the ARP table(Windows, macOS, Linux)
>   # Internet Address = IP address (Layer 3 address) 
>   # Physical Address = MAC address (Layer 2 address) 
>   # Type static = default entry 
>   # Type dynamic = learned via ARP
>   
>   Router# show arp        ## in Cisco IOS it's show arp, from privileged exec mode.
>   ```

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303161821070.png" alt="image-20230316182110625" style="zoom:33%;" />

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303161829017.png" alt="image-20230316182918507" style="zoom:34%;" />

### Ping

>   -   A network utility that is used to **test reachability**;
>-   Measures round-trip time;
>   -   Uses two messages: 
>       -   **ICMP Echo Request**: the PC won’t broadcast the ICMP echo request, it is sent to a specific host. So, it has to know the MAC address of the destination host, which is why ARP must be used first. After that, the MAC address of the IP is known, so *ICMP Echo Request is a unicast message.*
>       -   **ICMP Echo Reply**: *unicast message*
>   
>   ```sh
>ping IP_Address
>   ```
>   
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303161849298.png" alt="image-20230316184941017" style="zoom:30%;" />
>
>   -   By default, a ping in Cisco IOS sends 5 ICMP echo requests, and then you should get 5 ICMP echo replies back, and the default size of each ping is 100 bytes.
>
>   -   The period indicates a failed ping, and the exclamation marks indicate a successful ping.
>
>   -   **why did that first ping fail?** 
>
>       Well, that’s because of ARP. PC1 didn’t know the destination MAC address, so it had to use ARP, and in that time the first ping failed.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303161855686.png" alt="image-20230316185509157" style="zoom:38%;" />

---

## VLAN

### Introduction

>   ##### What is LAN?
>
>   -   A LAN is a **single broadcast domain**, including all devices in that broadcast domain. 
>
>   ##### What is Broadcast Domain?
>
>   -   A broadcast domain is the group of devices which will receive a **broadcast frame** (destination MAC FFFF.FFFF.FFFF) sent by any one of the members.

> ##### What is VLAN?
>
> 在纯粹的交换型互联网络中, 如何划分广播域呢? 答案是创建VLAN(虚拟局域网)。 VLAN是一个网络用户和网络资源的逻辑编组, 它们与管理者定义的交换机端口相连。 通过在交换机上创建VLAN, 可以指定交换机端口为不同的子网提供服务, 从而在二层交换型网络(广播域)中创建更小的广播域.
>
> - 默认情况下, 交换机的所有接口都同属一个广播域;
>
> - VLANs are configured on switches on a per-interface basis. 
> - VLAN技术可以把交换机的接口在*数据链路层*上将整个广播域(LAN)划分成若干个VLAN, logically separate end hosts at Layer 2;
> - 划分后,VLAN之间是互相隔离的, *VLAN之间在二层设备上无法互相通信, 必须经由三层设备(路由器)才可以互通*; Switches DO NOT forward traffic between VLANs, including broadcast/unknown unicast traffic.
>
> ##### Benefits of VLAN:
>
> -   **Performance**: Lots of unnecessary broadcast traffic can reduce network performance;
> -   **Security**: Even within the same office, you want to limit who has access to what. You can apply security policies on a router/firewall. Because this is one LAN, PCs can reach each other directly, without traffic passing through the router. So, even if you configure security policies, they won't have any effect.
>
> 
>
> ###### VLAN的典型应用场景:
>
> <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621141811827.png" alt="image-20220621141811827" style="zoom:40%;" />

#### VLAN的成员模式

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621143523960.png" alt="image-20220621143523960" style="zoom:40%;" />

> - `静态VLAN` 易于配置和管理，非常适合用于需要控制所有用户移动的网络环境; 是创建VLAN最常用的方法，其原因之一是静态VLAN最安全。
> - `动态VLAN` 通过使用**VLAN管理策略服务器(VMPS)**，可根据硬件(MAC)地址、协议甚至创建动态VLAN 的应用程序来确定所连接的交换机端口所属的VLAN。VMPS数据库将MAC地址映射到VLAN。在同一台交换机中，可以同时有动态接入端口和中继端口，但动态接入端口只能连接到终端或集线器，而不能连接到其他交换机!

#### VLAN ID

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621153512606.png" alt="image-20220621153512606" style="zoom:43%;" />

> ##### Categories:
>
> - 编号1 ~ 1005的VLAN为 **Normal VLANs**: *VLAN 1*, *VLAN 1002~1005* exist by default and cannot be deleted.
> - 编号1006~4094的VLAN称为 **Extended VLANs**;

> ###### VLAN 1的特性:
>
> - VLAN 1 是一个管理VLAN(管理数据流，如CDP， PAgP、LACP， DTP和VTP), 虽然也可将其用于工作组, 但思科建议只将其用于管理;
> - VLAN 1 是默认的Native VLAN, 不能被修改、删除或重命名;
> - 默认情况下, 所有的交换机端口都属于VLAN 1;



#### 在交换环境中，存在三种类型的端口:

> ###### Access port: 
>
> - An access port is a switchport which belongs to a single VLAN, and usually connects to end hosts like PCs.
>
> - **An access port belongs to and carries the traffic of only one VLAN**. 
>
> - Traffic is both received and sent in **native formats with no VLAN tagging** whatsoever. Anything arriving on an access port is simply assumed to belong to the VLAN assigned to the port.
>
>   - 与`Access Port`相连的设备没有VLAN成员资格的概念，只是认为自己是某个广播域的一员, 没有全局意识，根本不了解物理网络拓扑。
>   - 将帧转发给与`Access Port`相连的终端设备前，交换机将删除所有的VLAN信息。
>
>       >   So, what do you think will happen if an access port receives a *tagged packet, like IEEE 802.1Q tagged*?
>       >
>       > - Right—*that packet would simply be dropped*. But why? Well, because an access port doesn’t look at the source address, so tagged traffic can be forwarded and received only on trunk ports.
>
> ###### Voice access ports: 
>
> - 这是一种特殊的`Access port`; 前面一直说接入端口只能属于一个VLAN，但这种说法不完全正确。当前，大多数交换机都允许将接入端口分配给另一个VLAN，以便传输语音数据流，这种VLAN被称为语音VLAN。语音VLAN过去被称为辅助VLAN，它可以与数据VLAN重叠，允许同一个端口同时传输语音和数据。虽然从技术上说，这属于不同类型的链路，但它仍然只是一种接入端口，只是能够配直的同时为语音VLAN 和数据VLAN传输数据流。这让你能够将电话和PC同时连接到同一个交换机棉口，并让它们属于不同的VLAN。在本章后面的11.8节，将详细介绍语音VLAN。
>
> ###### Trunk port: 
>
> - Trunk ports can carry multiple VLANs over a single interface; 位于交换机之间、交换机和路由器之间或交换机和服务器之间，它同时为多个(1-4094个，但除非使用扩展VLAN，否则最多为1005个)VLAN传输数据流。
>
>   - 可让一个端口同时属于众多不同的VLAN, 比如可让同一台服务器属于两个不同的广播域，这样用户无需通过第3层设备(路由器)就能登录或访问它;
>
>   - 另一个优点表现在交换机之间的Trunk连接。中继链路可传输来自多个VLAN的帧。
>
>       <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207101256426.png" alt="image-20220710125650266" style="zoom:80%;" />

> - 交换机端口是第二层接口, 这种接口与物理端口相关联;
> - 交换机端口为`access port`时, 只能属于一个VLAN; 而为`trunk port`时, 属于所有的VLANs;
> - 可手工将端口配置为`access port`或`trunk port`, 也可在每个端口上运行DTP协议, DTP通过与链路另一端的端口协商来设置端口模式



### Two Trunking(tagging) Protocols

#### dot1q:

> - IEEE 802.1Q, A.S.A dot1q 是IEEE制定的 industry standard protocol，它在Ethernet Frame中插入一个字段Tag。
>- 802.1Q has a feature called the **native VLAN**. (ISL does not have this feature.) 
> - The native VLAN Is *VLAN 1 by default on all trunk ports*, however this can be manually configured on **each trunk port**.
> - The switch does not add an 802.1q tag to *frames in the native VLAN*.
> - When a switch receives an untagged frame on a trunk port, it assumes the frame belongs to the native VLAN. **So, it’s very important that the native VLAN matches for the switches on the same Trunk Link!**
> 
> 
>
> ###### VLAN Tagging
>
> -   Switches will ‘tag’ all frames that they send over a trunk link. This allows the receiving switch to know which VLAN the frame belongs to.
>
>     -   Trunk Ports = tagged ports;
>    -   Access Ports = untagged ports;
> 
> -   This frame identification method uniquely assigns a user-defined VLAN ID to each frame. Sometimes people refer to it as a **VLAN ID**.
>
> -   **Trunk ports will support tagged and untagged traffic simultaneously (if you are using 802.1Q trunking protocol**).
>
>     >   The trunk port is assigned a default Port VLAN ID (PVID) for a VLAN on which all untagged traffic will travel. This VLAN is also called the **native VLAN** and is always **VLAN 1** by default (but it can be changed to any VLAN number).
>
> 
>
> ###### Here’s how it works:
>
> -   Once within the switch fabric, each switch that the frame reaches must first identify the VLAN ID from the frame tag. It then finds out what to do with the frame by looking at the information in what’s known as the **filter table**. If the frame reaches a switch that has another trunked link, the frame will be forwarded out the trunk-link port.
>    ​
> 
> -   Once the frame reaches an exit that’s determined by the **forward/filter table** to be an **access link** matching the frame’s VLAN ID, the switch will remove the VLAN identifier. This is so the destination device can receive the frames without being required to understand their VLAN identification information.
>
> 
>
> ###### 802.1Q Tag结构
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303300053536.png" alt="image-20220621184009736" style="zoom:53%;" />
>
> - **FCS(Frame Check Sum)**将重新计算;
>
> - **802.1Q Tag** 的大小 4 Bytes, consists of two main fields: :
>    - *Tag Protocol Identifier(TPID)*: 16 bits, always set to a value of **0x8100**, which indicates that the frame is **802.1Q-tagged**.
>     - *Tag Control Information(TCI)* 
>         - **PCP(Priority Code Point)**: 3 bits, Used for **CoS(Class of Service)**, which prioritizes important traffic in congested networks;
>         - **DEI(Drop Eligible indicator)**: 1 bit, Used to indicates frames that can be dropped if the network is congested, which makes sure more important network traffic gets through;
>         - **VLAN ID**: 12 bits(2^12^ = 4096, range of 0 ~ 4095), identifies the VLAN which the frame belongs to;
> 
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303220111900.png" alt="image-20230322011132707" style="zoom: 22%;" />

#### ISL:

> - (Inter-Switch Link), 思科proprietary协议, **Deprecated!**
>
> - 交换机间链路(ISL)是一种显式标记方法，它在以太网帧中添加VLAN信息。这些标记信息允许利用外部标记方法在中继链路上多路复用多个VLAN的数据流，从而让交换机确定通过中继链路收到的帧属于哪个VLAN 。
> 
> - 需要注意的是，这是一种思科专用协议，只能用于**FastEthernet**和**GigabitEthernet**链路。ISL可用于交换机端口、路由器接口和服务器接口卡。
> 
> - 思科的专有协议ISL, 但是存在一些问题, 所以思科逐渐弃用了!
>
>     <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621183600780.png" alt="image-20220621183600780" style="zoom:40%;" />



### 交换机端口的模式:

>   ```sh
>   SW1(config-if)#switchport mode ?
>   access        Set trunking mode to ACCESS unconditionally
>   dot1q-tunnel  set trunking mode to TUNNEL unconditionally
>   dynamic       Set trunking mode to dynamically negotiate access or trunk mode
>   private-vlan  Set the mode to private-vlan host or promiscuous
>   trunk         Set trunking mode to TRUNK unconditionally
>   ```
>
>   
>
>   - `switchport mode access`: forces the interface on the SW into **Access Port** mode;
>
>   - `switchport mode trunk`: forces the interface on the SW into **Trunk Port** mode;
>   - `switchport nonegotiate`: Disable DTP on the interfaces on Cisco Switches. `switchport mode access` *can also prevent the interface from generating DTP frames*. 
>

#### DTP 

-   (Dynamic Trunking Protocol), **Cisco proprietary** protocol 
-   allows **switches with each other** to negotiate the status of their switchports to be either **Access Ports** or **Trunk Ports**, without manual configuration.
-   DTP is enabled by default on all Cisco switch interfaces.
-   DTP can be exploited by attackers. For security purposes, manual configuration is recommended. **DTP should be disabled on all switchports.**
-   查看指定端口的DTP状态: `show interfaces f0/1 switchport`

>   - `switchport mode dynamic auto`: This mode makes the interface able to convert the link to a trunk link. The interface becomes a trunk interface if the neighboring interface is set to 
>       - **trunk**;
>       - **dynamic desirable**;
>   - `switchport mode dynamic desirable`: This one makes the interface **actively** attempt to convert the link to a trunk link. The interface becomes a trunk interface if the neighboring interface is set to 
>       - **trunk**;
>       - **dynamic desirable**;
>       - **dynamic auto**;
>
>   >   -   On older switches, `switchport mode dynamic desirable` is the default administrative mode.
>   >   -   On newer switches, `switchport mode dynamic auto` is the default administrative mode.
>
>   ###### Summary:
>
>   ![image-20230324001845430](https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303240018613.png)

>   ##### 补充1:
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303230550406.png" alt="image-20230323055016098" style="zoom:33%;" />
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303230546146.png" alt="image-20230323054612807" style="zoom:34%;" />
>
>   ##### 补充2:
>
>   - Switches that support both 802.1Q and ISL trunk encapsulations can use DTP to negotiate the encapsulation they will use. 
>   - This negotiation is enabled by default, as the default trunk encapsulation mode is: `switchport trunk encapsulation negotiate`
>   - ISL is favored over 802.1Q, so if both switches support ISL it will be selected.
>   - DTP frames are sent in VLAN1 when using ISL, or in the native VLAN when using 802.1Q (the default native VLAN is VLAN1, however).
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303230606773.png" alt="image-20230323060653449" style="zoom:38%;" />



### VLAN的基本配置

#### VLAN的查看, 创建, 重命名, 删除

```shell
# 查看vlan配置
SW1# show vlan brief   #  shows the access ports assigned to each VLAN 

# 创建 VLAN
SW1(config)#vlan 2  # 创建 VLAN 2
SW1(config)#vlan 3-10   # 连续地创建 编号为 3~10, 一共8个 VLAN
SW1(config)#vlan 11,13,15,17  # 创建指定编号的 VLAN

SW1(config-vlan)#name VLAN_NAME    # 自定义 当前VLAN的名字
SW1(config-vlan)#end

SW1#

# 删除指定的VLAN, 也支持批量删除
SW1(config)#no vlan 3-10,11,13,15,17   
```

#### Access Mode并分配给指定的VLAN

```sh
SW1(config)#int e0/0
SW1(config-if)#switchport ?
  access         Set access mode characteristics of the interface  # 承载单个VLAN
  autostate      Include or exclude this port from vlan link up calculation
  dot1q          Set interface dot1q properties
  host           Set port host
  mode           Set trunking mode of the interface
  nonegotiate    Device will not engage in negotiation protocol on this interface
  port-security  Security related command 
  private-vlan   Set the private VLAN configuration
  protected      Configure an interface to be a protected port
  trunk          Set trunking characteristics of the interface  # 承载多个VLAN的数据
  voice          Voice appliance attributes
  <cr>
 
SW1(config-if)#switchport mode access
SW1(config-if)#switchport access vlan 2  # 将当前的接口配置到指定的VLAN
% Access VLAN does not exist. Creating vlan 2    # 若VLAN不存在时, 会自动创建

SW1#show vlan brief   
    VLAN Name                             Status    Ports
    ---- -------------------------------- --------- -------------------------------
    1    default                          active    Et0/1, Et0/2, Et0/3
    2    CCNA                             active    Et0/0
    1002 fddi-default                     act/unsup 
    1003 token-ring-default               act/unsup 
    1004 fddinet-default                  act/unsup 
    1005 trnet-default                    act/unsup 
```

#### 一次性设置多个接口加入同一个VLAN:

```sh
SW2(config)# interface range g0/0 - 3

SW2(config-if-range)# switchport mode access

SW2(config-if-range)# switchport access vlan 3
% Access VLAN does not exist. Creating vlan 3

SW2(config-if-range)# end
SW2#show vlan brief
    VLAN Name                             Status    Ports
    ---- -------------------------------- --------- -------------------------------
    1    default                          active    
    2    VLAN0002                         active    
    3    VLAN0003                         active    Et0/0, Et0/1, Et0/2, Et0/3

```

### Trunk Configuration

> 交换机上承载多个VLAN, 则当交换机与 交换机或者路由器 之间的连接需要将接口设置为 `Trunk模式`;

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621183139837.png" alt="image-20220621183139837" style="zoom:40%;" />

##### 查看交换机的Trunk端口: 

`show interfaces trunk`: shows the trunk ports that allow each VLAN.

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303220153542.png" alt="image-20230322015334342" style="zoom:45%;" />

>   -   Mode **on**: means that the interface was manually configured as a trunk.
>   -   **VLANs allowed on the trunk**: By the default, ALL VLANs, 1 to 4094, are allowed on the trunk.
>   -   **VLANs allowed and active in management domain**: 在交换机上的 **存在的(VLAN 1或者创建的) 并且 放行(allowed)的VLAN** 

##### 配置端口为Trunk mode

>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303220149153.png" alt="image-20230322014956875" style="zoom:38%;" />
>
>   * Many modern switches do not support Cisco’s ISL at all. They only support 802.10 (dot1q) 
>
>   * However, switches that do support both (like the one I’m using in this example) have a trunk 
>     encapsulation of ‘Auto’ by default. 
>
>   * To manually configure the interface as a trunk port, you must first set the encapsulation to 
>     802.1Q or ISL. On switches that only support 802.1Q, this is not necessary.

```sh
# 1.配置 Trunk 的封装方式(使用的协议):
SW1(config-if)#switchport trunk encapsulation ?
  dot1q      Interface uses only 802.1q trunking encapsulation when trunking
  isl        Interface uses only ISL trunking encapsulation when trunking
  negotiate  Device will negotiate trunking encapsulation with peer on
             interface      
 
SW1(config-if)#switchport trunk encapsulation dot1q 

# 2.开启接口的Trunk模式:
SW1(config-if)#switchport mode trunk 
```

##### 限定Trunk端口支持的VLAN

```sh
S1# config t
S1(config)# int f0/1
S1(config-if)# switchport trunk allowed vlan ?
   WORD  VLAN IDs of the allowed VLANs when this port is in trunking mode
   add  add VLANs to the current list
   all  all VLANs
   except  all VLANs except the following
   none  no VLANs
   remove  remove VLANs from the current list

S1(config-if)# switchport trunk allowed vlan 10, 30    # Only VLAN 10 & 30 are allowed

S1(config-if)# switchport trunk allowed vlan add 20

S1(config-if)# switchport trunk allowed vlan remove ?
WORD VLAN IDs of disallowed VLANS when this port is in trunking mode
S1(config-if)# switchport trunk allowed vlan remove 10

# 将VLAN 排除在外后，要恢复到默认设置，可使用下述命令:
S1(config-if)# switchport trunk allowed vlan all
```



##### 修改指定端口的Native Vlan

>   ```sh
>   S1#config t
>   S1(config)#int f0/1
>   S1(config-if)#switchport trunk ?
>       allowed Set allowed VLAN characteristics when interface is in trunking mode
>       native Set trunking native characteristics when interface is in trunking mode
>       pruning Set pruning VLAN characteristics when interface is in trunking mode
>   
>   S1(config-if)#switchport trunk native vlan ?
>   <1-4094> VLAN ID of the native VLAN when this port is in trunking mode
>   
>   S1(config-if)#switchport trunk native vlan 1001
>   S1(config-if)#^Z
>   ```
>   
>- For security purposes, it is best to change the native VLAN to an unused VLAN. (network security will be explained more in-depth later in the course) 
> 
>    
> 
>**Make sure the native VLAN matches on between switches!**

##### 案例:

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303220222811.png" alt="image-20230322022222534" style="zoom:33%;" />

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303220225536.png" alt="image-20230322022559320" style="zoom:30%;" />

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303220226687.png" alt="image-20230322022629492" style="zoom:32%;" />

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303220222775.png" alt="image-20230322022255421" style="zoom:33%;" />

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303220224794.png" alt="image-20230322022434499" style="zoom:39%;" />



#### Router on a Stick(ROAS)

>   ROAS - is the method of inter-VLAN routing
>
>   -   As the picture above shown, there is only a *single physical interface* connecting the router and the switch, we can actually divide this one physical interface on the router into three separate **Sub-interfaces**.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303220233773.png" alt="image-20230322023331353" style="zoom: 36%;" />
>
>   -   The next command after that is `encapsulation dot1q VLAN_ID`, 
>       -   Router will treat any arriving frames tagged with the specified VLAN number as if they arrived on this sub interface.
>       -   If a frame tagged with VLAN10 arrives, R1 will behave as if it arrived on interface G0/0.10;
>       -   It will also tag all frames leaving this subinterface with VLAN10 using dot1q.

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303220249387.png" alt="image-20230322024907946" style="zoom:33%;" />

### Routing methods of inter-VLANs

如果要让不同VLAN中的主机(或其他有IP地址的设备)能够彼此通信，就必须使用第3层设备来提供路由选择功能。

#### 使用路由器的多个接口

![image-20220710144905201](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202207101449355.png)

> - 每个路由器接口都连接了一条接入链路，这意味着每个路由器接口的IP地址都将成为相应VLAN中每台主机的默认网关地址。

#### 单臂路由 ROAS

> - **Router on a Stick** is used to provide **Inter-VLAN ip routing** between multiple VLANs using a single interface on the router. 
>
> - The switch interface is configured as a regular trunk. 
>
> - The router interface is configured using subinterfaces. You configure the VLAN tag and IP address on each subinterface. 对于每个VLAN中的主机，都需要给它们分配相应子网中的地址，而默认网关为相应路由器子接口的IP地址。
>
> - The router will behave as if frames arriving with a certain VLAN tag have arrived on the subinterface configured with that VLAN tag.
>
> - The router will tag frames sent out of each subinterface with the VLAN tag configured on the subinterface.
>
> - 路由器的物理接口可以*虚拟出42.9亿(2^32^)个子接口*, 可以在三层进行不同VLAN的数据交换;
>
>     ```sh
>     R3(config)#int e0/0.?
>     <0-4294967295>  Ethernet interface number
>     ```



##### 单臂路由的基本配置

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621233022548.png" alt="image-20220621233022548" style="zoom:40%;" />

##### Native VLAN on a Router(ROAS)

>   There are 2 methods of configuring the native VLAN on a router:
>
>   -   Use the command `encapsulation dot1g vlan-id native` on the router **sub-interface**;
>
>       <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303221959455.png" alt="image-20230322195930236" style="zoom: 25%;" />
>
>   -   Configure the IP address for the native VLAN on the router’s physical interface 
>
>       <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222003058.png" alt="image-20230322200352839" style="zoom: 25%;" />
>
>       <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222004760.png" alt="image-20230322200453462" style="zoom:29%;" />

##### 案例:

![image-20230322191920750](https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303221919883.png)

>   1.   Configure the switch interfaces connected to PCs as access ports in the correct VLAN.
>
>   2.   Configure an unused VLAN as the native VLAN.
>
>   ​    **Make sure all necessary VLANs exist on each switch!**
>
>   3.   Configure the connection between SW2 and R1 using 'router on a stick'.
>
>   ​    Assign the last usable address of each subnet to R1's subinterfaces.
>
>   4.   Test connectivity by pinging between PCs.  All PCs should be able to reach each other.

###### SW1 Configuration

```sh
SW1#conf t
Enter configuration commands, one per line.  End with CNTL/Z.
SW1(config)#int ran f0/1-2
SW1(config-if-range)#switchport mode access 
SW1(config-if-range)#switchport access vlan 10
% Access VLAN does not exist. Creating vlan 10

SW1(config-if-range)#int ran f0/3-4
SW1(config-if-range)#switchport mode access 
SW1(config-if-range)#switchport access vlan 30
% Access VLAN does not exist. Creating vlan 30

SW1(config-if-range)#
SW1(config-if-range)#int g0/1
SW1(config-if)#switchport mode trunk 
SW1(config-if)#
%LINEPROTO-5-UPDOWN: Line protocol on Interface GigabitEthernet0/1, changed state to down
%LINEPROTO-5-UPDOWN: Line protocol on Interface GigabitEthernet0/1, changed state to up

SW1(config-if)#sw trunk allowed vlan 10,30
SW1(config-if)#sw tr native vlan 1001
SW1(config-if)#exit
```

###### SW2 Configuration

```sh
SW2(config-if)#int g0/1
SW2(config-if)#switchport mode trunk 
SW2(config-if)#switchport trunk native vlan 1001
SW2(config-if)#switchport trunk allowed vlan 10,30

SW2(config-if)#int f0/1
SW2(config-if)#switchport mode access 
SW2(config-if)#switchport access vlan 20
% Access VLAN does not exist. Creating vlan 20

SW2(config-if)#int range f0/2-3
SW2(config-if-range)#switchport mode access 
SW2(config-if-range)#sw access vlan 10
% Access VLAN does not exist. Creating vlan 10

SW2(config)#int g0/2
SW2(config-if)#switchport mode trunk 
SW2(config-if)#switchport trunk allowed vlan 10,20,30
SW2(config-if)#switchport trunk native vlan 1001
SW2(config-if)#exit
SW2(config)#
```

###### R1 Configuration

```sh
R1(config)#int g0/0
R1(config-if)#no shutdown
R1(config-if)#
%LINK-5-CHANGED: Interface GigabitEthernet0/0, changed state to up
%LINEPROTO-5-UPDOWN: Line protocol on Interface GigabitEthernet0/0, changed state to up

R1(config-if)#int g0/0.10
R1(config-subif)#encapsulation dot1Q 10
R1(config-subif)#ip address 10.0.0.62 255.255.255.192

R1(config-subif)#int g0/0.20
R1(config-subif)#encapsulation dot1Q 20
R1(config-subif)#ip address 10.0.0.126 255.255.255.192

R1(config-subif)#int g0/0.30
R1(config-subif)#encapsulation dot1Q 30
R1(config-subif)#ip address 10.0.0.190 255.255.255.192
R1(config-subif)#end
R1#
```

###### 如上配置后, 发现VLAN10与VLAN20的PC之间可以相互Ping通, 但是都无法ping通VLAN30的PC, 原因何在?

>   问题就出在SW2! 虽然SW2的 g0/1 的 allowed VLAN 放行了 VLAN 30, 但是其本身并未创建过 VLAN 30, 导致SW2可以收到VLAN 30的Ethernet Frame, 但是并不知道怎么处理, 而是直接丢弃.
>
>   >   注意: **Make sure all necessary VLANs exist on each switch!**
>
>   ###### 解决方法:
>
>   **在SW2上创建 VLAN 30**:
>
>   ```sh
>   SW2(config)#vlan 30
>   SW2(config-vlan)#exit
>   ```

```sh
SW2#show vlan brief
VLAN Name                             Status    Ports
---- -------------------------------- --------- -------------------------------
1    default                          active    Fa0/4, Fa0/5, Fa0/6, Fa0/7
                                                Fa0/8, Fa0/9, Fa0/10, Fa0/11
                                                Fa0/12, Fa0/13, Fa0/14, Fa0/15
                                                Fa0/16, Fa0/17, Fa0/18, Fa0/19
                                                Fa0/20, Fa0/21, Fa0/22, Fa0/23
                                                Fa0/24
10   VLAN0010                         active    Fa0/2, Fa0/3
20   VLAN0020                         active    Fa0/1
30   VLAN0030                         active   # important! Make sure all necessary VLANs exist on each switch!

SW2#sh interfaces trunk 
Port        Mode         Encapsulation  Status        Native vlan
Gig0/1      on           802.1q         trunking      1001
Gig0/2      on           802.1q         trunking      1

Port        Vlans allowed on trunk
Gig0/1      10,30
Gig0/2      10,20,30

Port        Vlans allowed and active in management domain
Gig0/1      10,30  # 创建 VLAN 30 后, 就可以发现 30 存在于 management domain 了
Gig0/2      10,20,30

Port        Vlans in spanning tree forwarding state and not pruned
Gig0/1      10,30
Gig0/2      10,20,30
```



#### 使用Layer 3 Switch

>   -   **ROAS** is efficient in terms of the number of interfaces, just one, but in a busy network all of the traffic going to the router and back to the switch can cause network congestion.
>   -   So, in large networks, a **multilayer switch** is the preferred method of inter-VLAN routing.

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222008224.png" alt="image-20230322200853971" style="zoom:20%;" />

> ##### Layer-3 交换机, 
>
> -   又称为 **Multi-layer Switch**，如Cisco 3560交换机或 6500等高端交换机。
>
> - A multilayer switch is capable of both **switching** AND **routing**;
> - IP addresses can be assigned to its interfaces, like a router.
> - You can create **virtual interfaces** for each VLAN, and assign IP addresses to those interfaces.
> - You can configure routes on it, just like a router. 
> - It can be used for inter-VLAN routing.

##### Inter-VLAN Routing via SVI

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222026704.png" alt="image-20230322202607365" style="zoom:33%;" />

>   -   **SVIs (Switch Virtual Interface)** are the **virtual (VLAN) interfaces** you can assign IP addresses to in a multilayer switch.
>   -   SVI is a special virtual Interface on the Layer-3 Switch, can be checked via `show interfaces brief`. Normally they will be at the bottom at the interface list.
>   -   After configuration, each PC in its VLAN will use the SVI (NOT the router) as their gateway address.
>
>   
>
>   ###### Requirements for an SVI to be UP/UP:
>
>   1.   The specific VLAN must exist on the switch; The VLAN must not be shutdown. (You can enter VLAN configuration mode, and disable the VLAN with the `SHUTDOWN` command.)
>   2.   The switch must have **at least one access port in the VLAN** in an **up/up** state, AND/OR one **trunk port** that allows the VLAN that is in an **up/up** state.
>   3.   The SVI must not be shutdown (SVIs are disabled by default)

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222030079.png" alt="image-20230322203027759" style="zoom:33%;" />

###### Configuration

Step 1. 将ROAS路由器的虚拟端口清除, 恢复物理接口的默认设置

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222032350.png" alt="image-20230322203229969" style="zoom:33%;" />

>   -   Although we have successfully deleted the subinterfaces, they will remain here with a ‘deleted’ status unless we reload the router.
>   -   `**default interface** *interface*`: Reset an interface to its default configuration;

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222034898.png" alt="image-20230322203418727" style="zoom:33%;" />

---

Step 2. 恢复单臂路由的另一端的三层交换机的接口为默认配置; 开启 `ip routing`的功能; 将其接口设置为`routed port`, 并绑定IP地址

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222035093.png" alt="image-20230322203523756" style="zoom:33%;" />

>   -   `SW(config)# ip routing` enables **Layer 3 IP routing function** on the switch;
>   -   `SW(config-if)# no switchport` configures the interface on a switch as **routed port**, not Layer-2 port/Switchport any more. After that, you can assign an IP address on the routed port.

---

Step 3. 在三层交换机上配置Default Route指向路由器

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222040055.png" alt="image-20230322204019886" style="zoom:35%;" />

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222041288.png" alt="image-20230322204133996" style="zoom:37%;" />

---

Step 4. 在三层交换机上创建 SVI, 配置IP地址并`no shutdown`;

>   ###### 创建 SVI on the Layer-3 switch:
>
>   1.   确保 `SW(config)# ip routing`已经执行, 开启了 Layer-3 ip routing 功能
>   2.   `SW(config)# interface vlan VLAN_ID`: 即可创建 SVI; 然后就可以指定 IP 地址了;
>   3.   默认SVI是 shutdwon 状态, 指定IP地址后, 需要执行 `SW(config-if)#no shutdown`

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303222042214.png" alt="image-20230322204246840" style="zoom:28%;" />



### VTP

> -   stands for (VLAN Trunking Protocol), **Cisco proprietary protocol** that allows you to configure VLANs on a central VTP server switch, and other switches (VTP clients) will synchronize their VLAN database to the server. 
>
> - The basic goals of VLAN Trunking Protocol (VTP) are to **manage all configured VLANs across a switched internetwork and to maintain consistency** throughout that network. VTP allows you to add, delete, and rename VLANs—information that is then propagated to all other switches in the VTP domain.
>
> - There are three VTP versions: 1, 2, and 3.
>
>     >   VTP V2 is not much different than VTP V1. The major difference is that VTP V2 introduces support for Token Ring VLANs. If you use Token Ring VLANs, you must enable VTP V2. Otherwise, there is no reason to use VTP V2. VTP V3 is beyond the scope of CCNA.
>
> - Note that VTP only syncs the VLAN database, VTP does not automatically assign interfaces to VLANs. You still have to configure the interfaces on each switch separately, for example `switchport access vlan 10`, etc.
>
> - It is rarely used, and it is recommended that you do not use it.



> Here’s a list of some of the **cool features** VTP has to offer:
> - Consistent VLAN configuration across all switches in the network;
> - VLAN trunking over mixed networks, such as Ethernet to ATM LANE or even FDDI;
> - Accurate tracking and monitoring of VLANs;
> - Dynamic reporting of added VLANs to all switches in the VTP domain;
> - Adding VLANs using Plug and Play(以即插即用的方式);

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621195238427.png" alt="image-20220621195238427" style="zoom:40%;" />

> VTP(VLAN Trunking Protocol): (思科专有协议), 在多个交换机之间同步VLAN配置信息的协议,
>
> - 通过一个共有的管理域, 维持所有交换机的VLAN配置(借助修订号 Configuration Revision number)的一致性;
> - 交换机间互相的接口要设置为Trunk mode, 即VTP只能在*Trunk Link*传播 VTP advertisement;
> - 支持混合的介质主干连接(Fast Ethernet, FDDI, ATM)

#### 交换机的三种VTP模式

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621195404942.png" alt="image-20220621195404942" style="zoom:40%;" />

> - ==Server== mode:
>     - **default** mode for all Catalyst switches;
>     - at least one server exists in your VTP domain to **propagate** VLAN information throughout that domain;
>     - **can add/modify/delete** VLANs;
>     - VLAN database **stored in NV-RAM**(Non-volatile RAM) on the switch.
>     - Will increase the **revision number** every time a VLAN is added/modified/deleted. 
>     - Will advertise the latest version of the VLAN database on trunk interfaces, and the VTP clients will synchronize their VLAN database to it.
>     - VTP servers also function as *VTP clients*. Therefore, a VTP server will synchronize to another VTP server with a higher revision number.
>
> 
>
> - ==Client== mode:
>
>     - receive and forward VTP advertisements;
>
>         - Will synchronize their VLAN database to the server with the highest revision number in their VTP domain;
>
>         - Will advertise their VLAN database, and forward VTP advertisements to other clients over their trunk ports.
>
>     - **can’t add/modify/delete** VLANs.
>
>     - Do not store the VLAN database in NVRAM. (in VTPv3, they do)
>
>         
>
> - ==Transparent== mode:
>    - don’t participate in the VTP domain or sync its VLAN database, but they’ll **still forward VTP advertisements that are in the same domain as it** through trunk ports.
>     - **can create/modify/delete** VLANs because they keep their own database — one they keep secret from the other switches.
>     - Despite being kept in NVRAM, the VLAN database in transparent mode is actually only locally significant.
>     - The whole purpose of transparent mode is to **allow remote switches to receive the VLAN database from a VTP server-configured switch through a switch that is not participating in the same VLAN assignments**.

> Note:
>
> -   **VTP version_1 & version_2 only learns about normal-range VLANs, with VLAN IDs 1 to 1005**; *VLANs with IDs greater than 1005 are called extended-range VLANs and they’re not stored in the VLAN database*. 
> -   Changing the **VTP domain** to an **unused domain** will reset the revision number to 0. 
> -   Changing the **VTP mode to transparent** will also reset the revision number to 0.
> -   **Remember, Switch in transparent mode within a different domain will NOT forward the VTP advertisements to other switches.**

#### VTP的运行模式

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621195839843.png" alt="image-20220621195839843" style="zoom:40%;" />

> 多台交换机配置VTP，必须满足如下三项要求:
>
> - 交换机的VTP domain name要相同;
> - 其中一台交换机要配置为VTP Server;(事实上，思科建议让所有交换机都处于VTP服务器模式)
> - VTP password要一致(如果使用了的话)。

#### VTP的基本配置

```sh
SW1(config)# vtp version ?  # 1, 2, 3
SW1(config)# vtp mode ?
  client       Set the device to client mode.
  off          Set the device to off mode.
  server       Set the device to server mode.
  transparent  Set the device to transparent mode.
  
SW1(config)# vtp domain VTP域名    # 设置VTP域名
SW1(config)# vtp password VTP密码  # 可不配置VTP密码, 但是配置了的话, A switch will reject any VTP advertisement if the password doesn’t match.


SW1(config)# vtp pruning


SW1# show vtp password
SW1# show vtp status   # 查看 VTP 的配置
```

> ==Tips==:
>
> -   所有思科交换机默认的VTP模式是 Server;
> 2. VTP的域名和密码均对大小写敏感;
> 2. A switch will reject any VTP advertisement if the password doesn’t match.
> -   VTP pruning 默认是关闭的;
> -   **If a switch with no VTP domain (domain NULL) receives a VTP advertisement with a VTP domain name, it will automatically join that VTP domain.**
> -   If a switch receives a VTP advertisement in the same VTP domain with a higher revision number, it will update it's VLAN database to match.
>
> >   ###### One danger of VTP: 
> >
> >   -   If you connect an *old switch with a higher revision number* to your network (and *the VTP domain name matches*), all switches in the domain will sync their VLAN database to that switch, which could cause all of the hosts on your network to instantly lose connectivity. 
> >
> >   **This is one reason why VTP is usually not used in modern networks.**
> >
> >   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303232334911.png" alt="image-20230323233433569" style="zoom:30%;" />
> >
> >   -   if you’re going to plug an old switch with a high revision number into a network, that uses VTP, make sure to reset the revision number with one of these methods first:
> >
> >       -   Changing the **VTP domain** to an unused domain will reset the revision number to 0. 
> >
> >       -   Changing the **VTP mode to transparent** will also reset the revision number to 0.
> >
> >       After that, change it back to the same VTP domain OR VTP mode into Client

```sh
R2#show vtp status
VTP Version capable             : 1 to 3
VTP version running             : 1
VTP Domain Name                 : CCNA-1
VTP Pruning Mode                : Disabled
VTP Traps Generation            : Disabled
Device ID                       : aabb.cc80.2000
Configuration last modified by 0.0.0.0 at 6-21-22 21:17:01

Feature VLAN:
--------------
VTP Operating Mode                : Server
Maximum VLANs supported locally   : 1005  # VTP version 1 & 2 don't support Extended VLAN range(1006~4094)
Number of existing VLANs          : 15
Configuration Revision            : 5     # 此为 修订号
MD5 digest                        : 0x1F 0x23 0x1C 0x58 0xCB 0xA7 0x43 0x03 
                                    0x6F 0x6E 0x10 0x54 0x1E 0x91 0xAC 0xEC 
```

#### VTP pruning

> - 默认情况下，所有 VLAN的数据流 都可通过Trunk Link进行传输;
> - VTP Pruning可以自动修剪开不参与VLAN配置同步的交换机链路; VTP gives you a way to preserve bandwidth by configuring it to reduce the amount of broadcasts, multicasts, and unicast packets. This is called **pruning**. Switches enabled for VTP pruning send broadcasts only to *trunk links* that actually must have the information.
> - 默认情况下，所有交换机都禁用了VTP修剪; 在VTP服务器上启用修剪后，将在整个VTP域中启用它。
> - 默认情况下，修剪将用于VLAN 2 ~ 1001, 但对VLAN 1不会修剪，因为它是一个默认的 Native VLAN.

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220621232836287.png" alt="image-20220621232836287" style="zoom:50%;" />

```sh
SW1#config t
SW1(config)#int f0/1
SW1(config-if)#switchport trunk ?
    allowed Set allowed VLAN characteristics when interface is
    in trunking mode
    native Set trunking native characteristics when interface
    is in trunking mode
    pruning Set pruning VLAN characteristics when interface is
    in trunking mode
SW1(config-if)#switchport trunk pruning ?
    vlan Set VLANs enabled for pruning when interface is in trunking mode
SW1(config-if)#switchport trunk pruning vlan 3-4
```





## Voice VLAN

>  The voice VLAN feature enables **access ports** to *carry IP voice traffic from an IP phone*. When a switch is connected to a Cisco IP phone, the IP phone sends voice traffic with **layer 3 IP precedence and layer 2 class of service (CoS) values**, which are *both set to 5 for voice traffic; all other traffic defaults to 0.*
>
>  Because the sound quality of an IP phone call can deteriorate(恶化) if the data is unevenly sent, the switch supports **quality of service (QoS)** based on IEEE 802.1p CoS. (802.1p provides a mechanism for implementing QoS at the Data Link level.) The 802.1p field is carried in the 802.1Q trunk header. If you look at the fields in an 802.1Q tag, you will see a field called the **priority** field; this is where the 802.1p information goes. *QoS uses classification and scheduling to send network traffic from the switch in an organized, predictable manner.*

> 思科IP电话基本上是一台三端口交换机:一个连接到思科交换机，一个连接到PC，还有一个端口位于内部，连接的是电话本身。
>
> - 思科IP电话是一种可配置的设备，可对其进行配置，使其在发送的数据流中包含IEEE 802.1p 优先级。
> - 还可配置交换机，使其信任或覆盖IP电话指定的优先级

> 对于与思科IP电话相连的接入端口，可对其进行配置，使其将一个VLAN用于语音数据流，并将另一个VLAN用于与电话相连的设备(如PC)的数据流。可对交换机的接入端口进行配置，使其发送思科发现协议(CDP)分组，设置相连的思科IP电话以下述方式之一将语音数据流发送给交换机:
>
> - 通过语音VLAN发送，并添加一个第2层CoS优先级值;
> - 通过接入VLAN发送，并添加一个第2层CoS优先级值;
> - 通过接入VLAN发送，但不添加第2层CoS优先级值。

> The switch can also process **tagged data traffic** (traffic in IEEE 802.1Q or IEEE 802.1p frame types) *from the device attached to the access port on the Cisco IP phone*. You can configure layer 2 access ports on the switch to send CDP packets that instruct the attached Cisco IP phone to configure **the IP phone PC access port** in one of these modes:
>
> - In **trusted** mode, all traffic received through the access port on the Cisco IP phone passes through the IP phone **unchanged**.
> - In **untrusted** mode, all traffic in IEEE 802.1Q or IEEE 802.1p frames received through the access port on the IP phone receive a configured layer 2 CoS value. The default layer 2 CoS value is 0. **Untrusted mode is the default.**

### Configuring the Voice VLAN

> **By default, the voice VLAN feature is disabled**; you enable it by using the interface command `switchport voice vlan`. When the voice VLAN feature is enabled, all untagged traffic is sent according to the **default CoS priority** of the port. The CoS value is not trusted for IEEE 802.1p or IEEE 802.1Q tagged traffic.
>
> ==These are the voice VLAN configuration guidelines==:
>
> - You *should configure a voice VLAN on switch access ports*; voice VLAN isn’t supported on trunk ports, even though you can actually configure it!
> - The voice VLAN should be present and active on the switch for the IP phone to correctly communicate on it. Use the `show vlan` privileged EXEC command to see if the voice VLAN is present--if it is, it’ll be listed in the display.
> - Before you enable the voice VLAN, it’s recommended that you **enable QoS** on the switch by entering the `mls qos` global configuration command and set the port trust state to trust by entering the `mls qos trust cos` interface configuration command.
> - You must make sure that CDP is enabled on the switch port connected to the Cisco IP phone to send the configuration. This is on by default, so unless you disabled it, you shouldn’t have a problem.
> - The PortFast feature is automatically enabled when the voice VLAN is configured, but when you disable the voice VLAN, the PortFast feature
>       isn’t automatically disabled.
> - To return the port to its default setting, use the `no switchport voice vlan` interface configuration command.

### Configuring IP Phone Voice Traffic

> You can configure a port connected to the Cisco IP phone to send CDP packets to the phone in order to configure how the phone sends voice traffic.
>
> - The phone can carry voice traffic in IEEE 802.1Q frames for a specified voice VLAN with a layer 2 CoS value.
> - It can use IEEE 802.1p priority tagging to give voice traffic a higher priority as well as forward all voice traffic through the access VLAN instead of the native (access) VLAN.
> - The IP phone can also send untagged voice traffic or use its own configuration to send voice traffic in the access VLAN.
> - **In all configurations, the voice traffic carries a layer 3 IP precedence value—again, for voice the setting is usually 5.**

> I think it’s about time to give you some actual examples to make this clear to you. This example shows you how to configure four things:
>
>   1. How to configure a port connected to an IP phone to use the **CoS value** for classifying incoming traffic
>   2. How to configure the port to **use IEEE 802.1p priority tagging** for voice traffic
>   3. How to configure it to use the Voice VLAN (10) to carry all voice traffic
>   4. And last, how to configure VLAN 3 to carry PC data
>
>   ```sh
>   Switch#configure t
>   Switch(config)#mls qos
>   Switch(config)#interface f0/1
>   Switch(config-if)#switchport priority extend ?
>       cos Override 802.1p priority of devices on appliance
>       trust Trust 802.1p priorities of devices on appliance
>   Switch(config-if)#switchport priority extend trust
>   Switch(config-if)#mls qos trust cos
>   Switch(config-if)#switchport voice vlan dot1p
>   Switch(config-if)#switchport mode access
>   Switch(config-if)#switchport access vlan 3
>   Switch(config-if)#switchport voice vlan 10
>   ```
>

---

