---
title: TCP/IP Suite
date: 2022-07-13 12:26:14
permalink: /pages/0cd5e5/
categories:
  - 网络运维
  - CCNA
  - CCNA知识笔记
tags:
  - 
---
# TCP/IP Suite

![image-20220615190031467](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202206151900569.png)

## TCP/IP Suite

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202206151907527.png" alt="查看源图像" style="zoom: 50%;" />



> -   Conceptual model and set of communications protocols used in the Internet and other networks. 
> -   Known as TCP/IP because those ave two of the foundational protocols in the suite. 
> -   Developed by the **United States Department of Defense** through *DARPA* (Defense Advanced Research Projects Agency) 
> -   Similar structure to the OSI Model, but with fewer layers. 
> -   This is the model actually " in use in modern networks, rather than OSI Model. 
>
> >   NOTE: The OSI model still influences how network engineers think and talk about networks.

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303151019387.png" alt="image-20230315101937138" style="zoom:33%;" />

>   The Link layer might be called the network interface, or network access layer.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303151021783.png" alt="image-20230315102146415" style="zoom: 45%;" />



## Network Topology and Data Flow

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303151025329.png" alt="image-20230315102504106" style="zoom:43%;" />

## TCP/IP协议中常用的网络命令

```sh
ping
ipconfig（windows）
ipconfig /release
ipconfig /renew

ifconfig（类unix）
arp
tracert  traceroute
route
nslookup
nbtstat（windows）
netstat
net （windows）
telnet
mstsc(windows)
netsh(windows)
tcpdump(linux)
```

## 网络抓包工具

>   -   wireshark
>   -   tcpdump



# 进程/应用层协议

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220705163601407.png" alt="image-20220705163601407" style="zoom:67%;" />

## Telnet

终端模拟, 它让远程客户端机器(Telnet 客户端)的用户能够访问另一台机器(Telnet 服务器)的资源。

==端口号==:

- TCP 23

## FTP

FTP(File Transfer Protocol，文件传输协议)

- 使用了 TCP 协议, 面向连接;
- 以明文方式发送用户名和密码，根本没有加密

==功能:==

- 传输文件;
- 列出和操作目录、输入文件内容以及在主机之间复制文件，而不能远程执行程序。

- 通过FTP 访问主机只是第一步，随后用户必须通过身份验证登录，因为系统管理员可能使用密码和用户名来限制访问。要避开这种身份验证，可使用用户名anonymous，但这样获得的访问权将受到限制。

==端口号==:

- TCP 21

## TFTP

TFTP (Trivial File Transfer Protocol ，简单文件传输协议)是FTP 的简化版，

- 使用了 UDP 协议

==功能==:

- TFTP 没有提供目录浏览功能，除发送和接收文件外什么也不能做。
- 这个紧凑的小协议的开销很小，它发送的数据块比FTP 发送的小得多，
- 也不像FTP 那样需要进行身份验证，因此更不安全。鉴于这种固有的安全风险，支持它的网站很少。

==端口号==:

- UDP 69

## NFS

NFS (NetworkFile System ，网络文件系统)是一种致力于文件共享的协议，让两种不同的文件系统能够互操作。其工作原理大致如下: 假设NFS服务器端软件运行在Windows服务器上，而NFS 客户端软件运行在Unix 主机上， NFS 让Windows 服务器的部分RAM 看起来像存储的是Unix 文件，可被Unix 用户使用。虽然Windows 文件系统和Unix 文件系统不同一一它们在是否区分大小写、文件名长度、安全性等方面不同，但Unix用户和Windows用户可像通常那样访问相同的文件，就像文件位于他们通常使用的文件系统中一样。

## SMTP

SMTP (Simple Mail Transfer Protocol ，简单邮件传输协议)

- 它使用假脱机(排队)的方式传递邮件。邮件到达目的地后，将被存储到设备(通常是磁盘)中。目标
    端的服务器软件定期检查队列，看其中是否有邮件。发现邮件后，它将把它们投递给收件人。
- SMTP用于发送电子邮件，而 POP3 或 IMAP 用于接收邮件。

## POP

POP (Post Office Protocol ，邮局协议)提供了一种对到来邮件进行存储的机制，其最新版本为POP3. 这种协议的工作原理如下:客户端设备连接到 POP3 服务器后，可下载发送给它的邮件。它不允许选择性地下载邮件，但邮件下载后，客户端/服务器交互就结束了，用户可在本地随意删除和操作邮件。接下来将介绍一种更新的标准 IMAP ，它正逐渐取代POP3 ，这是什么原因呢?

==端口号==:

- TCP 110

## IMAP4

由于IMAP4 (Internet Message Access Protocol ，因特网消息访问协议)让你能够查看邮件头或下载邮件的一部分，因此使用它可获得亟需的安全性。

IMAP 甚至提供了搜索命令，让你能够根据主题、邮件头或内容搜索邮件。可以想见，它提供了一些身份验证功能一一实际上它支持MIT 开发的Kerberos 身份验证方案。IMAP4 是最新的版本。

## TLS

TLS (Transport Layer Security，传输层安全)及其前身SSL (Secure Sockets Layer，安全套接字
层)都是加密协议，非常适合用于确保在线数据传输的安全，如Web浏览、即时通信、因特网传真等。它们极其相似，本书不详细介绍它们之间的差别。

## SIP (VoIP)

SIP (Session lnitiation Protocol ，会话发起协议)是一种非常流行的信令胁议，用于建立和拆除多媒体通信会话，其应用非常广泛，可用于因特网上的语音和视频呼叫、视频会议、流媒体分发、即时通信、状态信息( presence infonnation )、在线游戏等。

## RTP

RTP(Real-time Transport Protocol，实时传输协议)是一种分组格式标准，用于通过因特网传输语音和文本. RTP (VoIP)语音和视频。虽然它最初被设计为一种组播协议，但现在也被用于单播应用程序中。它常被用于流式媒体、视频会议和一键通(push to talk)系统，这使其成了VoIP (Voice over IP ，IP语音)行业的事实标准。

## LDP

LDP (Line Printer Daemon ，行式打印机守护进程)协议设计用于共享打印机。LPD 和LPR (Line Printer ，行式打印机)程序相互协作，使得能够将打印作业排队并使用 TCP/IP 将其发送给网络打印机。

## LPR

在纯粹的TCP/IP 环境中打印时，人们通常结合使用LPR (行式打印机)和LPD (Line Printer Daemon ，行式打印机守护进程)来完成打印作业。LPD 安装在所有打印设备上，负责处理打印机和打印作业。LPR 运行于客户端(发送主机)，用于将数据从主机发送到网络打印资掘，让你能够得到打印输出。

## X Window

XWindow 是为客户端/服务器操作设计的， 是一种编写基于GUI (Graphical User Interface ，图形用户界面)的客户端/服务器应用程序的协议。其基本思想是，让运行在一台计算机上的客户端程序能够通过窗口服务器显示另一台计算机的内容。

## SNMP

SNMP (Simple Network Management Protocol ，简单网络管理协议)收集并操作有价值的网络信息。

- 它运行在管理工作站上，定期或随机地轮询网络中的设备，要求它们暴露特定的信息，以收集数据。
- 在一切正常的情况下， SNMP 将收到基线(baseline) 信息， 即描述健康网络运行特征的报告。
- 该协议还可充当网络的看门狗，将任何突发事件迅速告知管理员。这些网络看门狗称为代理，出现异常情况时，代理将向管理工作站发送称为trap 的警告。

> 使用 TCP 和 UDP 协议

## SSH

SSH(Secure Shell protocol) 通过标准TCP/IP 连接建立安全的Telnet 会话，用于执行如下操作:登录系
统、在远程系统中运行程序以及在系统间传输文件等。它在执行这些操作时都使用健壮的加密连接。你可将其视为用于替代rsh 、rlogin 甚至 Telnet 的新一代协议。

## HTTP

HTTP (Hypertext Transfer Protocol,超文本传输协议)所赐。它用于管理Web 浏览器和Web 服务器之间的通信，在你单击链接时打开相应的资源，而不管该资源实际位于何地。

## HTTPS

HTTPS(Hyper text Transfer Protoco1 Secure ，安全超文本传输协议)使用 SSL ( Secure Socket Layer ,安全套接字层)，它是安全版的HTTP ，提供了一系列安全工具，可确保Web 浏览器和Web 服务器之间的通信安全。当你在网上预订或购物时，浏览器需要使用它来填写表格、签名、验证和加密HTTP 消息。

## NTP

NTP (Network Time Protocol，网络时间协议)用于将计算机时钟与标准时间源(通常是原子钟)同步, NTP 将设备同步，确保给定网络中所有计算机的时间一致。这虽然昕起来非常简单，但却非常重要.

## NNTP

NNTP (Net明明kNews TransferProtoco1 ，网络新闻传输协议)用于访问Usenet 新闻服务器，这种服务器存储了大量称为新闻组的留言板。

## SCP

SCP (Secure Copy Protoco1 ，安全复制协议)可提供帮助，它通过SSH保护你宝贵的文件。它首先在发送主机和接收主机之间建立一条安全的加密连接，并一直保持这种状态，直到文件传输完毕。然而，在当今的网络中，更健壮的 SFTP 比SCP 更常用。

## LDAP

如果管理的网络规模适当，你很可能会在某个地方存储目录，记录所有的网络资源，如设备和用户。但如何访问这些目录呢?通过LDAP (Lightweight Directory Access Protocol ，轻量级目录访问协议)。该协议对如何访问目录进行了标准化.

## IGMP

IGMP (Internet Group Management Protocol，因特网组管理协议)是一种用于管理IP 组播会话的TCP/IP 协议，它这样完成其职责:通过网络发送唯一的IGMP 消息，以揭示组播组信息，并找出主机所属的组播组。IP网络中的主机也使用IGMP 消息来加入和退出组播组。IGMP消息非常方便用于跟踪组成员关系以及激活组播流。

## DNS

DNS (Domain Name Serv肘，域名服务)解析主机名，具体地说是因特网名称，如www.routersim.com。

- DNS 用于解析FQDN (Fully Qualified Domain Name ，全限定域名)，如www.lammle.com 或
    todd.lamm1e.com.
- FQDN 是一种层次结构，可根据域名标识符查找系统。如果要解析名称todd ，则要么输入FQDN todd.lammle.com ，要么让设备(如PC 或路由器)帮助你添加后级。例如，在思科路由器中，你可使用命令`ip domain-name lammle.com` 给每个请求加上域名 lammle.com。如果不这样做，则你必须输入FQDN ，这样DNS 才能对名称进行解析。

> 有关DNS 需要牢记的一个重点是，如果能够使用IP地址ping某台设备，但使用其FQDN不管用，则可能是DNS配置有问题。

==端口号==:

- TCP UDP 53

## DHCP

==端口号==:

- 67

DHCP ( Dynamic Host Configuration Protocol ，动态主机配置协议)给主机分配IP地址，让管理工
作更轻松，非常适合用于各种规模的网络。各种类型的硬件都可用作DHCP 服务器，包括思科路由器。

- DHCP 与BootP (Bootstrap Protocol ，自举协议)的差别在于， BootP 给主机分配田地址，但必须
    手工将主机的硬件地址输入到BootP表中。你可将DHCP 视为动态的BootP 。但别忘了， BootP也可用于发送操作系统，让主机使用它启动，而DHCP没有这样的功能。

- 主机向DHCP 服务器请求IP 地址时， DHCP 服务器可将大量信息提供给主机。下面是DHCP服务器可提供的信息列表:

  - IP 地址;
  - 子网掩码:
  - 域名;
  - 默认网关(路由器);
  - DNS 服务器的地址:
  - WINS 服务器的地址。

- 为获得IP地址而发送 DHCP发现消息的主机在第2层和第3层都发送广播:

  - 第2 层广播的地址在十六进制表示下全为F ，即FF:FF:FF:FF:FF:曰:
  - 第3 层广播的地址为255.255.255.255 ，这表示所有网络和所有主机。

- DHCP 是无连接的，这意味着它在传输层使用UDP(用户数据报协议)，这层也叫主机到主机层，稍后将介绍它。

    ![image-20220705145532388](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220705145532388.png)

> 客户端向DHCP 服务器请求IP 地址的4个步骤如下:
> (1) DHCP 客户端广播一条 DHCP Discover 消息，旨在寻找**DHCP 服务器(端口67)**;
> (2) 收到DHCP Discover消息的DHCP服务器向主机发回一条单播DHCP Offer消息;
> (3) 客户端向服务器广播一条DHCP Request消息，请求提议的IP地址和其他信息:
> (4) 服务器以单播方式发回一条DHCP ACK消息，完成交互。
>
> > ==DHCP 冲突==:
>   >
> > 两台主机使用相同的IP地址时，就发生了DHCP地址冲突。如果检测到IP 地址冲突，相应的IP 地址将从DHCP 地址池中删除;且在管理员手工解决冲突前，该地址不全被分配给任何主机，牢记这一点很重要。

## APIPA

Windows 提供了APIPA (Automatic Private IP Addressing ，自动私有IP编址)

- 客户端可在DHCP 服务器不可用时自动给自己配置IP 地址和子网掩码(主机用来通信的基本IP 信息).
- APIPA 使用的IP地址范围为 `169.254.0.1`-`169.254.255.254` ，客户端还会给自己配置默认的B 类子网掩码一`255.255.0.0`。

# 传输层协议

## TCP协议

- TCP (Transmission Control Protocol ，传输控制协议)接收来自应用程序的大型数据块，并将其划分成数据段。它给每个数据段编号，让接收主机的TCP 技能够按应用程序希望的顺序排列数据段。发送数据段后，发送主机的TCP 等待来自接收端TCP 的确认，并重传未得到确认的数据段。

- 发送主机开始沿分层模型向下发送数据段之前，发送方的TCP栈与目标主机的TCP栈联系，以建立连接。它们创建的是虚电路，这种通信被认为是面向连接的。在这次初始握手期间，两个TCP栈还将就如下方面达成一致:在接收方的TCP 发回确认前，将发送的信息量。
- TCP 是一种可靠的精确协议，它采用全双工模式，且面向连接，但需要就所有条款和条件达成一致，还需进行错误检查，这些任务都不简单。TCP 很复杂，且网络开销很大，这没有什么可奇怪的。鉴于当今的网络比以往的网络可靠得多，这些额外的可靠性通常是不必要的。大多数程序员都使用TCP，因为它消除了大量的编程工作，但实时视频和VoIP使用UDP ，因为它们无法承受额外的开销。

### 报文段的数据格式

![img](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202206151908919.jpeg)

> TCP 报文的报头为 20 Bytes(包含选项时为 24 Bytes)
>
> - **源端口和目的端口**: 分别为*16bit*,用于标记源端和目的端的端口号
> - **序号Seq（Sequence Number）**: 序号占*32bit*，用来标识从计算机A发送到计算机B的数据包的序号,
> - TCP 用来将数据按正确的顺序重新排列(称为排序)、重传丢失或受损的数据。
> - **确认号Ack（Acknowledge Number)**: 确认号占*32bit*，TCP 期待接下来收到的数据段。客户端和服务器端都可以发送，*Ack = Seq + 1*; 也可用于*三次和四次握手*机制;
> - **数据偏移**: TCP 报头的长度，指示TCP数据部分的偏移量, 以32bit为单位。
> - **保留**: 总是设置为0
> - **标志位6个**: 分别为*1bit*, 用于建立和终止会话的控制功能。
>   - URG: 确定`紧急指针`是否生效
>   - ACK: 确定`确认号`生否生效
>   - PSH: 接收方是否需要尽快将这个报文交给应用层
>   - RST: 重置连接的标志位
>   - SYN: 发起新连接的标志位
>   - FIN: 释放连接的标志位
> - **窗口大小**: 发送方愿意接受的窗口大小, 单位为Byte
> - **校验和CRC**: (Cyclic Redundancy Check，循环冗余校验)，由于TCP不信任低层，因此检查所有数据。CRC 检查报头和数据字段。
> - **紧急指针**: 仅当设置了编码位中的紧急指针字段时，该字段才有效。如果设置了紧急指针，该字段表示非紧急数据的开头位置相对于当前序列号的偏移量，单位为字节。
> - **选项**: 长度为0或32位的整数倍。也就是说，没有选项时，长度为0。然而，如果包含选项时导致该字段的长度不是32位的整数倍，必须填充零，以确保该字段的长度为32位的整数倍。

### TCP`三次握手`建立连接的机制

![三次握手](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/e095cdb6ee5e9927e31a39fddb0b1fb0.png)

### TCP`四次握手`释放连接的机制

**双向断开连接的通知与确认造成了`四次握手`:**

![TCP和四次挥手](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202206151906344.png)

### DOS攻击和 DDoS

> DoS(Denial of Service) 的原理:
>
> - 攻击者发起大量的TCP连接请求, 占用掉服务器的带宽/CPU等资源, 导致服务器无法为其他正常用户提供服务;
>
> DDoS(Distributed Denial of Service):
>
> - 攻击者组织*大量主机*同时向服务器发起TCP连接请求;

### 滑动窗口

TCP的滑动窗口是以字节为单位的。TCP全双工通信，通信中的每一方都在发送和接收报文段。每一方都有自己的发送窗口和接收窗口。

#### 发送窗口

> 发送窗口由`SND.WND`, `SND.UNA` 和 `SND.NXT`这三个指针进行维护。

> **发送缓冲区**分为四个部分：
>
>   1. 已经收到ack包的数据: 代表接收窗口已经接收了对应的数据，可以被新数据覆盖。
>
>   2. 已经发送还未接收到ack包的数据: 已经发送出去，但是还未收到接收方对应的ack包
>
>   3. 允许发送但是还未发送的数据;
>
>   4. 不允许发送的数据: 发送窗口之外的数据，排队等待后续发送。

![在这里插入图片描述](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202206152350619.png)

这时还允许发送数据，就会将可用窗口中的数据发送给接收窗口。

![在这里插入图片描述](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202206152358247.png)

这个时候，可用窗口大小为0，这个时候会等待接收方发送ack包。

如果这个时候如果接收一个ack包为37，这个时候发送窗口会向右边移动5位，52-56会变成可用窗口。

![在这里插入图片描述](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202206152359763.png)

#### 接收窗口

> 接收窗口: 由一个`RCV_NEXT`和接收窗口`RCV.WND`来维护。

> **缓冲区**分为三部分：
>
>   1. 应用层已经读取的数据: 已经接收到的数据，并且已经发送了ack包，并且已经被应用层读取。
>
>   2. 接收窗口中的数据: 接收窗口中存储的是当前等待接收的数据。
>
> 接收窗口允许无序接收数据包，所以接收窗口中有一部分数据接收到了，一部分没接收到，将无序的数据包直接缓存到接收窗口中。
>
> 因为无序的接收数据包，接收窗口中是存在空隙的，因为先发送的数据包由于网络原因，反而可能会后到接收方。
>
> 当数据包缓存到接收窗口中，就会返回ack包，ack包中会携带SACK信息，也就是选择重选信息。
>
>   3. 还未收到的数据: 还不能接收数据的区域，也就是接收窗口之外的数据。

![在这里插入图片描述](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/202206160000388.png)

## UDP协议

- UDP 不对数据段排序，也不关心数据段到达目的地的顺序。相反， UDP 将数据段发送出去后就不再管它们了。它不检查数据段，也不支持表示安全到达的确认，而是完全放手。有鉴于此， UDP被称为不可靠的协议。这并不意味着UDP 效率低下，而只意味着它根本不会处理可靠性问题。
- UDP 不建立虚电路，也不在发送信息前与接收方联系。因此，它也被称为无连接的协议。
- 如果数据段未按顺序到达(这在IP网络中很常见)，它们将被按收到的顺序传递给OSI (DoD) 模型的下一层，这可能使数据极其混乱。另一方面， TCP给数据段排序，以便能够按正确的顺序重组它们，而UDP根本没有这样的功能。

### UDP数据段的报头

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220705152945841.png" alt="image-20220705152945841" style="zoom:67%;" />

> UDP数据段的报头为 8 Bytes, 开销相比 TCP的 20 Bytes明显降低:
>
> - **Source Port**: 送主机的应用程序的端口号。
> - **Destination Port**: 目标主机上被请求的应用程序的端口号。
> - **Length**: UDP报头和UDP数据的总长度;
> - **Checksum**: UDP 报头和UDP 数据的校验和。
> - **UDP Data Area**: 封装来自上层的数据
> - 与TCP 一样， UDP 也不信任低层的传输并运行自己的CRC。还记得吗，CRC 结果存储在FCS( Frame
>       Check Sequence ，帧校验序列)字段中，这就是你能够看到FCS信息的原因。

## 端口号

> - 数据链路层使用MAC硬件地址, 网络层IP协议使用逻辑IP地址来标识发送主机，但传输层和上层协议不这样做，它们使用端口号。
> - 传输层的TCP 和UDP 必须使用端口号与上层通信，因为端口号跟踪通过网络同时进行的不同会话。
> - 源端口号是源主机动态分配的，其值不小于1024. 1023及更小的端口号是在RFC3232中定义为 知名端口号.

> (在[网络技术](https://baike.baidu.com/item/网络技术/480927)中，端口包括逻辑端口号和物理端口两种类型。
>
> - ==物理端口==：是用于连接物理设备之间的接口，如[ADSL](https://baike.baidu.com/item/ADSL/96520) Modem、[集线器](https://baike.baidu.com/item/集线器/214614)、[交换机](https://baike.baidu.com/item/交换机/103532)、[路由器](https://baike.baidu.com/item/路由器/108294)上用于连接其他网络设备的接口，如[RJ-45端口](https://baike.baidu.com/item/RJ-45端口)、SC端口等等 [2] 。
>
> - ==逻辑端口号==：是指逻辑意义上用于区分服务的端口，比如用于浏览网页服务的80端口，用于FTP服务的21端口等。如[TCP/IP协议](https://baike.baidu.com/item/TCP%2FIP协议)中的服务端口，通过不同的逻辑端口来区分不同的服务。一个IP地址的端口通过*16bit*进行编号，范围是从0 到65535;
>
>   - `well-known ports`: **0 to 1023** (0 to 2^10^ − 1);
>
>           used by system processes that provide widely used types of network services. On [Unix-like](https://en.wikipedia.org/wiki/Unix-like) operating systems, a process must execute with [superuser](https://en.wikipedia.org/wiki/Superuser) privileges to be able to bind a [network socket](https://en.wikipedia.org/wiki/Network_socket) to an [IP address](https://en.wikipedia.org/wiki/IP_address) using one of the well-known ports；
>
>   - `Registered ports`: **1024 to 49151**;
>
>           They are assigned by [IANA](https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority) for specific service upon application by a requesting entity.[[2\]](https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers#cite_note-IANA-2) On most systems, registered ports can be used without superuser privileges.
>
>   - `Dynamic, private or ephemeral ports`: **49152 to 65535**;
>
>           used for private or customized services, for temporary purposes, and for automatic allocation of [ephemeral ports](https://en.wikipedia.org/wiki/Ephemeral_port).

# 网络层协议

## IP Packet Header

IP(Internet Protocol，因特网协议)工作在Network Layer，该层的其他协议都只是为它提供支持。

![img](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/4322526-c033ebbd5e1368f3.jpg)

> - **Version 版本**：4 bits, identifies the version of IP used: *IPv4(0100)* 或者 *IPv6(0110)*，这个字段可以使得在不同版本间传递数据变得可行。
>
> - **IHL(Internet Header Length) 报头长度**：4 bits, 标明IPv4 Header的大小，**其单位是32bit即4 Bytes**，其最小值为5（`5 x 4 = 20 bytes`），从上图中看出，其规定头部长为 4 bit，所以最大值为 15， `15 x 4 = 60 byte`. 还可以算出Options字段长度最大为40个字节(即 `60 byte - 20 byte = 40 byte`)
>
> - **Type of Service 服务类型**：8 bits, 用来指示当数据报在一个特定网络中传输时对实际服务质量的要求是什么，
>   - *DSCP(Differentiated Services Code Point)*: 6 bits, used for **QoS(Quality of service) and to prioritize delay-sensitive data** (streaming voice, video, etc.):
>       - 服务类型字段从左到右由一个3位的优先顺序字段、三个标志位(D、T、R)组成。
>           - 优先顺序字段用于标志该数据报的优先级，
>
>           - D、T、R三个标志位分别代表是否对低延迟(Delay)、高吞吐量(Throughput)、高可靠性(Reliability)有要求，
>
>   - *ECN(Explicit Congestion Notification)*: 2 bits, 
>       - provides **end-to-end notification** of network congestion **WITHOUT DROPPING PACKETS**;
>
>       - Optional feature that requires both endpoints, as well as the underlying network infrastructure, to support it.
>
> - **Total Length 总长度**：16bits, Indicates the total length of the packet(包括*L3 IPv4 Header*和*L4 Segment*)，**单位是 Byte**。
>    - Minimum value: 20, which means IPv4 Header with no encapsulated data;
>
>    - maximum value: 2^16^ -1 = 65535, 如长的数据报对大部分主机和网络来说是不现实的。所有主机必须能够接收长达576个字节的数据报(不管他们是以整个数据报到达还是以分片到达)，源端主机在确认目的地址能够接收大数据报的情况下才发送大于576字节的数据报。
>
> ---
>
> - **Identification 标识**, 16 bits：
>
>    - Packets are fragmented if larger than the MTU (Maximum Transmission Unit), which is usually 1500 Bytes; 
>
>    - If a packet is fragmented due to being too large, this field is used to identify which packet the fragment belongs to. 
>
>    - All fragments of the same packet will have their own IPv4 
>       header with the same value in this field.
> - **Flags 标记**：3 bits, Used to *control/identify fragments*:
>    - *Bit_0: Reserved*, always set to 0;
>    
>    - *Bit_1: DF bit* (Don’t Fragment), used to indicate a packet that **should not** be fragmented;
>    
>    - *Bit_2: MF bit* (More Fragments), 
>        - set to 1 if there are more fragments in the packet, 
>        - set to O for the last fragment; Of course, Unfragmented packets will always have their MF bit set to 0.
>    
> - **Fragment Offset 分段偏移**：13 bits, 在分组太大，无法放入一个帧中时，提供了分段和重组功能。标记该分段在数据报的位置，**单位是8 Bytes**，第一个分段的偏移是 0;
>
>    - Used to indicate the position of the fragment within the original, unfragmented IP packet. 
>    - Allows fragmented packets to be reassembled even if the fragments arrive out of order.
>
> ---
>
> - **TTL (Time to live)存活时间**：8 bits, 用来指示分组存活时间的计数器，*单位是hop*; 
>
>    - A router will drop a packet with a TTL of 0 
>
>    - Used to prevent infinite loops;
>
>    - 该字段长度为 8bit ，说明存储的最大数值是 255，但是 Recommanded default TTL is 64;
>
>    - 在实际的应用过程中是以经过的节点计数的，每经过一个节点计数减 1 ，计数减到 0 时，分组会被当前的路由器丢弃。
>
> - **Protocol 协议**：8 bits, Indicates the protocol of the encapsulated L4-PDU，如*ICMP -> 1, IGMP -> 2, TCP -> 6, UDP -> 17, EIGRP -> 88, OSPF -> 89*等
>
>   <img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220705171123301.png" alt="image-20220705171123301" style="zoom:80%;" />
>
> - **Header Checksum 报头效验和**：16 bits, 
>
>    - 只对*IPv4 Header*进行效验，由于头部的一些字段始终在变化(例如：TTL字段)，该字段在每个节点都得进行计算和校验。
>
>       >   IP relies on the encapsulated protocol to detect errors in the encapsulated data. Both TCP and UDP have their own checksum fields to detect errors in the encapsulated data.
>       >
>
>    - A calculated checksum used to check for errors in the IPv4 header. 
>
>    - When a router receives a packet, it calculates the checksum of the header and compares it to the one in this field of the header.
>
> ---
>
> - ==Source IP Address 源地址==：发送方主机的IP地址, 32bit
> - ==Destination IP Address 目的地址==：接收方主机的IP地址, 32bit
>
> ---
>
> - **Options 可选项**：
>
>    - 一般正常的IP报文头部都是没有可选项的。
>
>    - 其长度从1~40个字节之间不固定，主要取决于设置的可选项数目，最终数据长度不够32位的倍数要填充 0 补齐，主要是为了让报头长度是32位的整数倍.
>
>    - 目前已定义的可选项有 5 个, 每个可选项都以 1 Byte表明它的类型:
>
>       <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202303182328150.png" alt="image-20230318232811975" style="zoom:38%;" />    
>
> 

## IP协议簇

### ICMP协议

> - ICMP (Internet Control Message Protocol ，因特网控制消息协议)运行在网络层， IP使用它来获得众多服务。
> - ICMP是一种管理协议，为IP提供消息收发服务，其消息是以IP数据报的形式传输的。
> - 作用: 面向连接的, 用于检测网络层的连通性, 可向主机提供有关网络故障的信息;;
> - 原理: 发送 `echo request`; 目标端收到后发送 `echo reply`;
> - 常用命令:
>   - ping: 检查互联网络中机器的物理连接性和逻辑连接性。
>   - traceroute: 使用ICMP超时来发现分组在互联网络中传输时经过的路径。(Windows 称之为tracert)
> - 与ICMP 相关的常见事件和消息:
>   - 目标不可达: 如果路由器不能再向前转发IP数据报，它将使用ICMP 向发送方发送一条消息，以通告这种情况。
>   - 缓冲区己满: 如果用于接收数据报的路由器内存缓冲区已满，路由器将使用ICMP 发送这种消息，直到拥塞解除。
>   - 超过跳数/时间: 对于每个IP 数据报，都指定了它可穿越的最大路由器数量(跳数)。如果数据报还未达到目的地就达到了该上限，最后一台收到该数据报的路由器将把它删除。然后，该路由器将使用ICMP 发送一条协告，让发送方知道其数据报已被删除。

### ARP 地址解析协议

> - ARP (Address Resolution Protocol ，地址解析协议)**根据指定的IP地址查找主机的MAC地址**:
>
>   1. 传输层传递给网络层数据时, 将目标IP地址告知了网络层;
>
>   2. 网络层需要向发送数据报时，它必须提前将目标端的硬件地址告知数据链路层协议，如以太网或无线。
>
>   3. 如果IP在ARP缓存中没有找到目标主机的硬件地址，ARP协议将发送广播，要求配置有指定IP地址的设备回复其MAC地址信息.
>
>        ![image-20220705172950722](https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220705172950722.png)
>
>

### RARP

如果IP主机为无盘计算机，一开始它不知道自己的IP地址，但知道自己的MAC地址。无盘机器可使用如图3-12 所示的RARP(Reverse Address Resolution Protocol，逆向地址解析协议)来获悉其IP地址，这是通过发送一个分组实现的，该分组包含元盘计算机的MAC地址和一个请求(请求提供分配给该MAC 地址的IP 地址). RARP服务器将对此作出响应，从而解决身份危机。RARP使用它知道的信息(即机器的MAC地址)来获悉机器的IP地址，从而完成身份标识。

<img src="https://cdn.jsdelivr.net/gh/Wolfxin/MyPicGo/img/image-20220705173607409.png" alt="image-20220705173607409" style="zoom:67%;" />

### Proxy ARP

在网络中，我们不能给主机配置多个默认网关。请想一想，如果默认网关(路由器)发生故障，结果将如何呢?主机不能自动将数据发送给另一台路由器，而你必须重新配置主机。但代理ARP可帮助主机前往远程子网，而无需配置路由选择甚至默认网关。

使用 代理ARP 的优点之一是，我们可在网络中的一台路由器上启用它，而不影响网络中其他路由器的路由选择表。然而，使用 代理ARP 也存在一个严重的缺陆:使用 代理ARP 将增加网段中的流量，而为处理所有的IP地址到MAC 地址的映射，主机的ARP表比通常情况下大。默认情况下，所有思科路由器都配置了代理ARP，如果你认为自己不会使用它，应将其禁用。

> 如果预算允许，你应使用思科的**HSRP** ( Hot Standby Router Protocol. 热备份路由器协议)

---



