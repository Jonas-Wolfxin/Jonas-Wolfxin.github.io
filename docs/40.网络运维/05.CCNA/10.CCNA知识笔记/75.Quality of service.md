---
title: Quality of service
date: 2023-04-29 22:30:25
permalink: /pages/bba118/
categories:
  - 网络运维
  - CCNA
  - CCNA知识笔记
tags:
  - 
---



# QoS

>   -   QoS is used to give priority to certain types of network traffic to minimize things like *delay and packet loss*. 
>   -   PoE(Power over Ethernet) allows devices to receive electric power over an Ethernet cable, instead of requiring a separate power cable.  
>   -   QoS is often used to prioritize Voice over IP traffic from IP phones to ensure the audio quality is acceptable. 



## Voice VLAN

### Voice VLAN

>  The voice VLAN feature enables **access ports** on the Switch to *carry IP voice traffic from an IP phone*. When a switch is connected to a Cisco IP phone, the IP phone sends voice traffic with **layer 3 IP precedence and layer 2 class of service (CoS) values**, which are *both set to 5 for voice traffic; all other traffic defaults to 0.*
>
>  Because the sound quality of an IP phone call can deteriorate(恶化) if the data is unevenly sent, the switch supports **quality of service (QoS)** based on IEEE 802.1p CoS. 
>
>  -   (802.1p provides a mechanism for implementing QoS at the Data Link level.) 
>  -   The 802.1p field is carried in the 802.1Q trunk header. If you look at the fields in an 802.1Q tag, you will see a field called the **priority** field; this is where the 802.1p information goes. 
>  -   *QoS uses classification and scheduling to send network traffic from the switch in an organized, predictable manner.*

### IP phones

> -   Traditional phones operate over the **public switched telephone network(PSTN)**. Sometimes this is called **POTS(plain old telephone service)**.
> -   IP phones use **VoIP(Voice over IP) technologies** to enable phone calls over an IP network(such as the Internet). Audio data is encapsulated in IP packets and sent over the network.
>
> -   IP phones are connected to a switch just like any other end host. 
>
> <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305010131950.png" alt="image-20230430013826617" style="zoom:30%;" />
>
> -   IP phones have an **internal 3-port switch**. It allows the PC and the IP phone to share a single switch port. Traffic from the PC passes through the IP phone to the switch like this.
>     -   1 port is the uplink, which connects to the external switch; 
>     -   1 port is the downlink which connects to the PC; 
>     -   And 1 port connects internally to the phone itself.
> -   Note that it is recommended to separate **voice traffic**(from the IP phone) and **data traffic**(from the PC) by *placing them in separate VLANs*.
> -   when configuring quality of service, we want to be able to specify the traffic from the IP phones and give it a higher priority than the regular data traffic. This can be accomplished using a **voice VLAN**.
> -   **Traffic from the PC will be untagged, but traffic from the IP phone will be tagged with a VLAN ID.**
>
> -   思科IP电话是一种可配置的设备，可对其进行配置，使其在发送的数据流中包含IEEE 802.1p 优先级。
> -   还可配置交换机，使其信任或覆盖IP电话指定的优先级

>   The switch can also process **tagged data traffic** (traffic in IEEE 802.1Q or IEEE 802.1p frame types) *from the device attached to the access port on the Cisco IP phone*. You can configure layer 2 access ports on the switch to send CDP packets that instruct the attached Cisco IP phone to configure **the IP phone PC access port** in one of these modes:
>
>   - In **trusted** mode, all traffic received through the access port on the Cisco IP phone passes through the IP phone **unchanged**.
>   - In **untrusted** mode, all traffic in IEEE 802.1Q or IEEE 802.1p frames received through the access port on the IP phone receive a configured layer 2 CoS value. The default layer 2 CoS value is 0. **Untrusted mode is the default.**

##### Configuration

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202304300148152.png" alt="image-20230430014858955" style="zoom:33%;" />

It’s actually quite simple to configure, you only need one additional command compared to configuring a regular access port.

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202304300146876.png" alt="image-20230430014626484" style="zoom:35%;" />

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305010131033.png" alt="image-20230430014749288" style="zoom:34%;" />

### PoE(Power over Ethernet)

>   Of course, being an electronic device, IP phones require electricity. That means we need to plug them into a wall socket or some other power outlet to get electricity. Or, perhaps there’s a better solution that doesn’t require an **extra power outlet(额外的电源插座)**, it is called **Power over Ethernet**, or **PoE**.
>
>   -   PoE allows **Power Sourcing Equipment (PSE)** to provide power to **Powered Devices (PD)** over an Ethernet cable.
>   -   Typically the **PSE is a switch**, and the PDs are *IP phones, IP cameras, wireless access points, etc*. To clarify, this is the same Ethernet cable that is used to transmit data. You don’t need a separate cable. One cable is used to provide power and to transmit data.
>   -   The PSE(switch) receives *AC power from the outlet*, coverts *it to DC power*, and supplies that DC power to the PDs, for example IP phones.
>   -   Too much electrical current can harm electrical devices. So, PoE has a process to determine if a connected device needs power, and how much power it needs if it does. 
>       -   when a device is connected to a PoE-enabled switch port, the PSE(switch) sends low power signals, monitors the response, and determines how much power the PD needs. 
>       -   These first signals are very weak to ensure that the PSE doesn’t give too much power to the connected device, causing it harm. 
>       -   If the connected device needs power, the PSE supplies power to allow the PD to boot. Then the PSE continues monitoring the PD and supplying power as needed, but again not too much power. 
>
>   ##### Power Policing:
>
>   There is a feature called **power policing** which prevents a PD from taking too much power. A few commands for power policing:
>
>   -   `power inline police` configures power policing with the default settings: disable the port and send a Syslog message if a PD draws too much power. 
>       -   which is equivalent to `power inline police action err-disable`. Both of these commands are the default for power policing and have the same effect. 
>       -   The interface will be put in an ‘**error-disabled**’ state and then it can be re-enabled by issuing the `shutdown` command followed by `no shutdown`.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202304300207947.png" alt="image-20230430020700725" style="zoom:33%;" />
>
>   -   `power inline police action log` does not shut down the interface if the PD draws too much power. *It will restart the interface and send a Syslog message*. Because the interface restarts, the connected PD will lose power and then restart as well. Then it will re-negotiate its power needs.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202304300208867.png" alt="image-20230430020808645" style="zoom:34%;" />
>
>   ##### some standards of PoE
>
>   Actually, PoE originally wasn’t PoE, it was Cisco Inline Power, ILP. As has happened multiple times, for example with CDP and LLDP, Cisco invented the technology first for its devices, and then it was standardized after.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305010131979.png" alt="image-20230430021143999" style="zoom:33%;" />
>
>   -   In Cisco ILP, Ethernet and FastEthernet only used *4(1, 2, 3, and 6) of the 8 wires in an Ethernet cable to transmit data*, *use the other 4 wires(4, 5, 7, and 8) to provide power*.
>   -   Later, Cisco ILP was standardized as Power over Ethernet, so other device makers would be able to use the technology. **PoE** and **PoE+**, also called **Type 1 and Type 2**, provide more power than the original Cisco ILP. Note the standard numbers, **802.3af** and **802.3at**.
>   -   Then, Cisco released another original non-standard protocol called **UPoE**, which stands for Universal Power over Ethernet. But then a similar standard was released, **802.3bt**. This includes **Type 3, offering up to 60 watts**, and **Type 4, offering up to 100 watts**. 

## QoS

>   -   The voice data from IP phones is often what we want to apply QoS to, to give higher priority to the voice data and ensure high audio quality.
>   -   In the old time, Voice traffic and data traffic used to use entirely separate networks. 
>       -   Voice traffic used the PSTN(Public switched telephone network);
>       -   data traffic used IP networks(such as an enterprise WAN or the Internet, etc.)
>   -   However, modern networks are typically converged networks in which IP phones, video traffic, regular data traffic such as web traffic, etc, all share the same IP network.
>   -   Converged(融合的) networks enable cost savings as well as more advanced features for voice and video traffic. 
>       -   For example *IP phones can integrate with collaboration software such as Cisco WebEx or Microsoft Teams*.
>       -   However, the different kinds of traffic now have to compete for bandwidth.
>   -   QoS(Quality of Service) is a set of tools used by network devices to apply different treatment to different packets. 
>       -   Certain kinds of traffic get higher priority treatment, 
>       -   and other kinds of traffic get lower priority treatment.

>   ##### four characteristics of network traffic
>
>   QoS is used to manage the following four characteristics of network traffic
>
>   -   **Bandwidth**: 
>       -   the overall capacity of the link and is measured in bits per second(Kbps, Mbps, Gbps, etc.)
>       -   QoS tools allow you to reserve a certain amount of a link’s bandwidth for specific kinds of traffic. 
>           -   For example, you could reserve 20% of a link’s bandwidth for voice traffic, 30% for specific kinds of important data traffic, and leave 50% for all other traffic.
>   -   **Delay**: 
>       -   The amount of time it takes for traffic to go from source to destination is called the **one-way delay**; 
>       -   The amount of time it takes traffic to go from source to destination and return = **two-way delay**
>   -   **Jitter**:
>       -   the variation in one-way delay between packets sent by the same application. 
>       -   So, if some packets arrive in 10 milliseconds, but some arrive in 100 milliseconds, that’s a lot of jitter, a big difference in how long it takes for each packet to reach its destination. 
>       -   Jitter will negatively affect the audio quality of phone calls, so IP phones have a **jitter buffer** to provide a **fixed delay** to audio packets. 
>       -   However, if the jitter is too high, it will overrun the buffer and the audio quality will suffer. 
>   -   **Loss**: 
>       -   This refers to the percentage of packets sent that do not reach their destination. 
>       -   This can be caused by faulty cables, or if the network is congested and a device’s packet queues get full, it will start discarding packets that can’t fit into the queue.

>   ##### Recommended standards for acceptable interactive audio quality
>
>   There are a few recommended standards for acceptable interactive audio quality(*Interactive audio means something like a phone call, the audio of a Zoom call, etc.*):
>
>   -   It is recommended that **the one-way delay be 150 milliseconds or less**. 
>   -   And the **jitter**(the variation in delay) should be **30 milliseconds or less**.
>   -   the **Loss** should **be 1% or less.**
>
>   If these standards are met, you can expect a decent experience, but if the standards are not met there could be a noticeable reduction in the quality of the phone call, the user experience will not be as good.

### QoS Queuing

>   -   If a network device receives messages faster than it can forward them out of the appropriate interface, the messages are placed in a queue. 
>       -   For example, this router is receiving packets on its G0/0 and G0/1 interfaces faster than it can forward them out of its G0/2 interface. So, as you can see the queue for its G0/2 interface starts filling up. **By default, queued messages will be forwarded in a First In First Out(FIFO) manner**. What that means is that messages will be sent in the order they are received. No special treatment is given to any kind of traffic.
>       -   Now, **what happens if the queue becomes full?** Traffic keeps arriving on the G0/0 and G0/1 interfaces faster than the router can forward the packets out of G0/2 and the queue fills up. When this happens, **new packets will be dropped**. This is called **tail drop**, when there is not enough room in the queue so packets are dropped.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305010157721.png" alt="image-20230501015705609" style="zoom:33%;" />
>
>   -   **Tail drop** is harmful, not just because packets are lost, but because it can lead to something called **TCP global synchronization**. 
>       -   To explain that, let me review the TCP sliding window.
>           -   Hosts using TCP use the ‘sliding window’ to increase and decrease the rate at which they send traffic as needed. So, the host will try to increase the rate at which it sends traffic. 
>           -   And when a packet is dropped, it will be re-transmitted. However, when a drop happens, the sender will reduce the rate it sends traffic. It will then gradually increase the rate again, and the process will repeat if another packet is dropped. 
>       -   When the queue fills up and **tail drop** occurs, all TCP hosts sending traffic will slow down the rate at which they send traffic.
>       -   They will all then increase the rate at which they send traffic, which rapidly leads to more congestion, dropped packets, and then the process repeats again.
>       -   So, it creates waves of the network being underutilized, when they all slow down their rate of transmission, and then congested, when they all increase their rate of transmission.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305010204619.png" alt="image-20230501020402504" style="zoom:33%;" />
>
>   -   A solution to prevent **tail drop** and therefore prevent **TCP global synchronization** is **Random Early Detection(RED)**.
>       -   **When the amount of traffic in the queue reaches a certain threshold, the device will start randomly dropping packets from select TCP flows.**
>       -   Why is this better than tail drop? Those TCP flows that dropped packets will reduce the rate at which traffic is sent, but you will avoid global TCP synchronization in which ALL TCP flows reduce and then increase the rate of transmission at the same time in waves. So, ideally it will keep the rate of traffic more even. 
>       -   In standard RED, all kinds of traffic are treated the same. There is a global threshold, and if the amount of traffic in the queue crosses the threshold, the device will start dropping traffic randomly as I said above.
>   -   An improved version called **Weighted Random Early Detection(WRED)** allows you to control which packets are dropped depending on the **traffic class**. The kinds of traffic that you configure as lower-priority will be dropped sooner.

### Classification/Marking

>   -   As you know, the purpose of QoS is to give certain kinds of network traffic priority over others during congestion.
>   -   **Classification organizes network traffic (packets) into traffic classes (categories)**.
>   -   Classification is fundamental to QoS. To give priority to certain types of traffic, you have to identify which types of traffic to give priority to.
>   -   There are many methods of classifying traffic. Here are some examples:
>       -   **ACL**: Traffic which is permitted by the ACL will be given certain treatment, other traffic will not. (*The ACL here isn’t being used to actually permit or deny traffic, it’s just being used to identify certain traffic.*)
>       -   **NBAR**(Network Based Application Recognition) performs a deep packet Inspection, looking beyond the Layer 3 and Layer 4 information **up to Layer 7** to identify the specific kind of traffic.
>       -   In the Layer 2 and Layer 3 headers there are specific fields used for the purpose of classifying traffic.
>           -   The **PCP (Priority Code Point) field of the 802.1Q tag** (in the Ethernet header) can be used to identify high/low priority traffic. *Keep in mind that this field can only be used when there is a dot1q tag, only when a VLAN tag is added to the Ethernet header.* 
>           -   The **DSCP**(Differentiated Services Code Point) field of the IP header can also be used to identify high or lower priority traffic.

#### PCP of the 802.1Q tag

>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305011254793.png" alt="image-20230501125417558" style="zoom:33%;" />
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305011243200.png" alt="image-20230501124322078" style="zoom:33%;" />
>
>   -   The PCP field is in the dot1q tag.
>   -   **PCP** is also known as **CoS** (Class of Service). Its use is defined by IEEE 802.1p. Don’t mix it up with the entire concept of QoS, CoS just refers to this part of the dot1q tag. 
>   -   there are **3 bits** which gives **8 possible values**:
>       -   0 Best effort delivery means there is no guarantee that data is delivered or that it meets any QoS standard. It’s regular traffic, not high-priority. This is the default, regular traffic will have a value of ‘0’ in the PCP field. 
>       -   IP phones **mark** their **call signaling traffic**(*used to establish calls*) as **PCP3**. 
>       -   However, when the call is established, the actual voice traffic itself(audio packets) is **marked** as **PCP5**. (To mark traffic is to set the value in the PCP or DSCP fields. Then network devices look at those markings and use them to classify the traffic as high-priority, low-priority, etc.)
>       -   So, when an IP phone marks its voice traffic as PCP5, it’s because it wants the routers and switches to classify those packets as high-priority.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305011250733.png" alt="image-20230501125027544" style="zoom:33%;" />

#### DSCP of Layer 3

>   let’s look at how marking and classification is done at Layer 3. 
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305011301053.png" alt="image-20230501130116789" style="zoom:33%;" />
>
>   -   In the IPv4 header there is a byte that is referred to as the **ToS** byte(Type of Service). 
>   -   In the old time, the ToS byte consists of 3-bits IPP and 5-bits unused field. The standard IPP markings are similar to PCP:
>       -   6 and 7 are reserved for what’s called ‘network control’(ie. OSPF messages sent between routers);
>       -   5 for voice;
>       -   4 for video;
>       -   3 for voice signaling traffic(setting up and tearing down phone calls.)
>       -   0 for best effort traffic, regular data traffic without any special requirements.
>   -   The modern use of the ToS byte consists of two fields:
>       -   DSCP(Differentiated Services Code Point): 
>           -   **RFC 2474 (1998)** defines the DSCP field, and other ‘DiffServ’(*Differentiated Services*) RFCs elaborate on its use.
>           -   With IPP updated to DSCP, new standard markings had to be decided upon. By having generally agreed upon standard markings for different kinds of traffic, QoS design & implementation is simplified, QOS works better between ISPs and enterprises, among other benefits.
>           -   6 bits of DSCP allows for a total of 64 values, which gives a lot of flexibility regarding how we can mark and classify traffic in the network.
>           -   you should be aware of the following standard markings:
>               -   **Default Forwarding (DF)** — best effort traffic;
>               -   **Expedited Forwarding(EF)** - used for traffic that requires low loss, latency, and jitter(usually voice traffic).
>               -   **Assured Forwarding (AF)** - This isn’t one marking, but a set of 12 standard values.
>               -   **Class Selector (CS)** — A set of 8 standard values, provides backward compatibility with IPP 
>       -   ECN(Explicit Congestion Notification): 2 bits
>   -   IPv6 also has a byte called the **traffic class** byte used for QoS.

---

>   We won’t cover **QoS configuration** because it’s not a CCNA exam topic, but let me show you this. 
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305011657438.png" alt="image-20230501165711125" style="zoom:33%;" />
>
>   -   I configured a ‘class-map’ called TEST. When configuring QoS, class maps are used to identify which traffic you want to match.
>   -   I configured a MATCH statement, specifying that I want to match traffic based on the DSCP value in the IP header. 
>       -   At the top is the choice to simply configure the DSCP value in decimal, from 0 to 63. 
>       -   Then below that are the 12 AF values. Notice on the right it shows the binary, for example AF11 has a binary value of `001010`. 
>       -   Under that there are the CS values. Again, the binary values are displayed on the right. 
>       -   I said there are 8 CS values, but only 7 are shown here. That’s because the other one, CS0, is the same as DF(default forwarding, `0x000000`);
>       -   Finally at the bottom is EF(expedited forwarding).

##### DF(Default Forwarding)

>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021538574.png" alt="image-20230502153857467" style="zoom:30%;" />
>
>   -   DF is used for best-effort traffic. 
>   -   The recommended DSCP marking is **0**.
>   -   For example, standard network traffic like sending an email or downloading a file will probably have `0x000000` in the DSCP field of the IP header, indicating that it doesn’t require any special treatment.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021600928.png" alt="image-20230502160049614" style="zoom:33%;" />

##### EF(Expedited Forwarding)

>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021542415.png" alt="image-20230502154201304" style="zoom:30%;" />
>
>   -   EF is used for traffic that requires low loss/latency/jitter.
>   -   Typically, voice traffic is marked as EF. 
>   -   The DSCP marking for EF is **46**. So, this is how it looks in binary, `101110`.

##### AF(Assured Forwarding)

>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021545651.png" alt="image-20230502154540540" style="zoom:28%;" />
>
>   -   AF (Assured Forwarding) defines four traffic classes. All packets in a class have the same priority. 
>   -   Within each class, there are three levels of drop precedence(丢弃优先级).
>       -   Higher drop precedence = more likely to drop the packet during congestion;
>   -   Now, when we write an AF value, it’s written as **AFXY**, with *X being the decimal number of the class* and *Y being the decimal number of the drop precedence*. For example, a binary DSCP value of `001010` in the AF system is written as **AF11** or **DHCP10**.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021554830.png" alt="image-20230502155436677" style="zoom:28%;" />
>
>   -   Here’s a summary of all of the AF values, **4 classes** with **3 drop precedence values** each. 
>       -   AF11 is the lowest value, and the AF43 is the highest value;
>       -   Within these AF values traffic marked as **AF41** gets the best treatment. It’s in the highest priority class, but has the lowest drop precedence. 
>       -   Traffic marked as AF13 gets the worst treatment, being in the lowest priority class with the highest drop precedence. 
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021555022.png" alt="image-20230502155526844" style="zoom:26%;" />
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021600456.png" alt="image-20230502160009153" style="zoom:33%;" />

##### CS(Class Selector)

>   -   CS (Class Selector) defines eight DSCP values for backward compatibility with IPP.
>   -   The three bits that were added for DSCP are set to 0, and the original IPP bits are used to make 8 values.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021604953.png" alt="image-20230502160414774" style="zoom:33%;" />
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021601229.png" alt="image-20230502160124931" style="zoom: 33%;" />

##### How are we supposed to take those values and actually use them?

>   -   RFC 4954 was developed with the help of Cisco to bring all of these values together and standardize their use.
>   -   The RFC offers many specific recommendations, but here are a few key ones:
>       -   Voice traffic: **EF** 
>       -   Interactive video: **AF4x** 
>       -   Streaming video: **AF3x** 
>       -   High priority data: **AF2x** 
>       -   Best effort: **DF** 

### Trust Boundaries

>   -   The trust boundary of a network defines where devices trust/don’t trust the *QoS markings of received messages*.
>       -   If the markings are trusted, that means the device will forward the message without changing the markings. 
>       -   But if the markings aren’t trusted, the device will change the markings according to the configured policy.

>   So, for example let’s say the trust boundary is here, at SW1. Phone1 sends a message marked as EF and CoS5 to SW1. 
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021616235.png" alt="image-20230502161655072" style="zoom:33%;" />
>
>   -   *Note that CoS is referring to the PCP field in the dot1q header.* CoS5 is equivalent to PCP5.
>   -   Anyway, SW1 doesn’t trust the markings from phones because it’s from outside of the trust boundary. So perhaps it changes the DSCP marking to DF and the CoS marking to 0, before forwarding it to R1, which forwards it on to R2, with just the DF marking because there is no dot1q header. Now, this configuration isn’t ideal.
>   -   Usually it’s best to trust the markings from an IP phone because we want its traffic to be high priority anyway. 
>       -   **If an IP phone is connected to the switchport, it is recommended to move the trust boundary to the IP phone.** 
>       -   This is done via configuration on the switch port connected to the IP phone, by the way, not directly on the phone itself.
>       -   So, if a tech-savvy user is able to mark their PC’s traffic with a high-priority marking to get faster service, the marking will be changed according to the configured policy. But traffic sent from the phone itself will be trusted by the switch. 
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305021622124.png" alt="image-20230502162225934" style="zoom:33%;" />

### Queuing/Congestion Management

>   -   For review:
>       -   When a network device receives traffic at a faster rate than it can forward the traffic out of the appropriate interface, packets are placed in that interface’s queue as they wait to be forwarded.
>       -   When the queue becomes full, packets that don’t fit in the queue are dropped (tail drop).
>       -   RED and WRED drop packets early to avoid tail drop.
>   -   An essential part of QoS is the use of multiple queues, not just a single queue.
>       -   This is where classification plays a role. The device can match traffic based on various factors (for example the DSCP marking in the IP header, etc.) and then place it in the appropriate queue.
>   -   However, the device is only able to forward one frame out of an interface at once, so a **scheduler** is used to decide which queue traffic is forwarded from next.
>       -   Prioritization allows the scheduler to give certain queues more priority than others.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305042259890.png" alt="image-20230504225951721" style="zoom:33%;" />
>
>   >   Here’s that same example as before, however this time let’s say the router’s interface forwarding the traffic has been configured with multiple queues. Here’s how it works. 
>   >
>   >   -   Ingress traffic is received by the router. Ingress just means incoming traffic, traffic entering the router. 
>   >   -   Then it performs routing, meaning it decides which interface to send it out of, as well as other things like NAT if necessary. 
>   >   -   Then it classifies the traffic and places it into the appropriate queue. 
>   >   -   In this case there are four queues and traffic is classified and placed in a queue depending on, for example, the DSCP marking. 
>   >   -   Then the scheduler decides how much traffic to send from each queue, in which order, and the router forwards the traffic, one packet at a time. 
>   >   -   This is an oversimplification, but its basically how it works. After the router decides which interface to forward the packet out of, it is classified, queued, scheduled, and then transmitted.

#### Scheduling Methods

>   -   A common scheduling method is **weighted round-robin**.
>       -   *round-robin* = packets are taken from each queue in order, cyclically
>       -   *weighted* = more data is taken from high priority queues each time the scheduler reaches that queue
>   -   **CBWFQ (Class-Based Weighted Fair Queuing)** is a popular method of scheduling, using a *weighted round- robin scheduler while guaranteeing each queue a certain percentage of the interface’s bandwidth during congestion*.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305042306009.png" alt="image-20230504230612847" style="zoom:33%;" />
>
>   -   **Round-robin scheduling is not ideal for voice/video traffic.** Even if the voice/video traffic receives a guaranteed minimum amount of bandwidth, round-robin can add delay and jitter because even the high priority queues have to wait their turn in the scheduler.
>   -   **LLQ (Low Latency Queuing)** designates one (or more) queues as Strict priority queues. 
>       + This means that if there is traffic in the queue, the scheduler will always take the next packet from that queue until it is empty.
>       + This is very effective for reducing the delay and jitter of voice/video traffic.
>       + However, it has the downside of potentially starving other queues if there is always traffic in the designated strict priority queue.
>           + **Policing** can control the amount of traffic allowed in the strict priority queue so that it can’t 
>               take all of the link’s bandwidth.
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305042308139.png" alt="image-20230504230843008" style="zoom:33%;" />



#### Shaping and Policing

>   -   Traffic **shaping** and **policing** are both used to control the rate of traffic. In the previous examples of queuing and scheduling we assumed that the interfaces are operating at full capacity, or beyond full capacity which is why packets need to be queued. However there are situations in which it is desirable to limit the rate of traffic to below the actual maximum capacity of the link. 
>   -   Why is it needed to limit the rate traffic is sent/received?
>
>   <img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305042321495.png" alt="image-20230504232136273" style="zoom:33%;" />
>
>   -   **Shaping** buffers traffic in a queue if the traffic rate goes over the configured rate.
>   -   **Policing** drops traffic if the traffic rate goes over the configured rate. However there is some flexibility. 
>       -   Burst traffic over the configured rate is allowed for a short period of time. This accommodates data applications which are ‘bursty’ in nature. Instead of a constant stream of data, they tend to send data in bursts.
>       -   Just like the policed data rate, the amount of burst traffic allowed is also configurable. 
>   -   In both cases, classification can be used to allow for different rates for different kinds of traffic.

## Configuration

### Configuring the Voice VLAN

> **By default, the voice VLAN feature is disabled**; it can be enabled by using the interface command `switchport voice vlan`. When the voice VLAN feature is enabled, all untagged traffic is sent according to the **default CoS priority** of the port. The CoS value is not trusted for IEEE 802.1p or IEEE 802.1Q tagged traffic.
>
> ==These are the voice VLAN configuration guidelines==:
>
> - You *should configure a voice VLAN on switch access ports*; voice VLAN isn’t supported on trunk ports, even though you can actually configure it!
> - The voice VLAN should be present and active on the switch for the IP phone to correctly communicate on it. Use the `show vlan` privileged EXEC command to see if the voice VLAN is present -- if it is, it’ll be listed in the display.
> - Before you enable the voice VLAN, it’s recommended that you **enable QoS on the switch** by 
>     - entering the `mls qos` global configuration command 
>     - and set the port trust state to trust by entering the `mls qos trust cos` interface configuration command.
> - You must make sure that CDP is enabled on the switch port connected to the Cisco IP phone to send the configuration. This is on by default, so unless you disabled it, you shouldn’t have a problem.
> - The PortFast feature is automatically enabled when the voice VLAN is configured, but when you disable the voice VLAN, the PortFast feature isn’t automatically disabled.
> - To return the port to its default setting, use the `no switchport voice vlan` interface configuration command.



### Configuring IP Phone Voice Traffic

> You can configure a port connected to the Cisco IP phone to send CDP packets to the phone in order to configure how the phone sends voice traffic.
>
> - The phone can carry voice traffic in IEEE 802.1Q frames for a specified voice VLAN with a layer 2 CoS value.
> - It can use IEEE 802.1p priority tagging to give voice traffic a higher priority as well as forward all voice traffic through the access VLAN instead of the native (access) VLAN.
> - The IP phone can also send untagged voice traffic or use its own configuration to send voice traffic in the access VLAN.
> - **In all configurations, the voice traffic carries a layer 3 IP precedence value—again, for voice the setting is usually 5.**

> This example shows you how to configure four things:
>
> 1. How to configure a port connected to an IP phone to use the **CoS value** for classifying incoming traffic
> 2. How to configure the port to **use IEEE 802.1p priority tagging** for voice traffic
> 3. How to configure it to use the Voice VLAN (10) to carry all voice traffic
> 4. And last, how to configure VLAN 3 to carry PC data
>
>   ```sh
> Switch#configure t
> Switch(config)#mls qos
> Switch(config)#interface f0/1
> Switch(config-if)#switchport priority extend ?
>     cos Override 802.1p priority of devices on appliance
>     trust Trust 802.1p priorities of devices on appliance
> Switch(config-if)#switchport priority extend trust
> Switch(config-if)#mls qos trust cos
> Switch(config-if)#switchport voice vlan dot1p
> Switch(config-if)#switchport mode access
> Switch(config-if)#switchport access vlan 3
> Switch(config-if)#switchport voice vlan 10
>   ```

---

### Lab of QoS

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305042335096.png" alt="image-20230504233516994" style="zoom:100%;" />

>   In this lab we’ll do some basic QoS configurations on R1. The design and configuration of QoS isn’t actually a CCNA exam topic. 
>
>   -   In this network we have PC1 connected to R1 via SW1. On the other side there is SRV1 connected to R2 via SW2. 
>       -   Although I’ve only shown 1 PC, let’s say there are many more connected to R1 and the network is getting congested.
>   -   So, we will configure QoS on R1 to ensure the more important traffic receives high-priority treatment.
>       -   the actual QoS design of a network depends entirely on the network, which traffic needs to be prioritized, how much bandwidth it needs, etc, varies greatly.
>       -   Giving HTTPS traffic a priority queue, for example, is probably not so common. Usually priority queues are used for voice traffic.
>   -   Anyway, after configuring the QoS rules we will apply them to traffic being forwarded out of R1’s G0/0/0 interface. 
>   -   Now, once the traffic reaches R2 that’s a different story. Even if R1 marks the packets as high priority, unless R2 is also configured to treat those packets as high priority, it will treat them all equally.
>   -   In the CCNA exam topics, it is stated that you must be able to explain the **PHB(per-hop behavior) of QoS**.
>       -   We configure QoS on R1 and it will prioritize certain types of traffic over the hop to R2, 
>       -   but then how R2 prioritizes traffic over the next hop depends on the configuration of R2.
>       -   You can’t just configure one router to prioritize voice traffic and then expect the rest of the network to also prioritize it. **You have to configure QoS all across the network, wherever it’s needed.**

To show you the basic QoS configurations, though, we’ll just configure R1.

##### Step 1. 

To identify traffic in a Cisco IOS QoS configuration, we use class maps.

```sh
R1>enable 
R1#conf
R1#configure t
R1#configure terminal 
Enter configuration commands, one per line.  End with CNTL/Z.
R1(config)#class-map ?
  WORD       class-map name
  match-all  Logical-AND all matching statements under this classmap(default)
  match-any  Logical-OR all matching statements under this classmap
  type       type of the class-map
R1(config)#class-map HTTPS_MAP
R1(config-cmap)#match protocol ?
  arp     IP ARP
  bgp     Border Gateway Protocol
  cdp     Cisco Discovery Protocol
  dhcp    Dynamic Host Configuration
  dns     Domain Name Server lookup
  eigrp   Enhanced Interior Gateway Routing Protocol
  ftp     File Transfer Protocol
  gre     Generic Routing Encapsulation
  h323    H323 Protocol
  http    Hypertext Transfer Protocol
  https   Secure Hypertext Transfer Protocol
  icmp    ICMP
  ip      IP
  ipsec   IP Security Protocol (ESP/AH)
  ipv6    IPV6
  ntp     Network Time Protocol
  ospf    Open Shortest Path First
  pop3    Post Office Protocol
  rip     Routing Information Protocol
  rtp     Real Time Protocol
  skinny  Skinny Call Control Protocol
  smtp    Simple Mail Transfer Protocol

R1(config-cmap)#match protocol https
R1(config-cmap)#exit 

R1(config)#class-map HTTP_MAP
R1(config-cmap)#match  protocol http
R1(config-cmap)#exit 

R1(config)#class-map ICMP_MAP
R1(config-cmap)#match protocol icmp 
R1(config-cmap)#exit

R1(config)#do show run | section class-map
class-map match-all HTTPS_MAP  
 match protocol https
class-map match-all HTTP_MAP
 match protocol http
class-map match-all ICMP_MAP
 match protocol icmp
 
```

##### Step 2. 

Next, we have to specify what kind of treatment we want to give to each kind of traffic. To do that we use policy maps.

```sh
R1(config)#policy-map G0/0/0_OUT
R1(config-pmap)#class ?
  WORD           class-map name
  class-default  System default class matching otherwise unclassified packets
  type           type of the class-map
R1(config-pmap)#class HTTPS_MAP
R1(config-pmap-c)#?
  bandwidth       Bandwidth
  exit            Exit from class action configuration mode
  no              Negate or set default values of a command
  priority        Strict Scheduling Priority for this Class
  queue-limit     Queue Max Threshold for Tail Drop
  random-detect   Enable Random Early Detection as drop policy
  service-policy  Configure Flow Next
  set             Set QoS values
  shape           Traffic Shaping
R1(config-pmap-c)#set
R1(config-pmap-c)#set ip 
R1(config-pmap-c)#set ip dscp ?
  <0-63>   Differentiated services codepoint value
  af11     Match packets with AF11 dscp (001010)
  af12     Match packets with AF12 dscp (001100)
  af13     Match packets with AF13 dscp (001110)
  af21     Match packets with AF21 dscp (010010)
  af22     Match packets with AF22 dscp (010100)
  af23     Match packets with AF23 dscp (010110)
  af31     Match packets with AF31 dscp (011010)
  af32     Match packets with AF32 dscp (011100)
  af33     Match packets with AF33 dscp (011110)
  af41     Match packets with AF41 dscp (100010)
  af42     Match packets with AF42 dscp (100100)
  af43     Match packets with AF43 dscp (100110)
  cs1      Match packets with CS1(precedence 1) dscp (001000)
  cs2      Match packets with CS2(precedence 2) dscp (010000)
  cs3      Match packets with CS3(precedence 3) dscp (011000)
  cs4      Match packets with CS4(precedence 4) dscp (100000)
  cs5      Match packets with CS5(precedence 5) dscp (101000)
  cs6      Match packets with CS6(precedence 6) dscp (110000)
  cs7      Match packets with CS7(precedence 7) dscp (111000)
  default  Match packets with default dscp (000000)
  ef       Match packets with EF dscp (101110)
  <cr>
R1(config-pmap-c)#set ip dscp af31
R1(config-pmap-c)#priority percent 10
R1(config-pmap-c)#exit

R1(config-pmap)#
R1(config-pmap)#class HTTP_MAP
R1(config-pmap-c)#set ip dscp af32
R1(config-pmap-c)#bandwidth ?
  <8-2000000>  Kilo Bits per second
  percent      % of total Bandwidth
  remaining    percent/ratio of the remaining bandwidth
R1(config-pmap-c)#bandwidth percent 10
R1(config-pmap-c)#exit

R1(config-pmap)#
R1(config-pmap)#class ICMP_MAP
R1(config-pmap-c)#set ip dscp cs2
R1(config-pmap-c)#bandwidth percent 5
R1(config-pmap-c)#end
R1#
%SYS-5-CONFIG_I: Configured from console by console

R1#show running-config | section policy-map
policy-map G0/0/0_OUT
 class HTTPS_MAP
  priority percent 10
  set ip dscp af31
 class HTTP_MAP
  bandwidth percent 10
  set ip dscp af32
 class ICMP_MAP
  bandwidth percent 5
  set ip dscp cs2
  
# All other traffic, not matching any of these, will not be marked and will be forwarded without any special QoS treatment.
```

##### Step 3.

Finally let’s apply this policy map using a service policy.

```sh
R1(config)#interface g0/0/0
R1(config-if)#service-policy ?
  input   Assign policy-map to the input of an interface
  output  Assign policy-map to the output of an interface
R1(config-if)#service-policy output ?
  WORD  policy-map name
R1(config-if)#service-policy output G0/0/0_OUT
R1(config-if)#exit 
```

##### Check

![image-20230505001627856](https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305050016953.png)

![image-20230505001548483](https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305050015578.png)

![image-20230505001701766](https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305050017869.png)

<img src="https://cdn.jsdelivr.net/gh/Jonas-Wolfxin/MyPicgo/img/202305050017838.png" alt="image-20230505001715709" style="zoom:33%;" />
